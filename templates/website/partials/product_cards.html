{% load core_extras %}
{% for product in products %}
<div class="col-lg-4 col-md-6 mb-4 product-item">
    <div class="card product-card h-100">
        {% if product.images.first %}
            <img src="{{ product.images.first.image.url }}" 
                 class="card-img-top" alt="{{ product.images.first.alt_text|default:product.name }}" 
                 style="height: 200px; object-fit: cover;">
        {% else %}
            <div class="card-img-top d-flex align-items-center justify-content-center bg-light"
                 style="height: 200px;">
                <i class="fas fa-image fa-3x text-muted"></i>
            </div>
        {% endif %}
        
        <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{ product.name }}</h5>
            <p class="card-text flex-grow-1">{{ product.short_description }}</p>
            
            <!-- Technical Specs -->
            {% if product.power_rating %}
                <small class="text-muted mb-2">
                    <i class="fas fa-bolt"></i> {{ product.power_rating }}W
                    {% if product.efficiency %} | {{ product.efficiency }}% Efficiency{% endif %}
                </small>
            {% endif %}
            
            <!-- Stock Status -->
            <div class="mb-2">
                <small class="badge bg-success">{{ product.stock_status_for_customers }}</small>
            </div>
            
            <div class="mt-auto">
                {% if product.customer_display_price %}
                    <div class="mb-2">
                        {% if discount_percentage %}
                            <!-- Holiday Discount Pricing -->
                            <span class="h6 text-muted text-decoration-line-through">KES {{ product.selling_price|floatformat:0 }}</span><br>
                            <span class="h5 text-success fw-bold mb-0">KES {{ product.selling_price|apply_discount:discount_percentage|floatformat:0 }}</span><br>
                            <span class="badge bg-success ms-1">{{ discount_percentage }}% OFF</span>
                        {% elif product.is_on_sale %}
                            <!-- Regular Product Sale -->
                            <span class="h6 text-muted text-decoration-line-through">KES {{ product.selling_price|floatformat:0 }}</span><br>
                            <span class="h5 text-primary mb-0">KES {{ product.sale_price|floatformat:0 }}</span>
                            <span class="badge bg-danger ms-1">{{ product.discount_percentage }}% OFF</span>
                        {% else %}
                            <!-- Regular Price -->
                            <span class="h5 text-primary mb-0">KES {{ product.selling_price|floatformat:0 }}</span>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="mb-2">
                        <span class="h6 text-info">Contact for Price</span>
                    </div>
                {% endif %}
                
                <div class="d-grid gap-2">
                    {% if not user.is_authenticated and product.customer_display_price and product.is_in_stock %}
                        <a href="{% url 'accounts:login' %}?next={{ request.get_full_path }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-sign-in-alt me-1"></i>Sign In to Order
                        </a>
                    {% endif %}
                    <a href="{{ product.get_absolute_url }}" class="btn btn-outline-primary btn-sm">View Details</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endfor %}
