{% extends 'website/base.html' %}

{% block title %}Solar Quotations Kenya - Free Consultation Today{% endblock %}

{% block meta_description %}Contact {{ company.name }} for solar consultation and installation services. Serving Nairobi, Kiambu, Machakos, and throughout Kenya. Call {{ company.phone }} or visit our Ruiru office.{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
<li class="breadcrumb-item active">Contact</li>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section hero-section-contact">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="hero-title">Get In Touch</h1>
                <p class="hero-subtitle">Ready to start your solar journey? Our experts are here to help you find the perfect solar solution for your needs.</p>
            </div>
        </div>
    </div>
</section>

<!-- Contact Information -->
<section class="section">
    <div class="container">
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card h-100 text-center">
                    <div class="card-body p-4">
                        <div class="feature-icon mb-3">
                            <i class="fas fa-phone"></i>
                        </div>
                        <h5>Call Us</h5>
                        <p class="text-muted mb-3">Speak directly with our solar experts</p>
                        <p><strong>Main Office:</strong><br>
                        <a href="tel:{{ company.phone }}" class="text-primary">
                            {{ company.phone }}
                        </a></p>
                        {% if company.sales_phone %}
                        <p><strong>Sales:</strong><br>
                        <a href="tel:{{ company.sales_phone }}" class="text-primary">{{ company.sales_phone }}</a></p>
                        {% endif %}
                        {% if company.support_phone %}
                        <p><strong>Support:</strong><br>
                        <a href="tel:{{ company.support_phone }}" class="text-primary">{{ company.support_phone }}</a></p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="card h-100 text-center">
                    <div class="card-body p-4">
                        <div class="feature-icon mb-3">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <h5>Email Us</h5>
                        <p class="text-muted mb-3">Send us your requirements and questions</p>
                        <p><strong>General Inquiries:</strong><br>
                        <a href="mailto:{{ company.email }}" class="text-primary">
                            {{ company.email }}
                        </a></p>
                        {% if company.sales_email %}
                        <p><strong>Sales:</strong><br>
                        <a href="mailto:{{ company.sales_email }}" class="text-primary">{{ company.sales_email }}</a></p>
                        {% endif %}
                        {% if company.support_email %}
                        <p><strong>Support:</strong><br>
                        <a href="mailto:{{ company.support_email }}" class="text-primary">{{ company.support_email }}</a></p>
                        {% endif %}
                        {% if whatsapp_url %}
                        <p><strong>WhatsApp:</strong><br>
                        <a href="{{ whatsapp_url }}" class="text-primary" target="_blank">{{ company.whatsapp_number }}</a></p>
                        {% endif %}
                        <small class="text-muted">We respond within 2 hours<br>
                        during business hours</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="card h-100 text-center">
                    <div class="card-body p-4">
                        <div class="feature-icon mb-3">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <h5>Visit Our Office</h5>
                        <p class="text-muted mb-3">See our products and meet our team</p>
                        <p><strong>{{ company.name }}</strong><br>
                        {{ company.address|linebreaks }}</p>

                        <!-- Embedded Google Maps -->
                        {% if company.latitude and company.longitude %}
                        <div class="mb-3">
                            <div id="company-map" style="height: 200px; width: 100%; border-radius: 0.375rem; border: 1px solid #dee2e6;"></div>
                        </div>
                        {% endif %}

                        {% if company.google_maps_url %}
                        <a href="{{ company.google_maps_url }}" target="_blank" class="btn btn-primary">Get Directions</a>
                        {% endif %}
                        <br><br>
                        <small class="text-muted">Business Hours:<br>
                        {{ company.business_hours_weekday }}<br>
                        {{ company.business_hours_saturday }}</small>
                        {% if company.showroom_hours_weekday or company.showroom_hours_saturday %}
                        <br><br>
                        <small class="text-muted">Showroom Hours:<br>
                        {% if company.showroom_hours_weekday %}{{ company.showroom_hours_weekday }}{% else %}Same as business hours{% endif %}<br>
                        {% if company.showroom_hours_saturday %}{{ company.showroom_hours_saturday }}{% else %}Same as business hours{% endif %}</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Contact Form -->
<section class="section bg-light-custom">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Send Us a Message</h2>
            <p class="section-subtitle">Fill out the form below and we'll get back to you within 24 hours</p>
        </div>
        
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-body p-5">
                        <form id="contactForm" method="post">
                            {% csrf_token %}
                            
                            {% if messages %}
                            <div class="messages mb-4">
                                {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %} me-2"></i>
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.first_name.label_tag }}
                                    {{ form.first_name }}
                                    {% if form.first_name.errors %}
                                        <div class="text-danger small">{{ form.first_name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.last_name.label_tag }}
                                    {{ form.last_name }}
                                    {% if form.last_name.errors %}
                                        <div class="text-danger small">{{ form.last_name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.email.label_tag }}
                                    {{ form.email }}
                                    {% if form.email.errors %}
                                        <div class="text-danger small">{{ form.email.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.phone.label_tag }}
                                    {{ form.phone }}
                                    {% if form.phone.errors %}
                                        <div class="text-danger small">{{ form.phone.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.location.label_tag }}
                                    {{ form.location }}
                                    {% if form.location.errors %}
                                        <div class="text-danger small">{{ form.location.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.property_type.label_tag }}
                                    {{ form.property_type }}
                                    {% if form.property_type.errors %}
                                        <div class="text-danger small">{{ form.property_type.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.monthly_bill.label_tag }}
                                    {{ form.monthly_bill }}
                                    {% if form.monthly_bill.errors %}
                                        <div class="text-danger small">{{ form.monthly_bill.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.inquiry_type.label_tag }}
                                    {{ form.inquiry_type }}
                                    {% if form.inquiry_type.errors %}
                                        <div class="text-danger small">{{ form.inquiry_type.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                {{ form.message.label_tag }}
                                {{ form.message }}
                                {% if form.message.errors %}
                                    <div class="text-danger small">{{ form.message.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3 form-check">
                                {{ form.subscribe_newsletter }}
                                <label class="form-check-label" for="{{ form.subscribe_newsletter.id_for_label }}">
                                    Subscribe to our newsletter for solar tips and updates
                                </label>
                                {% if form.subscribe_newsletter.errors %}
                                    <div class="text-danger small">{{ form.subscribe_newsletter.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3 form-check">
                                {{ form.agree_privacy }}
                                <label class="form-check-label" for="{{ form.agree_privacy.id_for_label }}">
                                    I agree to the <a href="{% url 'core:privacy_policy' %}" class="text-primary" target="_blank">Privacy Policy</a> and 
                                    <a href="{% url 'core:terms_of_service' %}" class="text-primary" target="_blank">Terms of Service</a> *
                                </label>
                                {% if form.agree_privacy.errors %}
                                    <div class="text-danger small">{{ form.agree_privacy.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-paper-plane me-2"></i>Send Message
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- FAQ Section -->
<section class="section">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Frequently Asked Questions</h2>
            <p class="section-subtitle">Quick answers to common questions about solar energy</p>
        </div>
        
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="accordion" id="faqAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                How much can I save with solar panels?
                            </button>
                        </h2>
                        <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Most of our customers save 50-90% on their electricity bills. The exact amount depends on your energy consumption, system size, and local electricity rates. Our quotation request form can give you a personalized estimate.
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                How long does installation take?
                            </button>
                        </h2>
                        <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Most residential installations are completed in 1-3 days. Larger commercial projects may take 1-2 weeks. The timeline depends on system size, roof complexity, and permit requirements.
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                What warranties do you offer?
                            </button>
                        </h2>
                        <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Solar panels come with 25-year performance warranties, inverters have 10-15 year warranties, and we provide 2-year workmanship warranty on all installations. Extended warranties are available.
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq4">
                                Do solar panels work during cloudy days?
                            </button>
                        </h2>
                        <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Yes! Solar panels still generate electricity on cloudy days, though at reduced capacity (typically 10-30% of peak output). Kenya's abundant sunshine ensures excellent year-round solar production.
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq5">
                                What maintenance is required?
                            </button>
                        </h2>
                        <div id="faq5" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Solar systems require minimal maintenance. Regular cleaning and annual inspections are recommended. We offer comprehensive maintenance packages to ensure optimal performance and protect your investment.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Call to Action -->
<section class="section bg-light-custom">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <h2>Ready to Get Started?</h2>
                <p class="lead mb-4">Get a free, no-obligation solar quote customized for your property and energy needs.</p>
                <div class="d-flex justify-content-center gap-3 flex-wrap">
                    <a href="{% url 'quotations:request_form' %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-file-text me-2"></i>Request a Quote
                    </a>
                    <a href="tel:{{ company.phone }}" class="btn btn-outline-primary btn-lg">
                        <i class="fas fa-phone me-2"></i>Call Now
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('contactForm').addEventListener('submit', function(e) {
        // Allow normal form submission - Django handles it now
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;

        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
        submitBtn.disabled = true;

        // Re-enable button after a delay (in case of errors)
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 5000);
    });

    // Company Location Map using Google Maps JavaScript API
    {% if company.latitude and company.longitude %}
    // Map configuration variables
    const mapConfig = {
        apiKey: '{{ GOOGLE_MAPS_API_KEY|default:"" }}',
        latitude: parseFloat('{{ company.latitude|stringformat:"f" }}'),
        longitude: parseFloat('{{ company.longitude|stringformat:"f" }}'),
        companyName: '{{ company.name|escapejs }}',
        companyAddress: '{{ company.address|linebreaks|escapejs }}'
    };

    // Initialize Google Maps
    function initCompanyMap() {
        const mapElement = document.getElementById('company-map');
        if (!mapElement) return;

        if (!mapConfig.apiKey || isNaN(mapConfig.latitude) || isNaN(mapConfig.longitude) || mapConfig.latitude === 0 || mapConfig.longitude === 0) {
            // Fallback: show static message
            mapElement.innerHTML = `
                <div class="text-center text-muted p-3" style="height: 200px; display: flex; align-items: center; justify-content: center;">
                    <div>
                        <i class="fas fa-map-marked-alt fa-2x mb-2"></i>
                        <p class="mb-1">Interactive map not available</p>
                        <small>Location coordinates not configured</small>
                    </div>
                </div>
            `;
            return;
        }

        // Create map location
        const location = { lat: mapConfig.latitude, lng: mapConfig.longitude };

        // Create map
        const map = new google.maps.Map(mapElement, {
            zoom: 15,
            center: location,
            mapTypeId: 'roadmap',
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: true,
            zoomControl: true
        });

        // Create marker
        const marker = new google.maps.Marker({
            position: location,
            map: map,
            title: mapConfig.companyName
        });

        // Create info window
        const infoWindow = new google.maps.InfoWindow({
            content: `
                <div style="max-width: 200px;">
                    <strong>${mapConfig.companyName}</strong><br>
                    <small>${mapConfig.companyAddress.replace(/\n/g, '<br>')}</small>
                </div>
            `
        });

        // Open info window on marker click
        marker.addListener('click', () => {
            infoWindow.open(map, marker);
        });

        // Add address info below map
        const infoDiv = document.createElement('div');
        infoDiv.className = 'text-center mt-2';
        infoDiv.innerHTML = `<small class="text-muted"><i class="fas fa-location-dot me-1"></i>${mapConfig.companyAddress.replace(/\n/g, ', ')}</small>`;
        mapElement.parentNode.insertBefore(infoDiv, mapElement.nextSibling);
    }

    // Handle API loading errors
    function handleMapError() {
        const mapElement = document.getElementById('company-map');
        if (mapElement) {
            mapElement.innerHTML = `
                <div class="text-center text-muted p-3" style="height: 200px; display: flex; align-items: center; justify-content: center;">
                    <div>
                        <i class="fas fa-map-marked-alt fa-2x mb-2"></i>
                        <p class="mb-1">Map temporarily unavailable</p>
                        <small>Google Maps API not accessible</small>
                    </div>
                </div>
            `;
        }
    }

    // Initialize map when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Load Google Maps API
        if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=' + mapConfig.apiKey + '&callback=initCompanyMap';
            script.async = true;
            script.defer = true;
            script.onerror = handleMapError;
            document.head.appendChild(script);

            // Set timeout for API loading
            setTimeout(() => {
                if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                    handleMapError();
                }
            }, 10000); // 10 second timeout
        } else {
            initCompanyMap();
        }
    });
    {% endif %}
</script>
{% endblock %}
