{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Quotation Requests Management - {{ block.super }}{% endblock %}

{% block page_title %}Quotation Requests{% endblock %}
{% block page_subtitle %}Manage customer quotation requests and convert to formal quotations{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item active">Quotation Requests</li>
{% endblock %}

{% block extra_css %}
<style>
    .requests-table {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
    }

    .status-badge {
        display: inline-block;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        font-weight: 600;
        border-radius: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .urgency-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        margin-left: 0.5rem;
    }

    .customer-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .customer-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #007bff;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.1rem;
    }

    .customer-details {
        flex: 1;
    }

    .filter-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .stats-card {
        background: white;
        border-radius: 15px;
        padding: 1rem;
        margin-bottom: 1rem;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stats-value {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
    }

    .stats-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Statistics Row -->
<div class="row mb-4">
    <div class="col-lg-2 col-md-4 mb-3">
        <div class="stats-card">
            <div class="stats-value">{{ total_requests|default:0 }}</div>
            <div class="stats-label">Total Requests</div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 mb-3">
        <div class="stats-card">
            <div class="stats-value" style="color: #28a745;">{{ new_requests|default:0 }}</div>
            <div class="stats-label">New Requests</div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 mb-3">
        <div class="stats-card">
            <div class="stats-value" style="color: #ffc107;">{{ pending_requests|default:0 }}</div>
            <div class="stats-label">In Progress</div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 mb-3">
        <div class="stats-card">
            <div class="stats-value" style="color: #20c997;">{{ completed_requests|default:0 }}</div>
            <div class="stats-label">Completed</div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 mb-3">
        <div class="stats-card">
            <div class="stats-value" style="color: #6f42c1;">{{ conversion_rate|default:0 }}%</div>
            <div class="stats-label">Conversion Rate</div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 mb-3">
        <div class="stats-card">
            <div class="stats-value" style="color: #fd7e14;">{{ avg_response_days|default:0 }}</div>
            <div class="stats-label">Avg Response (days)</div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="filter-section">
    <form method="get" class="row g-3">
        <div class="col-md-3">
            <label for="search" class="form-label">Search</label>
            <input type="text" class="form-control" id="search" name="search" value="{{ request.GET.search }}" placeholder="Customer name, email, phone">
        </div>
        <div class="col-md-2">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status">
                <option value="">All Statuses</option>
                {% if status_choices %}
                    {% for choice_value, choice_display in status_choices %}
                        <option value="{{ choice_value }}" {% if request.GET.status == choice_value %}selected{% endif %}>{{ choice_display }}</option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="urgency" class="form-label">Urgency</label>
            <select class="form-select" id="urgency" name="urgency">
                <option value="">All Levels</option>
                {% if urgency_choices %}
                    {% for choice_value, choice_display in urgency_choices %}
                        <option value="{{ choice_value }}" {% if request.GET.urgency == choice_value %}selected{% endif %}>{{ choice_display }}</option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="system_type" class="form-label">System Type</label>
            <select class="form-select" id="system_type" name="system_type">
                <option value="">All Types</option>
                {% if system_type_choices %}
                    {% for choice_value, choice_display in system_type_choices %}
                        <option value="{{ choice_value }}" {% if request.GET.system_type == choice_value %}selected{% endif %}>{{ choice_display }}</option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search me-2"></i>Filter
                </button>
                <a href="{% url 'quotations:requests_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-2"></i>Clear
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Requests Table -->
<div class="requests-table">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">Quotation Requests</h4>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary">
                <i class="fas fa-download me-2"></i>Export
            </button>
            <a href="{% url 'quotations:requests_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-undo me-2"></i>Refresh
            </a>
        </div>
    </div>

    {% if requests %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Customer</th>
                        <th>System Type</th>
                        <th>Location</th>
                        <th>Urgency</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for request in requests %}
                        <tr>
                            <td>
                                <div class="customer-info">
                                    <div class="customer-avatar">
                                        {{ request.customer_name|slice:":1" }}
                                    </div>
                                    <div class="customer-details">
                                        <div class="fw-bold">{{ request.customer_name }}</div>
                                        <div class="small text-muted">{{ request.email }}</div>
                                        {% if request.company_name %}
                                            <div class="small text-info">{{ request.company_name }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div>
                                    <div class="fw-bold">{{ request.get_system_type_display }}</div>
                                    {% if request.estimated_budget %}
                                        <div class="small text-muted">KES {{ request.estimated_budget|floatformat:0 }}</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="fw-bold">{{ request.location }}</div>
                                <div class="small text-muted">{{ request.get_property_type_display }}</div>
                            </td>
                            <td>
                                <span class="status-badge urgency-badge {% if request.urgency == 'critical' %}bg-danger{% elif request.urgency == 'high' %}bg-warning{% elif request.urgency == 'medium' %}bg-info{% else %}bg-secondary{% endif %}">
                                    {{ request.get_urgency_display }}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge {% if request.status == 'new' %}bg-info{% elif request.status == 'reviewed' %}bg-primary{% elif request.status == 'contacted' %}bg-warning{% elif request.status == 'quotation_created' %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ request.get_status_display }}
                                </span>
                                {% if request.assigned_to %}
                                    <div class="small text-muted mt-1">
                                        <i class="fas fa-user me-1"></i>{{ request.assigned_to.get_full_name }}
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                <div class="fw-bold">{{ request.created_at|date:"M j, Y" }}</div>
                                <div class="small text-muted">{{ request.created_at|timesince }}</div>
                                {% if request.created_quotation %}
                                    <div class="small text-success">
                                        Quotation: {{ request.created_quotation.quotation_number }}
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{% url 'quotations:request_detail' pk=request.pk %}" class="btn btn-outline-primary" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if request.status == "new" or request.status == "reviewed" or request.status == "contacted" %}
                                        <button class="btn btn-outline-success" title="Create Quotation" onclick="createQuotationFromRequest({{ request.pk }})">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    {% endif %}
                                    {% if request.status == 'quotation_created' and request.created_quotation %}
                                        <a href="{% url 'quotations:detail' quotation_number=request.created_quotation.quotation_number %}" class="btn btn-outline-info" title="View Quotation">
                                            <i class="fas fa-file-invoice"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
            <div class="d-flex justify-content-center mt-4">
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}&{{ key }}={{ value }}{% endfor %}">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </a>
                            </li>
                        {% endif %}

                        {% for num in paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active"><a class="page-link">{{ num }}</a></li>
                            {% elif num >= page_obj.number|add:-2 and num <= page_obj.number|add:2 %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}&{{ key }}={{ value }}{% endfor %}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}&{{ key }}={{ value }}{% endfor %}">
                                    Next <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        {% endif %}
    {% else %}
        <div class="text-center py-5">
            <div class="mb-3">
                <i class="fas fa-inbox fa-3x text-muted"></i>
            </div>
            <h5 class="text-muted">No quotation requests found</h5>
            <p class="text-muted">New customer requests will appear here automatically.</p>
            <a href="{% url 'accounts:dashboard' %}" class="btn btn-primary">
                <i class="fas fa-tachometer-alt me-2"></i>Visit Dashboard
            </a>
        </div>
    {% endif %}
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-tasks me-2"></i>Bulk Actions
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'quotations:bulk_actions' %}">
                    {% csrf_token %}
                    <input type="hidden" name="selected_requests" id="selectedRequestsInput">

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Select requests from the table above first, then apply bulk actions
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Action to Apply</label>
                        <select class="form-select" name="action" required>
                            <option value="assign_staff">Assign to Staff</option>
                            <option value="update_status">Update Status</option>
                            <option value="bulk_email">Send Bulk Email</option>
                        </select>
                    </div>

                    <div id="assignStaffSection" class="action-fields" style="display: none;">
                        <label for="staff_member" class="form-label">Assign to Staff Member</label>
                        <select class="form-select" name="staff_member" id="staff_member">
                            <option value="">Select staff member...</option>
                            <!-- Staff options would go here -->
                        </select>
                    </div>

                    <div id="updateStatusSection" class="action-fields" style="display: none;">
                        <label for="new_status" class="form-label">New Status</label>
                        <select class="form-select" name="new_status" id="new_status">
                            <option value="reviewed">Reviewed</option>
                            <option value="contacted">Contacted</option>
                            <option value="quotation_created">Quotation Created</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-play me-2"></i>Apply Action
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Table row selection for bulk actions
document.addEventListener('DOMContentLoaded', function() {
    let selectedRequests = new Set();

    // Handle action dropdown change
    document.querySelector('[name="action"]').addEventListener('change', function() {
        const action = this.value;

        // Hide all action fields
        document.querySelectorAll('.action-fields').forEach(field => {
            field.style.display = 'none';
        });

        // Show relevant fields
        if (action === 'assign_staff') {
            document.getElementById('assignStaffSection').style.display = 'block';
        } else if (action === 'update_status') {
            document.getElementById('updateStatusSection').style.display = 'block';
        }
    });

    // Update notifications every 30 seconds
    setInterval(checkNewRequests, 30000);

    function checkNewRequests() {
        fetch('{% url "quotations:check_new_requests" %}', {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.new_requests > 0) {
                // Update badge in sidebar/navbar if needed
                const badge = document.querySelector('.new-requests-badge');
                if (badge) {
                    badge.textContent = data.new_requests;
                    badge.style.display = 'inline-block';
                }

                // Show desktop notification
                if (Notification.permission === 'granted') {
                    new Notification('New Quotation Requests', {
                        body: `You have ${data.new_requests} new quotation request${data.new_requests > 1 ? 's' : ''}`,
                        icon: '/static/images/logo-small.png'
                    });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            new Notification('New Quotation Requests', {
                                body: `You have ${data.new_requests} new quotation request${data.new_requests > 1 ? 's' : ''}`,
                                icon: '/static/images/logo-small.png'
                            });
                        }
                    });
                }
            }
        })
        .catch(error => console.log('Error checking for new requests:', error));
    }

    // Function to create quotation from request
    window.createQuotationFromRequest = function(requestId) {
        if (confirm('Are you sure you want to create a quotation from this request?')) {
            // Redirect to request detail view for now since create_from_request URL is not available
            window.location.href = '{% url "quotations:request_detail" pk=0 %}'.replace('0', requestId);
        }
    };
});
</script>

<!-- Request Desktop Notifications Permission -->
<script>
if ('serviceWorker' in navigator && 'Notification' in window) {
    Notification.requestPermission().then(function(permission) {
        if (permission === 'granted') {
            console.log('Notification permission granted');
        }
    });
}
</script>
{% endblock %}
{% endblock %}
