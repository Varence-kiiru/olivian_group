{% extends 'website/base.html' %}
{% load core_extras %}

{% block title %}Checkout - {{ company.name|default:"Olivian Group" }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'products:list' %}">Products</a></li>
<li class="breadcrumb-item"><a href="{% url 'ecommerce:cart' %}">Cart</a></li>
<li class="breadcrumb-item active">Checkout</li>
{% endblock %}

{% block content %}
<!-- Checkout Section -->
<section class="section" style="padding-top: 120px;">
    <div class="container">
        <h1 class="mb-4">Checkout</h1>
        
        <div class="row">
            <div class="col-lg-8">
                <!-- Customer Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user me-2"></i>Customer Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="checkout-form">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="first_name" class="form-label">First Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="first_name" name="first_name" value="{{ user.first_name|default:'' }}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="last_name" class="form-label">Last Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="last_name" name="last_name" value="{{ user.last_name|default:'' }}" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="email" name="email" value="{{ user.email|default:'' }}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="form-label">Phone Number <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="phone" name="phone" value="{{ user.phone|default:'' }}" required>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Delivery Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-map-marker-alt me-2"></i>Delivery Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="address" class="form-label">Delivery Address <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="address" name="address" rows="3" required 
                                          placeholder="Enter your full delivery address">{{ user.address|default:'' }}</textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="city" class="form-label">City <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="city" name="city" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="county" class="form-label">County <span class="text-danger">*</span></label>
                                <select class="form-select" id="county" name="county" required>
                                    <option value="">Select County</option>
                                    <option value="Baringo">Baringo</option>
                                    <option value="Bomet">Bomet</option>
                                    <option value="Bungoma">Bungoma</option>
                                    <option value="Busia">Busia</option>
                                    <option value="Elgeyo-Marakwet">Elgeyo-Marakwet</option>
                                    <option value="Embu">Embu</option>
                                    <option value="Garissa">Garissa</option>
                                    <option value="Homa Bay">Homa Bay</option>
                                    <option value="Isiolo">Isiolo</option>
                                    <option value="Kajiado">Kajiado</option>
                                    <option value="Kakamega">Kakamega</option>
                                    <option value="Kericho">Kericho</option>
                                    <option value="Kiambu">Kiambu</option>
                                    <option value="Kilifi">Kilifi</option>
                                    <option value="Kirinyaga">Kirinyaga</option>
                                    <option value="Kisii">Kisii</option>
                                    <option value="Kisumu">Kisumu</option>
                                    <option value="Kitui">Kitui</option>
                                    <option value="Kwale">Kwale</option>
                                    <option value="Laikipia">Laikipia</option>
                                    <option value="Lamu">Lamu</option>
                                    <option value="Machakos">Machakos</option>
                                    <option value="Makueni">Makueni</option>
                                    <option value="Mandera">Mandera</option>
                                    <option value="Marsabit">Marsabit</option>
                                    <option value="Meru">Meru</option>
                                    <option value="Migori">Migori</option>
                                    <option value="Mombasa">Mombasa</option>
                                    <option value="Murang'a">Murang'a</option>
                                    <option value="Nairobi">Nairobi</option>
                                    <option value="Nakuru">Nakuru</option>
                                    <option value="Nandi">Nandi</option>
                                    <option value="Narok">Narok</option>
                                    <option value="Nyamira">Nyamira</option>
                                    <option value="Nyandarua">Nyandarua</option>
                                    <option value="Nyeri">Nyeri</option>
                                    <option value="Samburu">Samburu</option>
                                    <option value="Siaya">Siaya</option>
                                    <option value="Taita-Taveta">Taita-Taveta</option>
                                    <option value="Tana River">Tana River</option>
                                    <option value="Tharaka-Nithi">Tharaka-Nithi</option>
                                    <option value="Trans Nzoia">Trans Nzoia</option>
                                    <option value="Turkana">Turkana</option>
                                    <option value="Uasin Gishu">Uasin Gishu</option>
                                    <option value="Vihiga">Vihiga</option>
                                    <option value="Wajir">Wajir</option>
                                    <option value="West Pokot">West Pokot</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="installation_required" name="installation_required">
                            <label class="form-check-label" for="installation_required">
                                I require professional installation services (10% of order value, max KES 25,000)
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-credit-card me-2"></i>Payment Method
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" id="mpesa" value="mpesa" checked>
                                    <label class="form-check-label" for="mpesa">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-mobile-alt text-success me-2"></i>
                                            <strong>M-Pesa</strong>
                                        </div>
                                        <small class="text-muted">Pay with your mobile phone</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" id="bank_transfer" value="bank_transfer">
                                    <label class="form-check-label" for="bank_transfer">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-university text-primary me-2"></i>
                                            <strong>Bank Transfer</strong>
                                        </div>
                                        <small class="text-muted">Pay via bank transfer</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" id="cash_on_delivery" value="cash_on_delivery">
                                    <label class="form-check-label" for="cash_on_delivery">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-money-bill text-warning me-2"></i>
                                            <strong>Cash on Delivery</strong>
                                        </div>
                                        <small class="text-muted">Pay when you receive</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- M-Pesa Details -->
                        <div id="mpesa-details" class="mt-3">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="mpesa_phone" class="form-label">M-Pesa Phone Number <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="mpesa_phone" name="mpesa_phone" 
                                           value="{{ user.phone|default:'' }}" placeholder="254xxxxxxxxx">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="alert alert-info">
                                        <small>
                                            <i class="fas fa-info-circle me-1"></i>
                                            Transaction ID will be captured automatically after payment
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bank Transfer Details -->
                        <div id="bank-details" class="mt-3" style="display: none;">
                            <div class="alert alert-info mb-3">
                                <h6><i class="fas fa-info-circle me-2"></i>Bank Details</h6>
                                <p class="mb-1"><strong>Bank:</strong> KCB Bank Kenya Ltd</p>
                                <p class="mb-1"><strong>Account Name:</strong> The Olivian Group Limited</p>
                                <p class="mb-1"><strong>Account Number:</strong> 1234567890</p>
                                <p class="mb-0"><strong>Branch:</strong> Westlands Branch</p>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="bank_reference" class="form-label">Bank Reference Number</label>
                                    <input type="text" class="form-control" id="bank_reference" name="bank_reference" 
                                           placeholder="Enter bank transfer reference number">
                                    <small class="text-muted">Enter reference number after completing bank transfer</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Notes -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-sticky-note me-2"></i>Order Notes (Optional)
                        </h5>
                    </div>
                    <div class="card-body">
                        <textarea class="form-control" name="notes" rows="3" 
                                  placeholder="Any special instructions for your order..."></textarea>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Order Summary -->
                <div class="card sticky-top" style="top: 120px;">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <!-- Order Items -->
                        <div id="order-items" class="mb-3">
                            {% if cart.items.exists %}
                                {% for item in cart.items.all %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">{{ item.product.name }}</h6>
                                        <small class="text-muted">Qty: {{ item.quantity }}</small>
                                    </div>
                                    {% if discount_percentage %}
                                        <div class="text-end">
                                            <span class="fw-bold text-success">
                                                KES {{ item.unit_price|apply_discount:discount_percentage|multiply:item.quantity|floatformat:0 }}
                                            </span>
                                            <br>
                                            <small class="text-muted">
                                                <del>KES {{ item.total_price|floatformat:0 }}</del>
                                            </small>
                                        </div>
                                    {% else %}
                                        <span>KES {{ item.total_price|floatformat:0 }}</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-muted">
                                    <p>Your cart is empty</p>
                                    <a href="{% url 'products:list' %}" class="btn btn-primary btn-sm">Browse Products</a>
                                </div>
                            {% endif %}
                        </div>
                        
                        <hr>
                        
                        <!-- Pricing Breakdown -->
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="order-subtotal">
                                {% if discount_percentage %}
                                    KES {{ cart.subtotal_ex_vat|apply_discount:discount_percentage|floatformat:0 }}
                                {% else %}
                                    KES {{ cart.subtotal_ex_vat|floatformat:0 }}
                                {% endif %}
                            </span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Delivery:</span>
                            <span id="order-delivery">Free</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Installation:</span>
                            <span id="order-installation">KES 0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>VAT ({{ company.vat_rate|default:16 }}%):</span>
                            <span id="order-vat">
                                {% if discount_percentage %}
                                    {% with discounted_subtotal=cart.subtotal_ex_vat|apply_discount:discount_percentage %}
                                        KES {{ discounted_subtotal|multiply:0.16|floatformat:0 }}
                                    {% endwith %}
                                {% else %}
                                    KES {{ cart.vat_amount|floatformat:0 }}
                                {% endif %}
                            </span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Total:</strong>
                            <strong id="order-total">
                                {% if discount_percentage %}
                                    KES {{ cart.total_with_vat|apply_discount:discount_percentage|floatformat:0 }}
                                {% else %}
                                    KES {{ cart.total_with_vat|floatformat:0 }}
                                {% endif %}
                            </strong>
                        </div>
                        
                        <!-- Place Order Button -->
                        <div class="d-grid">
                            <button type="button" class="btn btn-primary btn-lg" id="place-order-btn">
                                <i class="fas fa-lock me-2"></i>Place Order
                            </button>
                        </div>
                        
                        <!-- Security Info -->
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="fas fa-shield-alt text-success me-1"></i>
                                Your information is secure and encrypted
                            </small>
                        </div>
                        
                        <!-- Terms -->
                        <div class="mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agree_terms" required>
                                <label class="form-check-label small" for="agree_terms">
                                    I agree to the <a href="{% url 'core:terms_of_service' %}" target="_blank">Terms & Conditions</a> and <a href="{% url 'core:privacy_policy' %}" target="_blank">Privacy Policy</a>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- M-Pesa Payment Modal -->
<div class="modal fade" id="mpesaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-mobile-alt text-success me-2"></i>M-Pesa Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="mpesa-processing">
                    <div class="spinner-border text-success mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Processing Payment...</h5>
                    <p class="text-muted">Please check your phone for the M-Pesa prompt</p>
                    <p><strong>Amount: KES <span id="mpesa-amount">0</span></strong></p>
                    <p><strong>Phone: <span id="mpesa-phone-display">0</span></strong></p>
                </div>
                
                <div id="mpesa-success" style="display: none;">
                    <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">Payment Successful!</h5>
                    <p class="text-muted">Order confirmation will be sent to your email</p>
                </div>
                
                <div id="mpesa-error" style="display: none;">
                    <i class="fas fa-times-circle text-danger" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">Payment Failed</h5>
                    <p class="text-muted">Please try again or contact support</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="retry-payment" style="display: none;">Try Again</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dynamic company settings
const CURRENCY = '{{ company.default_currency|default:"KES" }}';
const VAT_RATE = {{ company.vat_rate|default:16 }};
const INSTALLATION_FEE = {{ company.installation_fee|default:15000 }};

// Use server-side cart data with discounts applied if active
const CART_SUBTOTAL_VAT_INCLUSIVE = {{ discounted_cart_subtotal|default:cart.subtotal|default:0 }};
const CART_SUBTOTAL_EX_VAT = {{ discounted_cart_subtotal_ex_vat|default:cart.subtotal_ex_vat|default:0 }};
const CART_VAT_AMOUNT = {{ discounted_cart_vat|default:cart.vat_amount|default:0 }};

let cart = JSON.parse(localStorage.getItem('cart') || '[]');
let orderTotal = 0;

document.addEventListener('DOMContentLoaded', function() {
    loadOrderSummary();
    setupFormHandlers();
    
    // Load user data if logged in
    if (typeof window.user !== 'undefined' && window.user) {
        document.getElementById('first_name').value = window.user.first_name || '';
        document.getElementById('last_name').value = window.user.last_name || '';
        document.getElementById('email').value = window.user.email || '';
        document.getElementById('phone').value = window.user.phone || '';
    }
});

function loadOrderSummary() {
    // Order items are already rendered server-side, just calculate totals
    calculateTotals();
}

function calculateTotals() {
    // Use server-side cart data for accurate calculations
    const subtotalExVat = CART_SUBTOTAL_EX_VAT;
    const vatFromProducts = CART_VAT_AMOUNT;
    
    // Installation fee: 10% of subtotal (ex VAT), max 25,000
    const installationCost = document.getElementById('installation_required').checked ? 
        Math.min(subtotalExVat * 0.10, 25000) : 0;
    
    // Installation fee has VAT applied to it
    const installationVat = installationCost * (VAT_RATE / 100);
    const totalVat = vatFromProducts + installationVat;
    const total = CART_SUBTOTAL_VAT_INCLUSIVE + installationCost + installationVat;
    
    orderTotal = total;
    
    document.getElementById('order-subtotal').textContent = `${CURRENCY} ${Math.round(subtotalExVat).toLocaleString()}`;
    document.getElementById('order-installation').textContent = `${CURRENCY} ${Math.round(installationCost).toLocaleString()}`;
    document.getElementById('order-vat').textContent = `${CURRENCY} ${Math.round(totalVat).toLocaleString()}`;
    document.getElementById('order-total').textContent = `${CURRENCY} ${Math.round(total).toLocaleString()}`;
}

function setupFormHandlers() {
    // Payment method change handler
    document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('mpesa-details').style.display = 
                this.value === 'mpesa' ? 'block' : 'none';
            document.getElementById('bank-details').style.display = 
                this.value === 'bank_transfer' ? 'block' : 'none';
        });
    });
    
    // Installation checkbox handler
    document.getElementById('installation_required').addEventListener('change', calculateTotals);
    
    // Place order button handler
    const placeOrderBtn = document.getElementById('place-order-btn');
    if (placeOrderBtn) {
        placeOrderBtn.addEventListener('click', function(e) {
            e.preventDefault();
            handlePlaceOrder();
        });
        console.log('Place order button event listener attached');
    } else {
        console.error('Place order button not found');
    }
}

function handlePlaceOrder() {
    console.log('Place Order button clicked');
    
    try {
        if (!validateForm()) {
            console.log('Form validation failed');
            return;
        }
        
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
        if (!paymentMethod) {
            alert('Please select a payment method');
            return;
        }
        
        console.log('Payment method:', paymentMethod.value);
        
        if (paymentMethod.value === 'mpesa') {
            processMPesaPayment();
        } else {
            processOtherPayment(paymentMethod.value);
        }
    } catch (error) {
        console.error('Error in handlePlaceOrder:', error);
        alert('Error: ' + error.message);
    }
}

function validateForm() {
    const form = document.getElementById('checkout-form');
    const requiredFields = form.querySelectorAll('[required]');
    
    for (let field of requiredFields) {
        if (!field.value.trim()) {
            field.focus();
            alert('Please fill in all required fields');
            return false;
        }
    }
    
    if (!document.getElementById('agree_terms').checked) {
        alert('Please agree to the Terms & Conditions');
        return false;
    }
    
    return true;
}

function processMPesaPayment() {
    const phone = document.getElementById('mpesa_phone').value;
    
    if (!phone) {
        alert('Please enter your M-Pesa phone number');
        return;
    }
    
    // Disable the place order button
    const placeOrderBtn = document.getElementById('place-order-btn');
    placeOrderBtn.disabled = true;
    placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    
    // First create the order
    let orderData;
    try {
        orderData = collectOrderData();
        orderData.payment_method = 'mpesa';
    } catch (error) {
        placeOrderBtn.disabled = false;
        placeOrderBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Place Order';
        alert('Form error: ' + error.message);
        return;
    }
    
    fetch('/shop/orders/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Process M-Pesa STK Push
            fetch(`/shop/orders/${data.order_number}/pay/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    payment_method: 'mpesa',
                    phone_number: phone
                })
            })
            .then(response => response.json())
            .then(paymentData => {
                if (paymentData.success) {
                    // STK Push initiated successfully
                    showMPesaModal(data.order_number, paymentData.transaction_id, phone, orderTotal);
                } else {
                    // STK Push failed
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Place Order';
                    alert('M-Pesa payment failed: ' + paymentData.message);
                }
            })
            .catch(error => {
                console.error('Payment Error:', error);
                placeOrderBtn.disabled = false;
                placeOrderBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Place Order';
                alert('Error processing M-Pesa payment');
            });
        } else {
            placeOrderBtn.disabled = false;
            placeOrderBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Place Order';
            alert('Order creation failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Order Error:', error);
        placeOrderBtn.disabled = false;
        placeOrderBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Place Order';
        alert('An error occurred. Please try again.');
    });
}

function showMPesaModal(orderNumber, transactionId, phone, amount) {
    // Create and show M-Pesa modal
    const modalHTML = `
        <div class="modal fade" id="mpesaModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-mobile-alt me-2"></i>M-Pesa Payment
                        </h5>
                    </div>
                    <div class="modal-body text-center">
                        <div id="mpesa-processing">
                            <div class="spinner-border text-success mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h6>Payment Request Sent</h6>
                            <p>Check your phone (${phone}) for the M-Pesa payment request.</p>
                            <p><strong>Amount: KES ${amount.toLocaleString()}</strong></p>
                            <small class="text-muted">Waiting for payment confirmation...</small>
                        </div>
                        <div id="mpesa-success" style="display: none;">
                            <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                            <h6 class="mt-3">Payment Successful!</h6>
                            <p>Your payment has been confirmed.</p>
                        </div>
                        <div id="mpesa-error" style="display: none;">
                            <i class="fas fa-times-circle text-danger" style="font-size: 3rem;"></i>
                            <h6 class="mt-3">Payment Failed</h6>
                            <p>The payment was not completed. Please try again.</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="checkPaymentStatus(${transactionId}, '${orderNumber}')">
                            Check Status
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('mpesaModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('mpesaModal'));
    modal.show();
    
    // Start checking payment status
    checkPaymentStatus(transactionId, orderNumber);
}

function checkPaymentStatus(transactionId, orderNumber) {
    fetch(`/shop/mpesa/status/${transactionId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.is_successful) {
                    // Payment completed
                    document.getElementById('mpesa-processing').style.display = 'none';
                    document.getElementById('mpesa-success').style.display = 'block';
                    
                    // Redirect after 3 seconds
                    setTimeout(() => {
                        window.location.href = `/shop/orders/${orderNumber}/`;
                    }, 3000);
                } else if (data.status === 'failed') {
                    // Payment failed
                    document.getElementById('mpesa-processing').style.display = 'none';
                    document.getElementById('mpesa-error').style.display = 'block';
                    
                    // Re-enable place order button
                    const placeOrderBtn = document.getElementById('place-order-btn');
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Place Order';
                } else {
                    // Still pending, check again in 5 seconds
                    setTimeout(() => {
                        checkPaymentStatus(transactionId, orderNumber);
                    }, 5000);
                }
            } else {
                console.error('Error checking payment status:', data.message);
            }
        })
        .catch(error => {
            console.error('Error checking payment status:', error);
        });
}

function processOtherPayment(method) {
    // Create order with other payment methods
    let orderData;
    try {
        orderData = collectOrderData();
        orderData.payment_method = method;
        orderData.payment_status = method === 'cash_on_delivery' ? 'pending' : 'awaiting_payment';
    } catch (error) {
        alert('Form error: ' + error.message);
        return;
    }
    
    // Submit order
    fetch('/shop/orders/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = `/shop/orders/${data.order_number}/`;
        } else {
            alert('Order failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}

function collectOrderData() {
    const paymentMethodElement = document.querySelector('input[name="payment_method"]:checked');
    if (!paymentMethodElement) {
        throw new Error('Please select a payment method');
    }
    const paymentMethod = paymentMethodElement.value;
    
    // Helper function to safely get element value
    const getElementValue = (id, defaultValue = '') => {
        const element = document.getElementById(id);
        return element ? element.value : defaultValue;
    };
    
    const getElementChecked = (id, defaultValue = false) => {
        const element = document.getElementById(id);
        return element ? element.checked : defaultValue;
    };
    
    const orderData = {
        customer: {
            first_name: getElementValue('first_name'),
            last_name: getElementValue('last_name'),
            email: getElementValue('email'),
            phone: getElementValue('phone')
        },
        delivery: {
            address: getElementValue('address'),
            city: getElementValue('city'),
            county: getElementValue('county')
        },
        items: cart,
        installation_required: getElementChecked('installation_required'),
        notes: document.querySelector('[name="notes"]')?.value || '',
        total: orderTotal
    };
    
    // Add payment-specific data
    if (paymentMethod === 'mpesa') {
        orderData.mpesa_phone = getElementValue('mpesa_phone');
        // Transaction ID will be captured automatically via callback
    } else if (paymentMethod === 'bank_transfer') {
        orderData.bank_reference = getElementValue('bank_reference');
    }
    
    return orderData;
}
</script>
{% endblock %}
