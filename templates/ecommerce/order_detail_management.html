{% extends 'dashboard/base.html' %}
{% load static %}
{% load core_extras %}

{% block title %}Order {{ order.order_number }} - Management - {{ company.name|default:"Olivian Group" }}{% endblock %}

{% block page_title %}Order {{ order.order_number }}{% endblock %}

{% block page_subtitle %}Order Management Details{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Quick Actions Bar -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div class="d-flex align-items-center gap-3">
                        <h5 class="mb-0">
                            <i class="fas fa-shopping-cart me-2"></i>
                            Order #{{ order.order_number }}
                        </h5>
                        <span class="badge {% if order.status == 'delivered' or order.status == 'completed' %}bg-success{% elif order.status == 'shipped' or order.status == 'out_for_delivery' %}bg-info{% elif order.status == 'processing' or order.status == 'packed_ready' %}bg-warning{% elif order.status == 'cancelled' %}bg-danger{% elif order.status == 'returned' %}bg-secondary{% else %}bg-primary{% endif %}">
                            {{ order.get_status_display }}
                        </span>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-outline-success btn-sm" onclick="showStatusUpdateModal('{{ order.order_number }}', '{{ order.status }}', '{{ order.get_status_display }}')">
                            <i class="fas fa-edit me-1"></i>Update Status
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showStatusHistory('{{ order.order_number }}')">
                            <i class="fas fa-history me-1"></i>Status History
                        </button>
                        <a href="/shop/orders/{{ order.order_number }}/receipt/" class="btn btn-outline-primary btn-sm" target="_blank">
                            <i class="fas fa-download me-1"></i>Receipt
                        </a>
                        <a href="{% url 'ecommerce:orders' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>Back to Orders
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Order Timeline and Status -->
    <div class="col-lg-8">
        <!-- Status Timeline -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-route me-2"></i>Order Status Timeline
                </h5>
            </div>
            <div class="card-body">
                <div class="order-timeline">
                    <!-- Order Received -->
                    <div class="timeline-item {% if order.status != 'received' %}completed{% else %}active{% endif %}">
                        <div class="timeline-marker">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="timeline-content">
                            <h6>Order Received</h6>
                            <p class="text-muted mb-0">{{ order.created_at|date:"M j, Y g:i A" }}</p>
                        </div>
                    </div>

                    <!-- Payment -->
                    <div class="timeline-item {% if order.status == 'paid' or order.status == 'processing' or order.status == 'packed_ready' or order.status == 'shipped' or order.status == 'out_for_delivery' or order.status == 'delivered' or order.status == 'completed' %}completed{% elif order.status == 'pending_payment' %}active{% endif %}">
                        <div class="timeline-marker">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="timeline-content">
                            <h6>Payment {{ order.get_payment_status_display|default:"Processing" }}</h6>
                            <p class="text-muted mb-0">
                                {% if order.payment_status == 'paid' %}
                                    Payment confirmed
                                {% elif order.status == 'pay_on_delivery' %}
                                    Pay on delivery
                                {% else %}
                                    Waiting for payment confirmation
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Processing -->
                    <div class="timeline-item {% if order.status == 'processing' or order.status == 'packed_ready' or order.status == 'shipped' or order.status == 'out_for_delivery' or order.status == 'delivered' or order.status == 'completed' %}completed{% elif order.status == 'paid' %}active{% endif %}">
                        <div class="timeline-marker">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="timeline-content">
                            <h6>Processing</h6>
                            <p class="text-muted mb-0">
                                {% if order.status == 'processing' or order.status == 'packed_ready' or order.status == 'shipped' or order.status == 'out_for_delivery' or order.status == 'delivered' or order.status == 'completed' %}
                                    Order is being prepared
                                {% else %}
                                    Estimated: 1-2 business days
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Shipping -->
                    <div class="timeline-item {% if order.status == 'shipped' or order.status == 'out_for_delivery' or order.status == 'delivered' or order.status == 'completed' %}completed{% elif order.status == 'packed_ready' %}active{% endif %}">
                        <div class="timeline-marker">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="timeline-content">
                            <h6>Shipping</h6>
                            <p class="text-muted mb-0">
                                {% if order.status == 'shipped' or order.status == 'out_for_delivery' or order.status == 'delivered' or order.status == 'completed' %}
                                    Order shipped
                                    {% if order.tracking_number %}<br>Tracking: {{ order.tracking_number }}{% endif %}
                                {% else %}
                                    Estimated: 2-3 business days
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Delivery -->
                    <div class="timeline-item {% if order.status == 'delivered' or order.status == 'completed' %}completed{% elif order.status == 'out_for_delivery' %}active{% endif %}">
                        <div class="timeline-marker">
                            <i class="fas fa-home"></i>
                        </div>
                        <div class="timeline-content">
                            <h6>Delivery</h6>
                            <p class="text-muted mb-0">
                                {% if order.status == 'delivered' or order.status == 'completed' %}
                                    Order delivered
                                {% else %}
                                    Estimated: 3-5 business days
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Items -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-box me-2"></i>Order Items
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Unit Price</th>
                                <th>Qty</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order.items.all %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if item.product.get_primary_image %}
                                                <img src="{{ item.product.get_primary_image.image.url }}"
                                                     class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;">
                                            {% endif %}
                                            <div>
                                                <h6 class="mb-1">{{ item.product_name }}</h6>
                                                <small class="text-muted">SKU: {{ item.product_sku }}</small>
                                                {% if item.specifications %}
                                                    <br><small class="text-muted">{{ item.specifications|truncatechars:50 }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ company.default_currency|default:"KES" }} {{ item.unit_price|floatformat:0 }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td><strong>{{ company.default_currency|default:"KES" }} {{ item.total_price|floatformat:0 }}</strong></td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center py-4">
                                        <i class="fas fa-box-open fa-2x text-muted mb-2"></i>
                                        <p class="text-muted">No items found in this order</p>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Installation Service Note -->
                {% if order.installation_required|default:True %}
                <div class="alert alert-info">
                    <h6><i class="fas fa-tools me-2"></i>Installation Service Required</h6>
                    <p class="mb-0">Professional installation has been included in this order.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Shipping & Delivery -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-truck me-2"></i>Shipping & Delivery
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Delivery Address</h6>
                        <address class="text-muted">
                            {{ order.shipping_address|linebreaks }}
                        </address>
                    </div>
                    <div class="col-md-6">
                        <h6>Shipping Details</h6>
                        <div class="small">
                            <p><strong>Method:</strong> {{ order.get_shipping_company_display|default:"Standard Delivery" }}</p>
                            {% if order.tracking_number %}
                                <p><strong>Tracking:</strong> <code>{{ order.tracking_number }}</code></p>
                            {% endif %}
                            {% if order.delivery_date %}
                                <p><strong>Estimated Delivery:</strong> {{ order.delivery_date|date:"M j, Y" }}</p>
                            {% endif %}
                            {% if order.delivery_notes %}
                                <p><strong>Notes:</strong> {{ order.delivery_notes }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Internal Notes -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-sticky-note me-2"></i>Internal Notes
                </h5>
            </div>
            <div class="card-body">
                {% if order.status_notes %}
                    <blockquote class="blockquote">
                        <p class="mb-1">{{ order.status_notes }}</p>
                        <footer class="blockquote-footer">
                            Last updated: {{ order.status_updated_at|date:"M j, Y g:i A" }}
                            {% if order.status_updated_by %}by {{ order.status_updated_by.get_full_name }}{% endif %}
                        </footer>
                    </blockquote>
                {% else %}
                    <p class="text-muted mb-0">No internal notes available.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Order Summary & Customer Info -->
    <div class="col-lg-4">
        <!-- Order Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Order Summary</h5>
            </div>
            <div class="card-body">
                <!-- Pricing Breakdown -->
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span>{{ company.default_currency|default:"KES" }} {{ order.subtotal|floatformat:0 }}</span>
                </div>
                {% if order.discount_amount > 0 %}
                <div class="d-flex justify-content-between mb-2">
                    <span>Discount:</span>
                    <span class="text-success">-{{ company.default_currency|default:"KES" }} {{ order.discount_amount|floatformat:0 }}</span>
                </div>
                {% endif %}
                <div class="d-flex justify-content-between mb-2">
                    <span>VAT ({{ company.vat_rate|default:"16" }}%):</span>
                    <span>{{ company.default_currency|default:"KES" }} {{ order.tax_amount|floatformat:0 }}</span>
                </div>
                {% if order.shipping_cost > 0 %}
                <div class="d-flex justify-content-between mb-2">
                    <span>Shipping:</span>
                    <span>{{ company.default_currency|default:"KES" }} {{ order.shipping_cost|floatformat:0 }}</span>
                </div>
                {% endif %}
                <hr>
                <div class="d-flex justify-content-between mb-3">
                    <strong>Total:</strong>
                    <strong>{{ company.default_currency|default:"KES" }} {{ order.total_amount|floatformat:0 }}</strong>
                </div>

                <!-- Payment Info -->
                <h6 class="mb-2">Payment Information</h6>
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-{% if order.payment_method == 'mpesa' %}mobile-alt text-success{% elif order.payment_method == 'bank_transfer' %}university text-primary{% elif order.payment_method == 'cash_on_delivery' %}truck text-info{% else %}money-bill text-warning{% endif %} me-2"></i>
                    <span>{{ order.get_payment_method_display }}</span>
                </div>
                {% if order.mpesa_transaction_id %}
                <div class="small text-muted mb-3">
                    <strong>M-Pesa Receipt:</strong> {{ order.mpesa_transaction_id }}
                </div>
                {% endif %}
                <div class="mb-3">
                    <span class="badge {% if order.payment_status == 'paid' %}bg-success{% elif order.payment_status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                        {{ order.get_payment_status_display }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Customer Information -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user me-2"></i>Customer Information
                </h5>
            </div>
            <div class="card-body">
                <h6>Contact Details</h6>
                <div class="small mb-3">
                    <div class="mb-2">
                        <strong>Name:</strong><br>
                        {% if order.customer.name and order.customer.name|length > 0 and order.customer.name != order.customer.email %}
                            {{ order.customer.name }}
                        {% elif order.user and order.user.get_full_name %}
                            {{ order.user.get_full_name }}
                        {% else %}
                            {{ order.customer.email }}
                        {% endif %}
                    </div>
                    <div class="mb-2">
                        <strong>Email:</strong><br>
                        <a href="mailto:{{ order.customer.email }}">{{ order.customer.email }}</a>
                    </div>
                    {% if order.customer.phone %}
                    <div class="mb-2">
                        <strong>Phone:</strong><br>
                        <a href="tel:{{ order.customer.phone }}">{{ order.customer.phone }}</a>
                    </div>
                    {% endif %}
                </div>

                {% if order.customer.email %}
                <a href="{% url 'crm:contact_list' %}?search={{ order.customer.email|urlencode }}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-address-card me-1"></i>View Customer Profile
                </a>
                {% if order.customer.phone %}
                <a href="{% url 'crm:contact_create' %}?email={{ order.customer.email|urlencode }}&first_name={{ order.customer.name|split_name:0|urlencode }}&last_name={{ order.customer.name|split_name:1|urlencode }}&phone={{ order.customer.phone|urlencode }}&source=order" class="btn btn-outline-success btn-sm">
                    <i class="fas fa-user-plus me-1"></i>Add to CRM
                </a>
                {% else %}
                <a href="{% url 'crm:contact_create' %}?email={{ order.customer.email|urlencode }}&first_name={{ order.customer.name|split_name:0|urlencode }}&last_name={{ order.customer.name|split_name:1|urlencode }}&source=order" class="btn btn-outline-success btn-sm">
                    <i class="fas fa-user-plus me-1"></i>Add to CRM
                </a>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.order-timeline {
    position: relative;
    padding-left: 30px;
}

.order-timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
}

.timeline-marker {
    position: absolute;
    left: -37px;
    top: 0;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #e9ecef;
    border: 3px solid #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: #6c757d;
}

.timeline-item.completed .timeline-marker {
    background-color: #198754;
    color: white;
}

.timeline-item.active .timeline-marker {
    background-color: #0d6efd;
    color: white;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Status Update Modal
function showStatusUpdateModal(orderNumber, currentStatus, currentStatusDisplay) {
    let modal = document.getElementById('statusUpdateModal');
    if (!modal) {
        modal = createStatusUpdateModal();
        document.body.appendChild(modal);
    }

    document.getElementById('modalOrderNumber').textContent = orderNumber;
    document.getElementById('modalCurrentStatus').textContent = currentStatusDisplay;
    document.getElementById('statusUpdateForm').dataset.orderNumber = orderNumber;

    populateStatusOptions(currentStatus);

    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

function createStatusUpdateModal() {
    const modalHTML = `
        <div class="modal fade" id="statusUpdateModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Update Order Status</h5>
                        <button type="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Order:</strong> <span id="modalOrderNumber"></span></p>
                        <p><strong>Current Status:</strong> <span id="modalCurrentStatus"></span></p>

                        <form id="statusUpdateForm">
                            <div class="mb-3">
                                <label for="newStatus" class="form-label">New Status</label>
                                <select class="form-select" id="newStatus" required>
                                    <option value="">Select new status...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="statusNotes" class="form-label">Notes (Optional)</label>
                                <textarea class="form-control" id="statusNotes" rows="3" placeholder="Add notes about this status change..."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="submitStatusUpdate()">Update Status</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHTML;
    return tempDiv.firstElementChild;
}

function populateStatusOptions(currentStatus) {
    const statusOptions = {
        'received': [
            {value: 'pending_payment', text: 'Pending Payment'},
            {value: 'paid', text: 'Payment Confirmed'},
            {value: 'cancelled', text: 'Cancelled'}
        ],
        'pending_payment': [
            {value: 'paid', text: 'Payment Confirmed'},
            {value: 'cancelled', text: 'Cancelled'}
        ],
        'paid': [
            {value: 'processing', text: 'Processing'},
            {value: 'cancelled', text: 'Cancelled'}
        ],
        'processing': [
            {value: 'packed_ready', text: 'Packed & Ready'},
            {value: 'cancelled', text: 'Cancelled'}
        ],
        'packed_ready': [
            {value: 'shipped', text: 'Shipped'}
        ],
        'shipped': [
            {value: 'out_for_delivery', text: 'Out for Delivery'},
            {value: 'delivered', text: 'Delivered'}
        ],
        'out_for_delivery': [
            {value: 'delivered', text: 'Delivered'},
            {value: 'returned', text: 'Returned'}
        ],
        'delivered': [
            {value: 'completed', text: 'Completed'},
            {value: 'returned', text: 'Returned'}
        ],
        'completed': [
            {value: 'returned', text: 'Returned'}
        ],
        'returned': [
            {value: 'refunded', text: 'Refunded'}
        ]
    };

    const select = document.getElementById('newStatus');
    select.innerHTML = '<option value="">Select new status...</option>';

    const options = statusOptions[currentStatus] || [];
    options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.text;
        select.appendChild(optionElement);
    });
}

function submitStatusUpdate() {
    const form = document.getElementById('statusUpdateForm');
    const orderNumber = form.dataset.orderNumber;
    const newStatus = document.getElementById('newStatus').value;
    const notes = document.getElementById('statusNotes').value;

    if (!newStatus) {
        alert('Please select a new status');
        return;
    }

    fetch(`/shop/api/orders/${orderNumber}/status/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: newStatus, notes: notes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating order status: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the order status');
    });
}

function showStatusHistory(orderNumber) {
    fetch(`/shop/api/orders/${orderNumber}/history/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatusHistoryModal(orderNumber, data.history);
            } else {
                alert('Error loading status history');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading status history');
        });
}

function showStatusHistoryModal(orderNumber, history) {
    let modal = document.getElementById('statusHistoryModal');
    if (!modal) {
        modal = createStatusHistoryModal();
        document.body.appendChild(modal);
    }

    document.getElementById('historyOrderNumber').textContent = orderNumber;

    const historyContainer = document.getElementById('statusHistoryContainer');
    if (history.length === 0) {
        historyContainer.innerHTML = '<div class="text-center py-3 text-muted">No status history available</div>';
    } else {
        historyContainer.innerHTML = history.map(entry => `
            <div class="status-history-entry">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${entry.new_status_display}</strong>
                        ${entry.previous_status ? `<small class="text-muted">(from ${entry.previous_status_display})</small>` : ''}
                        <br>
                        <small class="text-muted">by ${entry.changed_by} on ${new Date(entry.created_at).toLocaleDateString()}</small>
                    </div>
                </div>
                ${entry.notes ? `<div class="mt-2"><small><em>${entry.notes}</em></small></div>` : ''}
            </div>
        `).join('');
    }

    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

function createStatusHistoryModal() {
    const modalHTML = `
        <div class="modal fade" id="statusHistoryModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Order Status History</h5>
                        <button type="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Order:</strong> <span id="historyOrderNumber"></span></p>
                        <div id="statusHistoryContainer"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHTML;
    return tempDiv.firstElementChild;
}
</script>
{% endblock %}
