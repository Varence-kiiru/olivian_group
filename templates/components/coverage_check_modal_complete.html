{% comment %}
Coverage Check Modal Component (Complete)
This component provides an interactive way to check service area coverage.
Includes both HTML structure and JavaScript functionality inline.

Usage:
1. Include this template: {% include "components/coverage_check_modal_complete.html" %}
2. Add the CSS: <link rel="stylesheet" href="{% static 'css/coverage_check_modal.css' %}">
3. Call openCoverageCheckModal() to show the modal

The modal will:
- Allow users to enter their location
- Check coverage via AJAX
- Display results with appropriate messaging
- Provide next steps based on coverage status
{% endcomment %}

<!-- Coverage Check Modal -->
<div class="modal fade" id="coverageCheckModal" tabindex="-1" role="dialog" aria-labelledby="coverageCheckModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="coverageCheckModalLabel">
                    <i class="fas fa-map-marker-alt me-2"></i>Check Service Coverage
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Input Section -->
                <div id="coverage-input-section">
                    <div class="text-center mb-4">
                        <div class="coverage-icon mb-3">
                            <i class="fas fa-search-location text-primary" style="font-size: 3rem;"></i>
                        </div>
                        <h4>Find Out If We Service Your Area</h4>
                        <p class="text-muted">Enter your county, town, or city to check our service coverage</p>
                    </div>

                    <!-- Location Input -->
                    <form id="coverage-check-form" novalidate>
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text bg-light">
                                        <i class="fas fa-map-marker-alt text-muted"></i>
                                    </span>
                                    <input type="text"
                                           class="form-control"
                                           id="coverage-location-input"
                                           placeholder="e.g., Nairobi, Kiambu, Nakuru..."
                                           required
                                           autocomplete="off">
                                    <button type="submit" class="btn btn-primary" id="check-coverage-btn">
                                        <i class="fas fa-search me-2"></i>Check Coverage
                                    </button>
                                </div>
                                <div class="form-text text-center mt-2">
                                    <small class="text-muted">We serve primary areas directly and offer extended coverage to other locations</small>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Google Maps Interface -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="text-center mb-3">
                                <small class="text-muted">Or click on the map to select your location</small>
                            </div>
                            <div id="coverage-map" style="height: 300px; width: 100%; border-radius: 0.375rem; border: 1px solid #dee2e6;"></div>
                            <div class="text-center mt-2">
                                <small class="text-muted">Click anywhere on the map to check coverage at that location</small>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Location Suggestions -->
                    <div class="row mt-4">
                        <div class="col-12 text-center">
                            <p class="text-muted mb-2">Popular areas:</p>
                            <div class="d-flex flex-wrap justify-content-center gap-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm location-suggestion" data-location="Nairobi">Nairobi</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm location-suggestion" data-location="Kiambu">Kiambu</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm location-suggestion" data-location="Machakos">Machakos</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm location-suggestion" data-location="Kajiado">Kajiado</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm location-suggestion" data-location="Nakuru">Nakuru</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="coverage-results-section" style="display: none;">
                    <div class="text-center mb-4">
                        <div class="coverage-result-icon mb-3" id="coverage-result-icon">
                            <!-- Icon will be set by JavaScript -->
                        </div>
                        <h4 id="coverage-result-title">Checking Coverage...</h4>
                        <p class="text-muted" id="coverage-result-message">Please wait while we check your location.</p>
                    </div>

                    <!-- Coverage Details -->
                    <div id="coverage-details" style="display: none;">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-info-circle me-2 text-primary"></i>
                                    Service Information for <span id="area-name"></span>
                                </h6>
                                <div id="area-details">
                                    <!-- Details will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Next Steps -->
                    <div id="coverage-next-steps" class="mt-4">
                        <!-- Next steps will be populated by JavaScript -->
                    </div>

                    <!-- Newsletter Signup (shown for areas not covered) -->
                    <div id="coverage-newsletter-signup" class="mt-4" style="display: none;">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-envelope me-2 text-primary"></i>Get Notified When We Expand
                                </h6>
                                <p class="card-text small mb-3">Be the first to know when solar services become available in your area.</p>
                                <form id="modalNewsletterForm" action="{% url 'core:newsletter_subscribe' %}" method="post" class="d-flex gap-2">
                                    {% csrf_token %}
                                    <input type="email" name="email" class="form-control form-control-sm" placeholder="Enter your email" required>
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="fas fa-paper-plane me-1"></i>Subscribe
                                    </button>
                                </form>
                                <div id="modalNewsletterMessage" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Section -->
                <div id="coverage-loading-section" style="display: none;">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5>Checking Coverage...</h5>
                        <p class="text-muted">Please wait while we verify service availability in your area.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div id="coverage-modal-footer">
                    <!-- Footer content will change based on results -->
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="coverage-modal-loading" class="coverage-modal-loading" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <div class="mt-2">Checking coverage...</div>
</div>

<!-- Coverage Check Modal JavaScript -->
<script>
/**
 * Coverage Check Modal JavaScript
 * Handles interactive map functionality for checking service coverage
 */

// Set Google Maps API key from Django template
var djangoGoogleMapsApiKey = '{{ GOOGLE_MAPS_API_KEY|default:"" }}';

// Coverage Check Modal Configuration
window.coverageModalConfig = window.coverageModalConfig || {
    apiEndpoint: '/api/coverage-check/',
    googleMapsApiKey: djangoGoogleMapsApiKey, // Use the Django variable
    defaultCenter: { lat: -1.2864, lng: 36.8172 }, // Nairobi coordinates
    defaultZoom: 8
};

// Global variables for Google Maps
var coverageMap = null;
var coverageMarker = null;
var coverageInfoWindow = null;
var googleMapsLoading = false;
var googleMapsInitialized = false;

// Initialize coverage check modal functionality
function initializeCoverageCheckModal() {
    console.log('Initializing coverage check modal...');

    // Handle form submission
    const coverageForm = document.getElementById('coverage-check-form');
    if (coverageForm) {
        // Prevent all form submissions and validation
        coverageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            performCoverageCheck();
            return false;
        });

        // Prevent browser validation on form elements
        coverageForm.addEventListener('invalid', function(e) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }, true);

        // Handle button clicks to prevent form submission
        const checkBtn = document.getElementById('check-coverage-btn');
        if (checkBtn) {
            checkBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                performCoverageCheck();
                return false;
            });
        }
    }

    // Handle location suggestions
    const locationSuggestions = document.querySelectorAll('.location-suggestion');
    locationSuggestions.forEach(button => {
        button.addEventListener('click', function() {
            const location = this.getAttribute('data-location');
            const input = document.getElementById('coverage-location-input');
            if (input && location) {
                input.value = location;
                performCoverageCheck();
            }
        });
    });

    // Handle input enter key
    const locationInput = document.getElementById('coverage-location-input');
    if (locationInput) {
        locationInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performCoverageCheck();
            }
        });
    }
}

// Open coverage check modal
function openCoverageCheckModal() {
    console.log('Opening coverage check modal...');

    // Reset modal state
    resetCoverageCheckModal();

    // Show modal
    const modal = document.getElementById('coverageCheckModal');
    if (modal) {
        if (window.bootstrap) {
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        } else if (window.jQuery) {
            $('#coverageCheckModal').modal('show');
        } else {
            modal.style.display = 'block';
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // Initialize Google Maps when modal opens (this is the reference point)
        setTimeout(() => {
            initializeGoogleMaps();
        }, 300);

        // Focus on input after modal is shown
        setTimeout(() => {
            const input = document.getElementById('coverage-location-input');
            if (input) input.focus();
        }, 500);

        // Trigger map resize if map exists
        setTimeout(() => {
            if (coverageMap && window.google && window.google.maps && window.google.maps.event) {
                google.maps.event.trigger(coverageMap, 'resize');
                // Force recenter and re-zoom to reload tiles
                coverageMap.setCenter(coverageMap.getCenter());
                coverageMap.setZoom(coverageMap.getZoom());
            }
        }, 600);
    }
}

// Reset coverage check modal
function resetCoverageCheckModal() {
    // Show input section, hide others
    document.getElementById('coverage-input-section').style.display = 'block';
    document.getElementById('coverage-results-section').style.display = 'none';
    document.getElementById('coverage-loading-section').style.display = 'none';

    // Reset form
    const form = document.getElementById('coverage-check-form');
    if (form) form.reset();

    // Reset button state
    const checkBtn = document.getElementById('check-coverage-btn');
    if (checkBtn) {
        checkBtn.disabled = false;
        checkBtn.innerHTML = '<i class="fas fa-search me-2"></i>Check Coverage';
    }

    // Reset footer
    const footer = document.getElementById('coverage-modal-footer');
    if (footer) {
        footer.innerHTML = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i>Close
            </button>
        `;
    }
}

// Perform coverage check
function performCoverageCheck() {
    const locationInput = document.getElementById('coverage-location-input');
    const location = locationInput ? locationInput.value.trim() : '';

    if (!location) {
        showCoverageNotification('warning', 'Location Required', 'Please enter a location to check coverage.');
        if (locationInput) locationInput.focus();
        return;
    }

    // Show loading state
    showCoverageLoading(true);
    setCheckButtonState(true);

    // Make API call
    fetch(`${window.coverageModalConfig.apiEndpoint}?location=${encodeURIComponent(location)}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => response.json())
    .then(data => {
        showCoverageLoading(false);
        setCheckButtonState(false);

        if (data.success) {
            displayCoverageResults(data);
        } else {
            showCoverageNotification('error', 'Error', data.message || 'Failed to check coverage. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error checking coverage:', error);
        showCoverageLoading(false);
        setCheckButtonState(false);
        showCoverageNotification('error', 'Network Error', 'Unable to check coverage. Please check your connection and try again.');
    });
}

// Display coverage results
function displayCoverageResults(data) {
    // Hide input section, show results
    document.getElementById('coverage-input-section').style.display = 'none';
    document.getElementById('coverage-results-section').style.display = 'block';

    // Set result icon and styling
    const resultIcon = document.getElementById('coverage-result-icon');
    const resultTitle = document.getElementById('coverage-result-title');
    const resultMessage = document.getElementById('coverage-result-message');

    if (data.covered) {
        if (data.coverage_type === 'primary') {
            resultIcon.className = 'coverage-result-icon covered';
            resultIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            resultTitle.textContent = 'Great! We Service Your Area';
        } else if (data.coverage_type === 'extended') {
            resultIcon.className = 'coverage-result-icon extended';
            resultIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
            resultTitle.textContent = 'Extended Coverage Available';
        }
    } else {
        resultIcon.className = 'coverage-result-icon not-covered';
        resultIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
        resultTitle.textContent = 'Service Area Expansion';
    }

    resultMessage.textContent = data.message;

    // Add animation
    resultIcon.classList.add('coverage-result-animated');

    // Show area details if available
    if (data.area) {
        showAreaDetails(data.area);
    }

    // Show next steps
    showNextSteps(data);

    // Update modal footer
    updateModalFooter(data);
}

// Show area details
function showAreaDetails(area) {
    const detailsDiv = document.getElementById('coverage-details');
    const areaNameSpan = document.getElementById('area-name');
    const areaDetailsDiv = document.getElementById('area-details');

    if (areaNameSpan) areaNameSpan.textContent = area.name;

    let detailsHtml = '';
    if (area.description) {
        detailsHtml += `<div class="coverage-details-row"><strong>Description:</strong> ${area.description}</div>`;
    }
    if (area.estimated_response_time) {
        detailsHtml += `<div class="coverage-details-row"><strong>Response Time:</strong> ${area.estimated_response_time}</div>`;
    }
    if (area.contact_person) {
        detailsHtml += `<div class="coverage-details-row"><strong>Contact Person:</strong> ${area.contact_person}</div>`;
    }
    if (area.contact_phone) {
        detailsHtml += `<div class="coverage-details-row"><strong>Contact Phone:</strong> <a href="tel:${area.contact_phone}">${area.contact_phone}</a></div>`;
    }

    if (areaDetailsDiv) areaDetailsDiv.innerHTML = detailsHtml;
    if (detailsDiv) detailsDiv.style.display = 'block';
}

// Show next steps based on coverage
function showNextSteps(data) {
    const nextStepsDiv = document.getElementById('coverage-next-steps');

    let stepsHtml = '<h5 class="mb-3">Next Steps</h5>';

    if (data.covered) {
        if (data.coverage_type === 'primary') {
            stepsHtml += `
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card next-steps-card h-100">
                            <div class="card-body text-center">
                                <div class="next-steps-icon primary mb-3">
                                    <i class="fas fa-calculator"></i>
                                </div>
                                <h6 class="card-title">Get Free Quote</h6>
                                <p class="card-text small">Get a personalized solar system quote for your property.</p>
                                <a href="/quotations/request/" class="btn btn-primary btn-sm">Request Quote</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card next-steps-card h-100">
                            <div class="card-body text-center">
                                <div class="next-steps-icon success mb-3">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <h6 class="card-title">Free Consultation</h6>
                                <p class="card-text small">Speak with our solar experts about your needs.</p>
                                <a href="/contact/" class="btn btn-success btn-sm">Contact Us</a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else if (data.coverage_type === 'extended') {
            stepsHtml += `
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card next-steps-card h-100">
                            <div class="card-body text-center">
                                <div class="next-steps-icon secondary mb-3">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <h6 class="card-title">Discuss Options</h6>
                                <p class="card-text small">Contact us to discuss extended coverage for your area.</p>
                                <a href="/contact/" class="btn btn-secondary btn-sm">Contact Us</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card next-steps-card h-100">
                            <div class="card-body text-center">
                                <div class="next-steps-icon primary mb-3">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <h6 class="card-title">Get Updates</h6>
                                <p class="card-text small">Stay informed when we expand to your area.</p>
                                <a href="#newsletter" class="btn btn-primary btn-sm">Subscribe</a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    } else {
        stepsHtml += `
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card next-steps-card h-100">
                        <div class="card-body text-center">
                            <div class="next-steps-icon primary mb-3">
                                <i class="fas fa-map-marked-alt"></i>
                            </div>
                            <h6 class="card-title">Explore Nearby Areas</h6>
                            <p class="card-text small">Check coverage in nearby counties or towns.</p>
                            <button type="button" class="btn btn-primary btn-sm" onclick="resetToInput()">Check Another Area</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card next-steps-card h-100">
                        <div class="card-body text-center">
                            <div class="next-steps-icon success mb-3">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <h6 class="card-title">Get Notified</h6>
                            <p class="card-text small">Be the first to know when we expand to your area.</p>
                            <button type="button" class="btn btn-success btn-sm" onclick="showModalNewsletterSignup()">Subscribe</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    if (nextStepsDiv) nextStepsDiv.innerHTML = stepsHtml;
}

// Update modal footer based on results
function updateModalFooter(data) {
    const footer = document.getElementById('coverage-modal-footer');

    let footerHtml = '';

    if (data.covered && data.coverage_type === 'primary') {
        footerHtml = `
            <a href="/quotations/request/" class="btn btn-primary">
                <i class="fas fa-calculator me-1"></i>Get Free Quote
            </a>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i>Close
            </button>
        `;
    } else {
        footerHtml = `
            <button type="button" class="btn btn-outline-primary" onclick="resetToInput()">
                <i class="fas fa-search me-1"></i>Check Another Area
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i>Close
            </button>
        `;
    }

    if (footer) footer.innerHTML = footerHtml;
}

// Reset to input section
function resetToInput() {
    resetCoverageCheckModal();
}

// Show/hide loading overlay
function showCoverageLoading(show) {
    const loading = document.getElementById('coverage-modal-loading');
    if (loading) {
        loading.style.display = show ? 'flex' : 'none';
    }

    // Also show/hide loading section in modal
    const loadingSection = document.getElementById('coverage-loading-section');
    if (loadingSection) {
        loadingSection.style.display = show ? 'block' : 'none';
    }
}

// Set check button state
function setCheckButtonState(loading) {
    const checkBtn = document.getElementById('check-coverage-btn');
    if (checkBtn) {
        if (loading) {
            checkBtn.disabled = true;
            checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Checking...';
        } else {
            checkBtn.disabled = false;
            checkBtn.innerHTML = '<i class="fas fa-search me-2"></i>Check Coverage';
        }
    }
}

// Show notification
function showCoverageNotification(type, title, message) {
    if (typeof notify !== 'undefined' && notify.show) {
        notify.show(type, title, message);
    } else if (window.Swal) {
        Swal.fire({
            icon: type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info',
            title: title,
            text: message,
            timer: 3000,
            showConfirmButton: false
        });
    } else {
        alert(`${title}: ${message}`);
    }
}

// Close coverage check modal
function closeCoverageCheckModal() {
    const modal = document.getElementById('coverageCheckModal');
    if (modal) {
        if (window.bootstrap) {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) bsModal.hide();
        } else if (window.jQuery) {
            $('#coverageCheckModal').modal('hide');
        } else {
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }
    }
}

// Google Maps Integration Functions
function initializeGoogleMaps() {
    console.log('Initializing Google Maps...');

    // Prevent multiple initialization attempts
    if (googleMapsInitialized) {
        console.log('Google Maps already initialized, skipping...');
        return;
    }

    if (!window.coverageModalConfig.googleMapsApiKey) {
        console.warn('Google Maps API key not configured - showing fallback message');
        showMapFallbackMessage();
        return;
    }

    // Set up the global callback for the HTML script tag (only once)
    if (!window.initCoverageMap) {
        window.initCoverageMap = function() {
            console.log('Google Maps API loaded successfully');
            googleMapsLoading = false;
            if (!googleMapsInitialized) {
                initCoverageMap();
            }
        };
    }

    // Check if Google Maps API is already loaded
    if (window.google && window.google.maps) {
        console.log('Google Maps API already available, initializing map...');
        if (!googleMapsInitialized) {
            initCoverageMap();
        }
        return;
    }

    // Load Google Maps API script if not already loaded and not loading
    if (!googleMapsLoading) {
        console.log('Google Maps API not loaded, loading script...');
        loadGoogleMapsAPI();
    }
}

// Show fallback message when Google Maps is not available
function showMapFallbackMessage() {
    const mapElement = document.getElementById('coverage-map');
    if (mapElement) {
        mapElement.style.backgroundColor = '#f8f9fa';
        mapElement.style.display = 'flex';
        mapElement.style.alignItems = 'center';
        mapElement.style.justifyContent = 'center';
        mapElement.style.border = '2px dashed #dee2e6';
        mapElement.innerHTML = `
            <div class="text-center text-muted p-3">
                <i class="fas fa-map-marked-alt fa-2x mb-2"></i>
                <p class="mb-1">Interactive map not available</p>
                <small>Please enter your location above to check coverage</small>
            </div>
        `;
    }
}

function loadGoogleMapsAPI() {
    // Prevent multiple loading attempts
    if (googleMapsLoading) {
        console.log('Google Maps API already loading, skipping...');
        return;
    }

    googleMapsLoading = true;

    // Create and load the Google Maps script following best practices
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${window.coverageModalConfig.googleMapsApiKey}&libraries=places&callback=initCoverageMap`;
    script.async = true; // Use async only (not defer) for callback-based scripts

    script.onerror = function() {
        console.error('Failed to load Google Maps API');
        googleMapsLoading = false;
        showMapFallbackMessage();
    };

    document.head.appendChild(script);
}

function initCoverageMap() {
    // Prevent multiple initializations
    if (coverageMap) {
        console.log('Coverage map already initialized, skipping...');
        return;
    }

    if (!window.google || !window.google.maps) {
        console.error('Google Maps API not loaded - showing fallback');
        showMapFallbackMessage();
        return;
    }

    const mapElement = document.getElementById('coverage-map');
    if (!mapElement) {
        console.warn('Coverage map element not found');
        return;
    }

    try {
        // Clear any existing fallback message
        mapElement.innerHTML = '';
        mapElement.style.backgroundColor = '';
        mapElement.style.border = '';

        // Initialize map
        coverageMap = new google.maps.Map(mapElement, {
            center: window.coverageModalConfig.defaultCenter,
            zoom: window.coverageModalConfig.defaultZoom,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: true,
            zoomControl: true,
            styles: [
                {
                    featureType: 'poi',
                    stylers: [{ visibility: 'off' }]
                }
            ]
        });

        // Initialize info window
        coverageInfoWindow = new google.maps.InfoWindow();

        // Add click listener to map
        coverageMap.addListener('click', function(event) {
            handleMapClick(event.latLng);
        });

        // Mark as initialized
        googleMapsInitialized = true;

        console.log('Google Maps initialized successfully');

    } catch (error) {
        console.error('Error initializing Google Maps:', error);
        showMapFallbackMessage();
    }
}

function handleMapClick(latLng) {
    const lat = latLng.lat();
    const lng = latLng.lng();

    // Update marker position
    if (coverageMarker) {
        coverageMarker.setPosition(latLng);
    } else {
        coverageMarker = new google.maps.Marker({
            position: latLng,
            map: coverageMap,
            title: 'Selected Location',
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="18" fill="#007bff" stroke="white" stroke-width="3"/>
                        <text x="20" y="25" text-anchor="middle" fill="white" font-size="16" font-weight="bold">?</text>
                    </svg>
                `),
                scaledSize: new google.maps.Size(40, 40),
                anchor: new google.maps.Point(20, 40)
            }
        });
    }

    // Show loading state
    showCoverageLoading(true);

    // Reverse geocode to get address
    reverseGeocodeLocation(lat, lng);
}

function reverseGeocodeLocation(lat, lng) {
    if (!window.google || !window.google.maps) {
        console.error('Google Maps API not available for reverse geocoding');
        return;
    }

    const geocoder = new google.maps.Geocoder();
    const latLng = { lat: parseFloat(lat), lng: parseFloat(lng) };

    geocoder.geocode({ location: latLng }, function(results, status) {
        if (status === 'OK' && results[0]) {
            const address = results[0].formatted_address;
            const locationInput = document.getElementById('coverage-location-input');

            // Update input field with reverse geocoded address
            if (locationInput) {
                locationInput.value = address;
            }

            // Perform coverage check with coordinates
            checkCoverageByCoordinates(lat, lng, address);
        } else {
            console.error('Reverse geocoding failed:', status);
            showCoverageNotification('error', 'Location Error', 'Unable to identify the selected location. Please try again or enter an address manually.');
            showCoverageLoading(false);
        }
    });
}

function checkCoverageByCoordinates(lat, lng, address) {
    // Make API call with coordinates
    fetch(`${window.coverageModalConfig.apiEndpoint}?lat=${lat}&lng=${lng}&address=${encodeURIComponent(address)}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => response.json())
    .then(data => {
        showCoverageLoading(false);

        if (data.success) {
            // Update marker based on coverage result
            updateMarkerForCoverage(data, lat, lng);
            displayCoverageResults(data);
        } else {
            showCoverageNotification('error', 'Error', data.message || 'Failed to check coverage at this location.');
        }
    })
    .catch(error => {
        console.error('Error checking coverage by coordinates:', error);
        showCoverageLoading(false);
        showCoverageNotification('error', 'Network Error', 'Unable to check coverage. Please check your connection and try again.');
    });
}

function updateMarkerForCoverage(data, lat, lng) {
    if (!coverageMarker) return;

    let iconUrl;
    if (data.covered) {
        if (data.coverage_type === 'primary') {
            iconUrl = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="18" fill="#28a745" stroke="white" stroke-width="3"/>
                    <text x="20" y="25" text-anchor="middle" fill="white" font-size="16" font-weight="bold">✓</text>
                </svg>
            `);
        } else if (data.coverage_type === 'extended') {
            iconUrl = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="18" fill="#ffc107" stroke="white" stroke-width="3"/>
                    <text x="20" y="25" text-anchor="middle" fill="white" font-size="12" font-weight="bold">i</text>
                </svg>
            `);
        }
    } else {
        iconUrl = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
            <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                <circle cx="20" cy="20" r="18" fill="#dc3545" stroke="white" stroke-width="3"/>
                <text x="20" y="25" text-anchor="middle" fill="white" font-size="16" font-weight="bold">✗</text>
            </svg>
        `);
    }

    coverageMarker.setIcon({
        url: iconUrl,
        scaledSize: new google.maps.Size(40, 40),
        anchor: new google.maps.Point(20, 40)
    });

    // Show info window with coverage info
    const infoContent = `
        <div style="max-width: 200px;">
            <strong>${data.covered ? 'Service Available' : 'Service Not Available'}</strong><br>
            <small>${data.message}</small>
        </div>
    `;

    coverageInfoWindow.setContent(infoContent);
    coverageInfoWindow.open(coverageMap, coverageMarker);
}

// Show modal newsletter signup
function showModalNewsletterSignup() {
    const newsletterDiv = document.getElementById('coverage-newsletter-signup');
    if (newsletterDiv) {
        newsletterDiv.style.display = 'block';
        // Scroll to the newsletter section
        newsletterDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        // Focus on the email input
        const emailInput = newsletterDiv.querySelector('input[type="email"]');
        if (emailInput) {
            setTimeout(() => emailInput.focus(), 300);
        }
    }
}

// Handle modal newsletter form submission
document.addEventListener('DOMContentLoaded', function() {
    const modalNewsletterForm = document.getElementById('modalNewsletterForm');
    if (modalNewsletterForm) {
        modalNewsletterForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const form = this;
            const formData = new FormData(form);
            const messageDiv = document.getElementById('modalNewsletterMessage');
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            submitBtn.disabled = true;

            // Send AJAX request
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageDiv.innerHTML = `<div class="alert alert-success alert-sm"><i class="fas fa-check-circle me-2"></i>${data.message}</div>`;
                    form.reset();
                    // Hide the form after successful subscription
                    setTimeout(() => {
                        const newsletterDiv = document.getElementById('coverage-newsletter-signup');
                        if (newsletterDiv) {
                            newsletterDiv.style.display = 'none';
                        }
                    }, 2000);
                } else {
                    messageDiv.innerHTML = `<div class="alert alert-danger alert-sm"><i class="fas fa-exclamation-triangle me-2"></i>${data.message}</div>`;
                }
            })
            .catch(error => {
                messageDiv.innerHTML = '<div class="alert alert-danger alert-sm"><i class="fas fa-exclamation-triangle me-2"></i>Subscription failed. Please try again.</div>';
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;

                // Clear message after 5 seconds
                setTimeout(() => {
                    if (messageDiv) messageDiv.innerHTML = '';
                }, 5000);
            });
        });
    }

    initializeCoverageCheckModal();
    initializeGoogleMaps();
});

// Also initialize if jQuery is available
if (typeof jQuery !== 'undefined') {
    jQuery(document).ready(function($) {
        initializeCoverageCheckModal();
        initializeGoogleMaps();
    });
}
</script>
