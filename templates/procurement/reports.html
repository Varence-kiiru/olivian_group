{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Procurement Reports & Analytics - {{ block.super }}{% endblock %}

{% block page_title %}Procurement Reports & Analytics{% endblock %}
{% block page_subtitle %}Comprehensive procurement data analysis and reporting{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'procurement:dashboard' %}">Procurement</a></li>
<li class="breadcrumb-item active">Reports</li>
{% endblock %}

{% block extra_css %}
<style>
    .report-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        transition: transform 0.2s ease;
        cursor: pointer;
        border-left: 4px solid transparent;
    }
    
    .report-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .report-spending { border-left-color: #4caf50; }
    .report-performance { border-left-color: #2196f3; }
    .report-compliance { border-left-color: #ff9800; }
    .report-analysis { border-left-color: #9c27b0; }
    
    .report-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .icon-spending { background: #e8f5e8; color: #4caf50; }
    .icon-performance { background: #e3f2fd; color: #2196f3; }
    .icon-compliance { background: #fff3e0; color: #ff9800; }
    .icon-analysis { background: #f3e5f5; color: #9c27b0; }
    
    .report-filter {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
    }
    
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        height: 400px;
    }
    
    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .metric-card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .metric-spending { color: #4caf50; }
    .metric-savings { color: #2196f3; }
    .metric-vendors { color: #ff9800; }
    .metric-orders { color: #9c27b0; }
    .metric-performance { color: #f44336; }
    
    .kpi-dashboard {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 1.5rem;
    }
    
    .kpi-item {
        text-align: center;
        padding: 1rem;
    }
    
    .kpi-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .kpi-label {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .table-report {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .export-options {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
    }
    
    .trend-indicator {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }
    
    .trend-up { background: #e8f5e8; color: #2e7d32; }
    .trend-down { background: #ffebee; color: #d32f2f; }
    .trend-stable { background: #f5f5f5; color: #666; }
    
    .savings-highlight {
        background: linear-gradient(135deg, #e8f5e8, #c8e6c8);
        border: 1px solid #4caf50;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .report-tabs {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #666;
        font-weight: 600;
    }
    
    .nav-tabs .nav-link.active {
        background: var(--primary-color);
        color: white;
    }
    
    .forecast-chart {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block content %}
<!-- KPI Dashboard -->
<div class="kpi-dashboard">
    <div class="row">
        <div class="col-md-3">
            <div class="kpi-item">
                <div class="kpi-value">KES 45.2M</div>
                <div class="kpi-label">Total Spend (YTD)</div>
                <div class="trend-indicator trend-up">
                    <i class="fas fa-arrow-up me-1"></i>+12%
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-item">
                <div class="kpi-value">KES 3.8M</div>
                <div class="kpi-label">Cost Savings</div>
                <div class="trend-indicator trend-up">
                    <i class="fas fa-arrow-up me-1"></i>+18%
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-item">
                <div class="kpi-value">147</div>
                <div class="kpi-label">Active Vendors</div>
                <div class="trend-indicator trend-up">
                    <i class="fas fa-arrow-up me-1"></i>+8
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-item">
                <div class="kpi-value">92.3%</div>
                <div class="kpi-label">Process Efficiency</div>
                <div class="trend-indicator trend-up">
                    <i class="fas fa-arrow-up me-1"></i>+2.1%
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Filter Controls -->
<div class="report-filter">
    <div class="row align-items-center">
        <div class="col-md-2">
            <label class="form-label small">Time Period</label>
            <select class="form-select form-select-sm" id="timePeriod">
                <option value="current_month">Current Month</option>
                <option value="last_month">Last Month</option>
                <option value="current_quarter" selected>Current Quarter</option>
                <option value="last_quarter">Last Quarter</option>
                <option value="ytd">Year to Date</option>
                <option value="last_year">Last Year</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small">Category</label>
            <select class="form-select form-select-sm" id="categoryFilter">
                <option value="">All Categories</option>
                <option value="solar_panels">Solar Panels</option>
                <option value="inverters">Inverters</option>
                <option value="cables">Cables & Wiring</option>
                <option value="installation">Installation Services</option>
                <option value="maintenance">Maintenance</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small">Vendor</label>
            <select class="form-select form-select-sm" id="vendorFilter">
                <option value="">All Vendors</option>
                <option value="solar_africa">Solar Africa Ltd</option>
                <option value="techelectro">TechElectro Systems</option>
                <option value="kenya_cables">Kenya Cables Ltd</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small">Department</label>
            <select class="form-select form-select-sm" id="departmentFilter">
                <option value="">All Departments</option>
                <option value="operations">Operations</option>
                <option value="installation">Installation</option>
                <option value="maintenance">Maintenance</option>
                <option value="admin">Administration</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small">&nbsp;</label>
            <div>
                <button class="btn btn-primary btn-sm me-2" onclick="updateReports()">
                    <i class="fas fa-sync me-1"></i>Update
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="resetFilters()">
                    Reset
                </button>
            </div>
        </div>
        <div class="col-md-2">
            <label class="form-label small">&nbsp;</label>
            <div>
                <button class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-1"></i>Export
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exportReport('pdf')">
                        <i class="fas fa-file-pdf me-2"></i>PDF Report
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportReport('excel')">
                        <i class="fas fa-file-excel me-2"></i>Excel Spreadsheet
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportReport('csv')">
                        <i class="fas fa-file-csv me-2"></i>CSV Data
                    </a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Report Categories -->
<div class="row">
    <div class="col-md-6">
        <div class="report-card report-spending" onclick="openReport('spending')">
            <div class="d-flex align-items-start">
                <div class="report-icon icon-spending">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div class="flex-grow-1">
                    <h5 class="mb-2">Spending Analysis</h5>
                    <p class="text-muted mb-3">
                        Detailed breakdown of procurement spending by category, vendor, 
                        and time period with trend analysis.
                    </p>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Total Spend</small>
                            <div class="fw-bold text-success">KES 45.2M</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">vs Last Quarter</small>
                            <div class="fw-bold text-primary">+12.3%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="report-card report-performance" onclick="openReport('performance')">
            <div class="d-flex align-items-start">
                <div class="report-icon icon-performance">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="flex-grow-1">
                    <h5 class="mb-2">Vendor Performance</h5>
                    <p class="text-muted mb-3">
                        Comprehensive vendor scorecards including delivery performance, 
                        quality ratings, and service levels.
                    </p>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Avg Rating</small>
                            <div class="fw-bold text-warning">4.2/5.0</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">On-Time Delivery</small>
                            <div class="fw-bold text-success">92.3%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="report-card report-compliance" onclick="openReport('compliance')">
            <div class="d-flex align-items-start">
                <div class="report-icon icon-compliance">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="flex-grow-1">
                    <h5 class="mb-2">Compliance & Audit</h5>
                    <p class="text-muted mb-3">
                        Contract compliance tracking, audit trails, and regulatory 
                        compliance monitoring for procurement activities.
                    </p>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Compliance Score</small>
                            <div class="fw-bold text-success">96.7%</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Audit Items</small>
                            <div class="fw-bold text-info">3 Open</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="report-card report-analysis" onclick="openReport('analysis')">
            <div class="d-flex align-items-start">
                <div class="report-icon icon-analysis">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="flex-grow-1">
                    <h5 class="mb-2">Advanced Analytics</h5>
                    <p class="text-muted mb-3">
                        Predictive analytics, cost optimization recommendations, 
                        and strategic procurement insights.
                    </p>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Savings Opportunity</small>
                            <div class="fw-bold text-success">KES 2.1M</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Risk Score</small>
                            <div class="fw-bold text-warning">Low</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Reports Tabs -->
<div class="report-tabs">
    <ul class="nav nav-tabs" id="reportTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="spending-tab" data-bs-toggle="tab" 
                    data-bs-target="#spending" type="button" role="tab">
                <i class="fas fa-chart-pie me-2"></i>Spending Analysis
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="savings-tab" data-bs-toggle="tab" 
                    data-bs-target="#savings" type="button" role="tab">
                <i class="fas fa-piggy-bank me-2"></i>Cost Savings
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="vendor-tab" data-bs-toggle="tab" 
                    data-bs-target="#vendor" type="button" role="tab">
                <i class="fas fa-handshake me-2"></i>Vendor Analysis
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="forecast-tab" data-bs-toggle="tab" 
                    data-bs-target="#forecast" type="button" role="tab">
                <i class="fas fa-crystal-ball me-2"></i>Forecasting
            </button>
        </li>
    </ul>
    
    <div class="tab-content p-3" id="reportTabsContent">
        <!-- Spending Analysis Tab -->
        <div class="tab-pane fade show active" id="spending" role="tabpanel">
            <div class="row">
                <div class="col-md-8">
                    <div class="chart-container">
                        <h6 class="mb-3">Spending by Category (Current Quarter)</h6>
                        <canvas id="spendingChart"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-value metric-spending">KES 18.5M</div>
                            <div class="small text-muted">Solar Panels</div>
                            <div class="small">41% of total</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value metric-savings">KES 12.3M</div>
                            <div class="small text-muted">Installation Services</div>
                            <div class="small">27% of total</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value metric-vendors">KES 8.7M</div>
                            <div class="small text-muted">Inverters & Electronics</div>
                            <div class="small">19% of total</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value metric-orders">KES 5.7M</div>
                            <div class="small text-muted">Cables & Components</div>
                            <div class="small">13% of total</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="table-report">
                <div class="card-header">
                    <h6 class="mb-0">Top Spending Categories - Detailed Breakdown</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Category</th>
                                <th class="text-end">Current Quarter</th>
                                <th class="text-end">Previous Quarter</th>
                                <th class="text-end">Change</th>
                                <th class="text-end">% of Total</th>
                                <th class="text-center">Trend</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Solar Panels</strong></td>
                                <td class="text-end">KES 18,500,000</td>
                                <td class="text-end">KES 16,200,000</td>
                                <td class="text-end">+KES 2,300,000</td>
                                <td class="text-end">41%</td>
                                <td class="text-center">
                                    <span class="trend-indicator trend-up">
                                        <i class="fas fa-arrow-up me-1"></i>+14.2%
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Installation Services</strong></td>
                                <td class="text-end">KES 12,300,000</td>
                                <td class="text-end">KES 11,800,000</td>
                                <td class="text-end">+KES 500,000</td>
                                <td class="text-end">27%</td>
                                <td class="text-center">
                                    <span class="trend-indicator trend-up">
                                        <i class="fas fa-arrow-up me-1"></i>+4.2%
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Inverters & Electronics</strong></td>
                                <td class="text-end">KES 8,700,000</td>
                                <td class="text-end">KES 9,100,000</td>
                                <td class="text-end">-KES 400,000</td>
                                <td class="text-end">19%</td>
                                <td class="text-center">
                                    <span class="trend-indicator trend-down">
                                        <i class="fas fa-arrow-down me-1"></i>-4.4%
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Cables & Components</strong></td>
                                <td class="text-end">KES 5,700,000</td>
                                <td class="text-end">KES 5,400,000</td>
                                <td class="text-end">+KES 300,000</td>
                                <td class="text-end">13%</td>
                                <td class="text-center">
                                    <span class="trend-indicator trend-up">
                                        <i class="fas fa-arrow-up me-1"></i>+5.6%
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Cost Savings Tab -->
        <div class="tab-pane fade" id="savings" role="tabpanel">
            <div class="savings-highlight">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="text-success mb-2">
                            <i class="fas fa-piggy-bank me-2"></i>Total Cost Savings This Quarter
                        </h5>
                        <p class="mb-0">
                            Through strategic procurement initiatives, vendor negotiations, 
                            and process optimization, we've achieved significant cost reductions.
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="display-6 fw-bold text-success">KES 3.8M</div>
                        <div class="text-muted">8.4% cost reduction</div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h6 class="mb-3">Savings Sources</h6>
                        <canvas id="savingsChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="table-report">
                        <div class="card-header">
                            <h6 class="mb-0">Savings Initiatives</h6>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <div>
                                        <strong>Vendor Negotiations</strong>
                                        <br><small class="text-muted">Better pricing through volume discounts</small>
                                    </div>
                                    <span class="badge bg-success rounded-pill">KES 1.5M</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <div>
                                        <strong>Process Optimization</strong>
                                        <br><small class="text-muted">Reduced processing time and costs</small>
                                    </div>
                                    <span class="badge bg-primary rounded-pill">KES 0.9M</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <div>
                                        <strong>Contract Consolidation</strong>
                                        <br><small class="text-muted">Streamlined vendor relationships</small>
                                    </div>
                                    <span class="badge bg-info rounded-pill">KES 0.8M</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <div>
                                        <strong>Early Payment Discounts</strong>
                                        <br><small class="text-muted">2-3% discounts for prompt payment</small>
                                    </div>
                                    <span class="badge bg-warning rounded-pill">KES 0.6M</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Vendor Analysis Tab -->
        <div class="tab-pane fade" id="vendor" role="tabpanel">
            <div class="row">
                <div class="col-md-12">
                    <div class="table-report">
                        <div class="card-header">
                            <h6 class="mb-0">Vendor Performance Scorecard</h6>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Vendor</th>
                                        <th class="text-end">Total Spend</th>
                                        <th class="text-center">Orders</th>
                                        <th class="text-center">On-Time %</th>
                                        <th class="text-center">Quality</th>
                                        <th class="text-center">Service</th>
                                        <th class="text-center">Overall</th>
                                        <th class="text-center">Risk Level</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <strong>Solar Africa Ltd</strong>
                                            <br><small class="text-muted">Solar Panel Supplier</small>
                                        </td>
                                        <td class="text-end">KES 18.5M</td>
                                        <td class="text-center">24</td>
                                        <td class="text-center">
                                            <span class="badge bg-success">96%</span>
                                        </td>
                                        <td class="text-center">4.9</td>
                                        <td class="text-center">4.8</td>
                                        <td class="text-center">
                                            <strong class="text-success">4.8</strong>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success">Low</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>TechElectro Systems</strong>
                                            <br><small class="text-muted">Electronics Supplier</small>
                                        </td>
                                        <td class="text-end">KES 8.7M</td>
                                        <td class="text-center">18</td>
                                        <td class="text-center">
                                            <span class="badge bg-success">89%</span>
                                        </td>
                                        <td class="text-center">4.7</td>
                                        <td class="text-center">4.6</td>
                                        <td class="text-center">
                                            <strong class="text-success">4.6</strong>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success">Low</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>Kenya Cables Ltd</strong>
                                            <br><small class="text-muted">Cable Manufacturer</small>
                                        </td>
                                        <td class="text-end">KES 5.7M</td>
                                        <td class="text-center">15</td>
                                        <td class="text-center">
                                            <span class="badge bg-warning">87%</span>
                                        </td>
                                        <td class="text-center">4.5</td>
                                        <td class="text-center">4.2</td>
                                        <td class="text-center">
                                            <strong class="text-warning">4.3</strong>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-warning">Medium</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>Installation Services Co</strong>
                                            <br><small class="text-muted">Service Provider</small>
                                        </td>
                                        <td class="text-end">KES 12.3M</td>
                                        <td class="text-center">12</td>
                                        <td class="text-center">
                                            <span class="badge bg-warning">83%</span>
                                        </td>
                                        <td class="text-center">4.2</td>
                                        <td class="text-center">4.1</td>
                                        <td class="text-center">
                                            <strong class="text-warning">4.1</strong>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-warning">Medium</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Forecasting Tab -->
        <div class="tab-pane fade" id="forecast" role="tabpanel">
            <div class="forecast-chart">
                <h6 class="mb-3">
                    <i class="fas fa-chart-line me-2"></i>Procurement Spend Forecast - Next 12 Months
                </h6>
                <div class="row">
                    <div class="col-md-8">
                        <canvas id="forecastChart" style="height: 300px;"></canvas>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-grid">
                            <div class="metric-card">
                                <div class="metric-value text-primary">KES 180M</div>
                                <div class="small text-muted">Projected Annual Spend</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value text-success">KES 15M</div>
                                <div class="small text-muted">Projected Savings</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value text-warning">Q3 2024</div>
                                <div class="small text-muted">Peak Spending Period</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value text-info">87%</div>
                                <div class="small text-muted">Forecast Accuracy</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Key Predictions</h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="fas fa-arrow-up text-success me-2"></i>
                                    <strong>Solar panel demand</strong> expected to increase 25% in Q3
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                    <strong>Cable prices</strong> may increase due to copper market volatility
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-chart-line text-primary me-2"></i>
                                    <strong>Installation services</strong> demand steady with seasonal fluctuations
                                </li>
                                <li class="mb-0">
                                    <i class="fas fa-coins text-success me-2"></i>
                                    <strong>Cost savings opportunities</strong> identified in vendor consolidation
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Recommended Actions</h6>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush">
                                <div class="list-group-item px-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>Negotiate Q3 solar panel contracts early</strong>
                                            <br><small class="text-muted">Secure better pricing before demand peak</small>
                                        </div>
                                        <span class="badge bg-danger">High</span>
                                    </div>
                                </div>
                                <div class="list-group-item px-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>Diversify cable suppliers</strong>
                                            <br><small class="text-muted">Reduce price volatility risk</small>
                                        </div>
                                        <span class="badge bg-warning">Medium</span>
                                    </div>
                                </div>
                                <div class="list-group-item px-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>Review installation service agreements</strong>
                                            <br><small class="text-muted">Optimize capacity planning</small>
                                        </div>
                                        <span class="badge bg-info">Low</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
});

function initializeCharts() {
    // Spending Chart
    const spendingCtx = document.getElementById('spendingChart').getContext('2d');
    new Chart(spendingCtx, {
        type: 'doughnut',
        data: {
            labels: ['Solar Panels', 'Installation Services', 'Inverters & Electronics', 'Cables & Components'],
            datasets: [{
                data: [18.5, 12.3, 8.7, 5.7],
                backgroundColor: ['#4caf50', '#2196f3', '#ff9800', '#9c27b0'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Savings Chart
    const savingsCtx = document.getElementById('savingsChart').getContext('2d');
    new Chart(savingsCtx, {
        type: 'bar',
        data: {
            labels: ['Vendor Negotiations', 'Process Optimization', 'Contract Consolidation', 'Early Payment Discounts'],
            datasets: [{
                label: 'Savings (KES M)',
                data: [1.5, 0.9, 0.8, 0.6],
                backgroundColor: ['#4caf50', '#2196f3', '#17a2b8', '#ffc107'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'KES ' + value + 'M';
                        }
                    }
                }
            }
        }
    });

    // Forecast Chart
    const forecastCtx = document.getElementById('forecastChart').getContext('2d');
    new Chart(forecastCtx, {
        type: 'line',
        data: {
            labels: ['Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan'],
            datasets: [{
                label: 'Projected Spend (KES M)',
                data: [12, 15, 18, 16, 14, 20, 22, 18, 16, 14, 13, 15],
                borderColor: '#38b6ff',
                backgroundColor: 'rgba(56, 182, 255, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'Historical Average',
                data: [13, 14, 15, 15, 16, 17, 18, 17, 16, 15, 14, 13],
                borderColor: '#999',
                backgroundColor: 'transparent',
                borderDash: [5, 5]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'KES ' + value + 'M';
                        }
                    }
                }
            }
        }
    });
}

function updateReports() {
    const timePeriod = document.getElementById('timePeriod').value;
    const category = document.getElementById('categoryFilter').value;
    const vendor = document.getElementById('vendorFilter').value;
    const department = document.getElementById('departmentFilter').value;

    // Show loading state
    console.log('Updating reports with filters:', { timePeriod, category, vendor, department });
    
    // In real implementation, this would make AJAX calls to update the charts and data
    alert('Reports updated with new filters');
}

function resetFilters() {
    document.getElementById('timePeriod').value = 'current_quarter';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('vendorFilter').value = '';
    document.getElementById('departmentFilter').value = '';
    updateReports();
}

function openReport(reportType) {
    // Navigate to specific report or update current view
    const tab = document.querySelector(`#${reportType}-tab`);
    if (tab) {
        tab.click();
    } else {
        console.log('Opening detailed report:', reportType);
        // In real implementation, this might open a dedicated report page
    }
}

function exportReport(format) {
    // Generate and download report in specified format
    console.log('Exporting report in format:', format);
    
    // Simulate download
    const link = document.createElement('a');
    link.href = '#';
    link.download = `procurement_report_${new Date().toISOString().split('T')[0]}.${format}`;
    
    // In real implementation, this would generate actual files
    alert(`Generating ${format.toUpperCase()} report...`);
}

// Auto-refresh reports every 10 minutes
setInterval(function() {
    console.log('Auto-refreshing report data...');
    // In real implementation, this would refresh the data
}, 600000);
</script>
{% endblock %}
