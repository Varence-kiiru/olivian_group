{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Create{% endif %} Purchase Requisition - {{ block.super }}{% endblock %}

{% block page_title %}{% if form.instance.pk %}Edit{% else %}Create{% endif %} Purchase Requisition{% endblock %}
{% block page_subtitle %}Submit internal purchase request for approval{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'procurement:dashboard' %}">Procurement</a></li>
<li class="breadcrumb-item"><a href="{% url 'procurement:requisition_list' %}">Requisitions</a></li>
<li class="breadcrumb-item active">{% if form.instance.pk %}Edit{% else %}Create{% endif %}</li>
{% endblock %}

{% block extra_css %}
<style>
    .requisition-form {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .form-section {
        border-bottom: 1px solid #e0e0e0;
        padding: 2rem;
    }
    
    .form-section:last-child {
        border-bottom: none;
    }
    
    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
    }
    
    .section-title i {
        margin-right: 0.5rem;
        color: var(--primary-color);
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(56, 182, 255, 0.25);
    }
    
    .priority-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }
    
    .priority-low { background: #e8f5e8; color: #2e7d32; }
    .priority-medium { background: #fff3e0; color: #f57c00; }
    .priority-high { background: #ffebee; color: #d32f2f; }
    .priority-urgent { background: #fce4ec; color: #ad1457; }
    
    .item-row {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        position: relative;
    }
    
    .item-counter {
        position: absolute;
        top: -10px;
        left: 15px;
        background: var(--primary-color);
        color: white;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .budget-info {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-left: 4px solid var(--primary-color);
        padding: 1rem;
        border-radius: 0 8px 8px 0;
        margin-top: 1rem;
    }
    
    .justification-box {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .action-buttons {
        background: white;
        padding: 1.5rem;
        border-radius: 0 0 10px 10px;
        border-top: 1px solid #e0e0e0;
        text-align: right;
    }
    
    .floating-total {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: var(--primary-color);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 25px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        font-weight: 600;
    }
    
    .department-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
    }
</style>
{% endblock %}

{% block content %}
<form method="post" class="requisition-form" id="requisitionForm">
    {% csrf_token %}
    
    <!-- Basic Information -->
    <div class="form-section">
        <h6 class="section-title">
            <i class="fas fa-info-circle"></i>
            Basic Information
        </h6>
        
        <div class="row">
            <div class="col-md-8">
                <div class="mb-3">
                    <label for="id_title" class="form-label">Requisition Title *</label>
                    <input type="text" class="form-control" id="id_title" name="title" 
                           value="{{ form.title.value|default:'' }}" required
                           placeholder="e.g., Solar Panel Procurement for Q1 2024">
                    <div class="form-text">Provide a clear, descriptive title for this requisition</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="id_priority" class="form-label">Priority</label>
                    <select class="form-select" id="id_priority" name="priority">
                        <option value="low" {% if form.priority.value == 'low' %}selected{% endif %}>Low</option>
                        <option value="medium" {% if form.priority.value == 'medium' or not form.priority.value %}selected{% endif %}>Medium</option>
                        <option value="high" {% if form.priority.value == 'high' %}selected{% endif %}>High</option>
                        <option value="urgent" {% if form.priority.value == 'urgent' %}selected{% endif %}>Urgent</option>
                    </select>
                    <span id="priorityBadge" class="priority-badge priority-medium">Medium Priority</span>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="id_description" class="form-label">Description</label>
            <textarea class="form-control" id="id_description" name="description" rows="3"
                      placeholder="Detailed description of what needs to be purchased and why">{{ form.description.value|default:'' }}</textarea>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="id_department" class="form-label">Department *</label>
                    <select class="form-select department-select" id="id_department" name="department" required>
                        <option value="">Select Department</option>
                        <option value="Sales" {% if form.department.value == 'Sales' %}selected{% endif %}>Sales</option>
                        <option value="Operations" {% if form.department.value == 'Operations' %}selected{% endif %}>Operations</option>
                        <option value="Installation" {% if form.department.value == 'Installation' %}selected{% endif %}>Installation</option>
                        <option value="Maintenance" {% if form.department.value == 'Maintenance' %}selected{% endif %}>Maintenance</option>
                        <option value="Administration" {% if form.department.value == 'Administration' %}selected{% endif %}>Administration</option>
                        <option value="Finance" {% if form.department.value == 'Finance' %}selected{% endif %}>Finance</option>
                        <option value="IT" {% if form.department.value == 'IT' %}selected{% endif %}>IT</option>
                        <option value="HR" {% if form.department.value == 'HR' %}selected{% endif %}>HR</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="id_required_date" class="form-label">Required Date *</label>
                    <input type="date" class="form-control" id="id_required_date" name="required_date" 
                           value="{{ form.required_date.value|date:'Y-m-d' }}" required>
                    <div class="form-text">When do you need these items?</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Budget Information -->
    <div class="form-section">
        <h6 class="section-title">
            <i class="fas fa-money-bill-wave"></i>
            Budget Information
        </h6>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="id_budget_code" class="form-label">Budget Code</label>
                    <input type="text" class="form-control" id="id_budget_code" name="budget_code" 
                           value="{{ form.budget_code.value|default:'' }}"
                           placeholder="e.g., PROJ-2024-001, OPEX-Q1-2024">
                    <div class="form-text">Reference budget allocation for this purchase</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="id_estimated_total" class="form-label">Estimated Total (KES)</label>
                    <div class="input-group">
                        <span class="input-group-text">KES</span>
                        <input type="number" class="form-control" id="id_estimated_total" name="estimated_total" 
                               value="{{ form.estimated_total.value|default:'' }}" step="0.01" min="0"
                               placeholder="0.00">
                    </div>
                    <div class="form-text">Estimated total cost including taxes</div>
                </div>
            </div>
        </div>
        
        <div class="budget-info">
            <div class="row">
                <div class="col-md-4">
                    <small class="text-muted">Available Budget</small>
                    <div class="fw-bold text-success">KES 1,500,000.00</div>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Committed</small>
                    <div class="fw-bold text-warning">KES 350,000.00</div>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Remaining</small>
                    <div class="fw-bold text-primary">KES 1,150,000.00</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Items Required -->
    <div class="form-section">
        <h6 class="section-title">
            <i class="fas fa-list"></i>
            Items Required
        </h6>
        
        <div id="itemsList">
            <!-- Items will be added here dynamically -->
        </div>
        
        <button type="button" class="btn btn-outline-primary" onclick="addItem()">
            <i class="fas fa-plus me-2"></i>Add Item
        </button>
    </div>
    
    <!-- Justification -->
    <div class="form-section">
        <h6 class="section-title">
            <i class="fas fa-clipboard-check"></i>
            Business Justification
        </h6>
        
        <div class="justification-box">
            <label for="id_justification" class="form-label fw-bold">
                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                Why is this purchase necessary?
            </label>
            <textarea class="form-control" id="id_justification" name="justification" rows="4" required
                      placeholder="Provide detailed business justification for this purchase. Include:
• Business need or problem this addresses
• Impact if not purchased
• Expected benefits or outcomes
• Alternative solutions considered">{{ form.justification.value|default:'' }}</textarea>
            <div class="form-text mt-2">
                <strong>Note:</strong> Detailed justification helps speed up the approval process
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="action-buttons">
        <a href="{% url 'procurement:requisition_list' %}" class="btn btn-outline-secondary me-2">
            <i class="fas fa-times me-2"></i>Cancel
        </a>
        <button type="submit" name="action" value="save_draft" class="btn btn-outline-primary me-2">
            <i class="fas fa-save me-2"></i>Save as Draft
        </button>
        <button type="submit" name="action" value="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane me-2"></i>Submit for Approval
        </button>
    </div>
</form>

<!-- Floating Total -->
<div class="floating-total" id="floatingTotal" style="display: none;">
    <div class="small">Estimated Total</div>
    <div class="h6 mb-0">KES <span id="totalAmount">0.00</span></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let itemCounter = 0;

// Priority badge update
document.getElementById('id_priority').addEventListener('change', function() {
    const priority = this.value;
    const badge = document.getElementById('priorityBadge');
    badge.className = `priority-badge priority-${priority}`;
    badge.textContent = `${priority.charAt(0).toUpperCase() + priority.slice(1)} Priority`;
});

// Add initial item on page load
document.addEventListener('DOMContentLoaded', function() {
    addItem();
    updateTotal();
});

function addItem() {
    itemCounter++;
    const itemsContainer = document.getElementById('itemsList');
    
    const itemRow = document.createElement('div');
    itemRow.className = 'item-row';
    itemRow.id = `item-${itemCounter}`;
    
    itemRow.innerHTML = `
        <div class="item-counter">${itemCounter}</div>
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">Item Name *</label>
                <input type="text" class="form-control" name="items[${itemCounter}][name]" required
                       placeholder="e.g., 400W Solar Panel">
            </div>
            <div class="col-md-8">
                <label class="form-label">Description</label>
                <input type="text" class="form-control" name="items[${itemCounter}][description]"
                       placeholder="Detailed specifications and requirements">
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-3">
                <label class="form-label">Quantity *</label>
                <input type="number" class="form-control item-quantity" name="items[${itemCounter}][quantity]" 
                       required min="1" step="1" value="1" onchange="calculateItemTotal(${itemCounter})">
            </div>
            <div class="col-md-3">
                <label class="form-label">Unit Price (KES)</label>
                <input type="number" class="form-control item-price" name="items[${itemCounter}][unit_price]" 
                       step="0.01" min="0" placeholder="0.00" onchange="calculateItemTotal(${itemCounter})">
            </div>
            <div class="col-md-3">
                <label class="form-label">Total (KES)</label>
                <input type="text" class="form-control item-total" id="item-total-${itemCounter}" readonly>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeItem(${itemCounter})">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-6">
                <label class="form-label">Preferred Vendor</label>
                <input type="text" class="form-control" name="items[${itemCounter}][preferred_vendor]"
                       placeholder="Suggest a preferred supplier">
            </div>
            <div class="col-md-6">
                <label class="form-label">Urgency Notes</label>
                <input type="text" class="form-control" name="items[${itemCounter}][urgency_notes]"
                       placeholder="Any special delivery requirements">
            </div>
        </div>
    `;
    
    itemsContainer.appendChild(itemRow);
    updateTotal();
}

function removeItem(itemId) {
    if (confirm('Remove this item from the requisition?')) {
        const itemRow = document.getElementById(`item-${itemId}`);
        itemRow.remove();
        updateTotal();
        
        // Renumber remaining items
        const remainingItems = document.querySelectorAll('.item-row');
        remainingItems.forEach((item, index) => {
            const counter = item.querySelector('.item-counter');
            if (counter) {
                counter.textContent = index + 1;
            }
        });
    }
}

function calculateItemTotal(itemId) {
    const quantity = document.querySelector(`input[name="items[${itemId}][quantity]"]`).value || 0;
    const price = document.querySelector(`input[name="items[${itemId}][unit_price]"]`).value || 0;
    const total = parseFloat(quantity) * parseFloat(price);
    
    document.getElementById(`item-total-${itemId}`).value = total.toFixed(2);
    updateTotal();
}

function updateTotal() {
    const itemTotals = document.querySelectorAll('.item-total');
    let grandTotal = 0;
    
    itemTotals.forEach(input => {
        const value = parseFloat(input.value) || 0;
        grandTotal += value;
    });
    
    // Update estimated total field
    document.getElementById('id_estimated_total').value = grandTotal.toFixed(2);
    
    // Update floating total
    document.getElementById('totalAmount').textContent = grandTotal.toLocaleString('en-KE', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    
    // Show/hide floating total
    const floatingTotal = document.getElementById('floatingTotal');
    if (grandTotal > 0) {
        floatingTotal.style.display = 'block';
    } else {
        floatingTotal.style.display = 'none';
    }
}

// Form submission handling
document.getElementById('requisitionForm').addEventListener('submit', function(e) {
    const action = e.submitter.value;
    
    if (action === 'submit') {
        if (!confirm('Submit this requisition for approval? You will not be able to edit it afterwards.')) {
            e.preventDefault();
            return false;
        }
    }
    
    // Validate that at least one item is added
    const items = document.querySelectorAll('.item-row');
    if (items.length === 0) {
        alert('Please add at least one item to the requisition.');
        e.preventDefault();
        return false;
    }
    
    // Validate justification for high-value purchases
    const total = parseFloat(document.getElementById('id_estimated_total').value) || 0;
    const justification = document.getElementById('id_justification').value.trim();
    
    if (total > 100000 && justification.length < 100) {
        alert('For purchases over KES 100,000, please provide detailed justification (minimum 100 characters).');
        e.preventDefault();
        return false;
    }
});

// Auto-save draft functionality
let autoSaveInterval;
if (document.getElementById('id_title').value) {
    autoSaveInterval = setInterval(autoSaveDraft, 60000); // Auto-save every minute
}

function autoSaveDraft() {
    // Implementation for auto-saving draft
    console.log('Auto-saving draft...');
}

// Budget code validation
document.getElementById('id_budget_code').addEventListener('blur', function() {
    const budgetCode = this.value.trim();
    if (budgetCode) {
        // Validate budget code format and availability
        validateBudgetCode(budgetCode);
    }
});

function validateBudgetCode(code) {
    // Implementation for budget code validation
    console.log('Validating budget code:', code);
}
</script>
{% endblock %}
