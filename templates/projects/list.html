{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Projects - {{ company.name|default:"Olivian Group" }}{% endblock %}

{% block page_name %}Projects{% endblock %}
{% block page_title %}Projects{% endblock %}
{% block page_subtitle %}Manage all project activities and timelines{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item active">Projects</li>
{% endblock %}

{% block extra_css %}
<style>
    .project-card {
        transition: var(--transition);
        border: none;
        box-shadow: var(--shadow);
        border-radius: var(--border-radius);
        overflow: hidden;
        margin-bottom: 1.5rem;
    }
    
    .project-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    
    .project-status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-planning { background: #e3f2fd; color: #1976d2; }
    .status-in-progress { background: #fff3e0; color: #f57c00; }
    .status-on-hold { background: #ffebee; color: #d32f2f; }
    .status-completed { background: #e8f5e8; color: #388e3c; }
    .status-cancelled { background: #f3e5f5; color: #7b1fa2; }
    
    .progress-wrapper {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 4px;
    }
    
    .progress {
        height: 8px;
        border-radius: 6px;
        background: #e9ecef;
        overflow: hidden;
    }
    
    .filters-section {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow);
    }
    
    .stat-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        text-align: center;
        transition: var(--transition);
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 800;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Beautiful Modal Animations */
    .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
        border-bottom: none;
        border-radius: 12px 12px 0 0;
        padding: 1.5rem;
    }
    
    .modal-body {
        padding: 1.5rem;
        font-size: 1.1rem;
    }
    
    .modal-footer {
        border-top: none;
        padding: 1.5rem;
        justify-content: center;
        gap: 1rem;
    }
    
    /* Beautiful Toast Animations */
    .toast {
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .toast-body {
        padding: 1rem 1.5rem;
        font-weight: 500;
        font-size: 1rem;
    }
    
    /* Smooth animations */
    .modal.fade .modal-dialog {
        transform: translate(0, -50px);
        transition: transform 0.3s ease-out;
    }
    
    .modal.show .modal-dialog {
        transform: translate(0, 0);
    }
    
    .toast {
        animation: slideInRight 0.3s ease-out;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-number">{{ total_projects|default:0 }}</div>
            <div class="stat-label">Total Projects</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-number">{{ active_projects|default:0 }}</div>
            <div class="stat-label">Active Projects</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-number">{{ completed_projects|default:0 }}</div>
            <div class="stat-label">Completed</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-number">KES {{ total_value|floatformat:0|default:0 }}</div>
            <div class="stat-label">Total Value</div>
        </div>
    </div>
</div>

<div class="filters-section">
    <form method="GET" class="row g-3">
        <div class="col-md-3">
            <label for="search" class="form-label">Search Projects</label>
            <input type="text" class="form-control" id="search" name="search" value="{{ request.GET.search }}" placeholder="Project name, number, or client...">
        </div>
        <div class="col-md-2">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status">
                <option value="">All Statuses</option>
                <option value="planning" {% if request.GET.status == 'planning' %}selected{% endif %}>Planning</option>
                <option value="in_progress" {% if request.GET.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                <option value="on_hold" {% if request.GET.status == 'on_hold' %}selected{% endif %}>On Hold</option>
                <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
                <option value="cancelled" {% if request.GET.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="project_manager" class="form-label">Project Manager</label>
            <select class="form-select" id="project_manager" name="project_manager">
                <option value="">All Managers</option>
                {% for manager in project_managers %}
                <option value="{{ manager.id }}" {% if request.GET.project_manager == manager.id|stringformat:"s" %}selected{% endif %}>
                    {{ manager.get_full_name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="sort" class="form-label">Sort By</label>
            <select class="form-select" id="sort" name="sort">
                <option value="-created_at" {% if request.GET.sort == '-created_at' %}selected{% endif %}>Newest First</option>
                <option value="created_at" {% if request.GET.sort == 'created_at' %}selected{% endif %}>Oldest First</option>
                <option value="start_date" {% if request.GET.sort == 'start_date' %}selected{% endif %}>Start Date</option>
                <option value="completion_date" {% if request.GET.sort == 'completion_date' %}selected{% endif %}>Completion Date</option>
                <option value="total_cost" {% if request.GET.sort == 'total_cost' %}selected{% endif %}>Value (Low to High)</option>
                <option value="-total_cost" {% if request.GET.sort == '-total_cost' %}selected{% endif %}>Value (High to Low)</option>
            </select>
        </div>
        <div class="col-md-3 d-flex align-items-end gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search me-1"></i> Filter
            </button>
            <a href="{% url 'projects:list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-times me-1"></i> Clear
            </a>
            {% if user.role in 'super_admin,manager,project_manager' %}
            <a href="{% url 'projects:create' %}" class="btn btn-success">
                <i class="fas fa-plus me-1"></i> New Project
            </a>
            {% endif %}
            {% if user.role in 'super_admin,manager' %}
            <button type="button" class="btn btn-outline-info" onclick="importShowcases()" title="Import Project Showcases from Admin">
                <i class="fas fa-download me-1"></i> Import Showcases
            </button>
            {% endif %}
        </div>
    </form>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-project-diagram me-2"></i>
            Projects List
            {% if projects.paginator.count %}
                <span class="badge bg-primary">{{ projects.paginator.count }} total</span>
            {% endif %}
        </h5>
    </div>
    <div class="card-body p-0">
        {% if projects %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Project</th>
                        <th>Client</th>
                        <th>Manager</th>
                        <th>Progress</th>
                        <th>Status</th>
                        <th>Timeline</th>
                        <th>Value</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                    <tr data-project-id="{{ project.id }}">
                        <td>
                            {% if project.featured_image %}
                                <img src="{{ project.featured_image.url }}" alt="{{ project.name }}" 
                                     style="width: 50px; height: 40px; object-fit: cover; border-radius: 4px;">
                            {% else %}
                                <div style="width: 50px; height: 40px; background: #f8f9fa; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                <strong>{{ project.project_number }}</strong>
                                <br>
                                <small class="text-muted">{{ project.name|truncatechars:30 }}</small>
                            </div>
                        </td>
                        <td>
                            {% if project.client %}
                                <div>
                                    {{ project.client.company_name|default:project.client.name }}
                                    {% if project.client.company_name and project.client.name %}
                                        <br><small class="text-muted">{{ project.client.name }}</small>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span class="text-muted">No client assigned</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if project.project_manager %}
                                {{ project.project_manager.get_full_name }}
                            {% else %}
                                <span class="text-muted">Not assigned</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="progress-wrapper">
                                <div class="progress">
                                    <div class="progress-bar bg-primary" style="width: {{ project.completion_percentage|default:0 }}%"></div>
                                </div>
                                <small class="text-muted">{{ project.completion_percentage|default:0 }}% complete</small>
                            </div>
                        </td>
                        <td>
                            <span class="project-status status-{{ project.status }}">
                                {{ project.get_status_display }}
                            </span>
                        </td>
                        <td>
                            {% if project.start_date %}
                                <small>
                                    <i class="fas fa-play text-success me-1"></i>{{ project.start_date|date:"M d, Y" }}
                                    {% if project.target_completion %}
                                        <br><i class="fas fa-flag text-primary me-1"></i>{{ project.target_completion|date:"M d, Y" }}
                                    {% endif %}
                                </small>
                            {% else %}
                                <span class="text-muted">Not scheduled</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if project.contract_value %}
                                <strong>KES {{ project.contract_value|floatformat:0 }}</strong>
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'projects:detail' project.project_number %}" class="btn btn-outline-primary btn-sm" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if user.role in 'super_admin,manager,project_manager' or user == project.project_manager %}
                                <a href="{% url 'projects:update' project.project_number %}" class="btn btn-outline-secondary btn-sm" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% if project.status != 'completed' %}
                                <button class="btn btn-outline-success btn-sm" title="Mark as Completed" 
                                        onclick="markAsCompleted('{{ project.id }}', '{{ project.name }}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                {% endif %}
                                {% endif %}
                                {% if user.role in 'super_admin,manager' %}
                                <button class="btn btn-outline-danger btn-sm" title="Delete" onclick="deleteProject({{ project.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if projects.has_other_pages %}
        <div class="card-footer">
            <nav aria-label="Projects pagination">
                <ul class="pagination justify-content-center mb-0">
                    {% if projects.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ projects.previous_page_number }}">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                    {% endif %}
                    
                    {% for num in projects.paginator.page_range %}
                        {% if projects.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > projects.number|add:'-3' and num < projects.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if projects.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ projects.next_page_number }}">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-project-diagram fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No projects found</h5>
            <p class="text-muted">{% if request.GET.search %}Try adjusting your search criteria{% else %}Start by creating your first project{% endif %}</p>
            {% if user.role in 'super_admin,manager,project_manager' %}
            <a href="{% url 'projects:create' %}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i> Create Project
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Hidden CSRF token for AJAX requests -->
{% csrf_token %}

<!-- Beautiful Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirm Action
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure you want to proceed?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmButton">
                    <i class="fas fa-check me-1"></i>Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Beautiful Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                <span id="successMessage">Success!</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    
    <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span id="errorMessage">Error occurred!</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    
    <div id="infoToast" class="toast align-items-center text-white bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-info-circle me-2"></i>
                <span id="infoMessage">Information!</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<script>
// Beautiful Toast and Modal Utilities
function showToast(type, message) {
    const toast = document.getElementById(`${type}Toast`);
    const messageElement = document.getElementById(`${type}Message`);
    messageElement.textContent = message;
    
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 4000
    });
    bsToast.show();
}

function showConfirmModal(message, callback) {
    const modal = document.getElementById('confirmModal');
    const messageElement = document.getElementById('confirmMessage');
    const confirmButton = document.getElementById('confirmButton');
    
    messageElement.textContent = message;
    
    // Remove any existing event listeners
    const newButton = confirmButton.cloneNode(true);
    confirmButton.parentNode.replaceChild(newButton, confirmButton);
    
    // Add new event listener
    newButton.addEventListener('click', () => {
        const bsModal = bootstrap.Modal.getInstance(modal);
        bsModal.hide();
        callback();
    });
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

function deleteProject(projectId) {
    showConfirmModal(
        'Are you sure you want to delete this project? This action cannot be undone and all project data will be permanently lost.',
        () => {
            // Get CSRF token
            const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfTokenElement) {
                showToast('error', 'Security token not found. Please refresh the page and try again.');
                return;
            }
        
        fetch(`/projects/api/${projectId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfTokenElement.value,
                'Content-Type': 'application/json',
            },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the row from the table
                    const row = document.querySelector(`tr[data-project-id="${projectId}"]`);
                    if (row) {
                        row.remove();
                    }
                    // Update counters
                    updateProjectCounters();
                    showToast('success', data.message || 'Project deleted successfully.');
                } else {
                    showToast('error', data.message || 'Error deleting project. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Error deleting project. Please try again.');
            });
        }
    );
}

function markAsCompleted(projectId, projectName) {
    showConfirmModal(
        `Are you sure you want to mark "${projectName}" as completed? This will set the project status to completed and completion percentage to 100%.`,
        () => {
            // Get CSRF token
            const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfTokenElement) {
                showToast('error', 'Security token not found. Please refresh the page and try again.');
                return;
            }
            
            fetch(`/projects/api/${projectId}/complete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfTokenElement.value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Refresh the page to show updated status
                    location.reload();
                } else {
                    showToast('error', data.message || 'Error marking project as completed. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Error marking project as completed. Please try again.');
            });
        }
    );
}

function updateProjectCounters() {
    // Recalculate project counts after deletion
    const rows = document.querySelectorAll('tbody tr');
    const totalProjects = rows.length;
    
    // Count completed projects by checking badge text content
    let completedProjects = 0;
    rows.forEach(row => {
        const statusBadge = row.querySelector('.project-status');
        if (statusBadge && statusBadge.textContent.trim().toLowerCase().includes('completed')) {
            completedProjects++;
        }
    });
    
    // Update the stat cards if they exist
    const statsCards = document.querySelectorAll('.stat-card .stat-number');
    if (statsCards.length >= 3) {
        statsCards[0].textContent = totalProjects; // Total projects
        statsCards[2].textContent = completedProjects; // Completed projects
    }
}

function importShowcases() {
    showConfirmModal(
        'This will import all Project Showcases from the admin panel into Project Management. This action will create new projects and customers. Continue?',
        () => {
        // Show loading state
        const btn = document.querySelector('button[onclick="importShowcases()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Importing...';
        btn.disabled = true;
        
            // Get CSRF token
            const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfTokenElement) {
                showToast('error', 'Security token not found. Please refresh the page and try again.');
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }
        
        fetch('/projects/import-showcases/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfTokenElement.value,
                'Content-Type': 'application/json',
            },
            })
            .then(response => response.json())
            .then(data => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                if (data.success) {
                    showToast('success', data.message);
                    // Reload the page to show new projects after a short delay
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showToast('error', data.message || 'Error importing projects. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
                showToast('error', 'Error importing projects. Please try again.');
            });
        }
    );
}

// Auto-submit form on select change
document.querySelectorAll('#status, #project_manager, #sort').forEach(select => {
    select.addEventListener('change', function() {
        this.form.submit();
    });
});
</script>
{% endblock %}
