{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{{ project.project_number }} - {{ company.name|default:"Olivian Group" }}{% endblock %}

{% block page_name %}Project Details{% endblock %}
{% block page_title %}{{ project.project_number }}{% endblock %}
{% block page_subtitle %}{{ project.name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'projects:list' %}">Projects</a></li>
<li class="breadcrumb-item active">{{ project.project_number }}</li>
{% endblock %}

{% block extra_css %}
<style>
    .project-header {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .project-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: translate(50px, -50px);
    }
    
    .project-status {
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        display: inline-block;
    }
    
    .status-planning { background: #e3f2fd; color: #1976d2; }
    .status-in-progress { background: #fff3e0; color: #f57c00; }
    .status-on-hold { background: #ffebee; color: #d32f2f; }
    .status-completed { background: #e8f5e8; color: #388e3c; }
    .status-cancelled { background: #f3e5f5; color: #7b1fa2; }
    
    .progress-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 1.5rem;
    }
    
    .progress-bar-custom {
        height: 12px;
        border-radius: 6px;
        background: #e9ecef;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
        border-radius: 6px;
        transition: width 0.3s ease;
    }
    
    .info-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 1.5rem;
        height: 100%;
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 600;
        color: #666;
    }
    
    .info-value {
        color: #333;
        text-align: right;
    }
    
    .timeline-container {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
    }
    
    .timeline {
        position: relative;
        padding-left: 2rem;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 1rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e9ecef;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
        padding-left: 1rem;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -1.75rem;
        top: 0.5rem;
        width: 12px;
        height: 12px;
        background: var(--primary-color);
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 0 0 2px var(--primary-color);
    }
    
    .timeline-item.completed::before {
        background: var(--success-color);
        box-shadow: 0 0 0 2px var(--success-color);
    }
    
    .timeline-date {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 0.25rem;
    }
    
    .timeline-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .timeline-content {
        font-size: 0.9rem;
        color: #666;
    }
    
    .task-item {
        background: #f8f9fa;
        border-left: 4px solid var(--primary-color);
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0 var(--border-radius) var(--border-radius) 0;
    }
    
    .task-item.completed {
        border-left-color: var(--success-color);
        background: #f0f9f0;
    }
    
    .task-item.overdue {
        border-left-color: var(--danger-color);
        background: #fff5f5;
    }
    
    .expense-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: var(--border-radius);
        margin-bottom: 0.5rem;
    }
    
    .expense-approved {
        background: #f0f9f0;
    }
    
    .expense-pending {
        background: #fff8e1;
    }
    
    .tab-content {
        padding: 1.5rem 0;
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #666;
        font-weight: 500;
        padding: 1rem 1.5rem;
    }
    
    .nav-tabs .nav-link.active {
        background: var(--primary-color);
        color: white;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }
    
    .document-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: var(--border-radius);
        margin-bottom: 0.5rem;
    }
    
    .document-icon {
        width: 40px;
        height: 40px;
        background: var(--primary-color);
        color: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Project Header -->
<div class="project-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h2 class="mb-2">{{ project.name }}</h2>
            <p class="mb-3 opacity-75">{{ project.description|default:"No description provided" }}</p>
            <div class="d-flex align-items-center gap-3">
                <span class="project-status status-{{ project.status }}">{{ project.get_status_display }}</span>
                {% if project.client %}
                <span><i class="fas fa-building me-1"></i> {{ project.client.company_name|default:project.client.name }}</span>
                {% endif %}
                {% if project.project_manager %}
                <span><i class="fas fa-user me-1"></i> {{ project.project_manager.get_full_name }}</span>
                {% endif %}
            </div>
        </div>
        <div class="col-md-4 text-md-end">
            {% if user.role in 'super_admin,manager,project_manager' or user == project.project_manager %}
            <a href="{% url 'projects:update' project.project_number %}" class="btn btn-light me-2">
                <i class="fas fa-edit me-1"></i> Edit Project
            </a>
            {% endif %}
            <button class="btn btn-outline-light" onclick="window.print()">
                <i class="fas fa-print me-1"></i> Print
            </button>
        </div>
    </div>
</div>

<!-- Progress Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="progress-card">
            <h6 class="mb-3"><i class="fas fa-tasks me-2"></i>Overall Progress</h6>
            <div class="progress-bar-custom">
                <div class="progress-fill" style="width: {{ project.completion_percentage|default:0 }}%"></div>
            </div>
            <div class="text-center mt-2">
                <strong>{{ project.completion_percentage|default:0 }}% Complete</strong>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="progress-card">
            <h6 class="mb-3"><i class="fas fa-hammer me-2"></i>Installation Progress</h6>
            <div class="progress-bar-custom">
                <div class="progress-fill" style="width: {{ project.completion_percentage|default:0 }}%"></div>
            </div>
            <div class="text-center mt-2">
                <strong>{{ project.completion_percentage|default:0 }}% Complete</strong>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="progress-card">
            <h6 class="mb-3"><i class="fas fa-clock me-2"></i>Timeline</h6>
            <div class="text-center">
                {% if project.status == 'completed' %}
                    <div class="text-success">
                        <i class="fas fa-check-circle"></i> Completed
                        {% if project.actual_completion %}
                            <br><small class="text-muted">{{ project.actual_completion|date:"M d, Y" }}</small>
                        {% endif %}
                    </div>
                {% elif project.start_date and project.target_completion %}
                    {% now "Y-m-d" as today %}
                    {% if project.target_completion|date:"Y-m-d" < today %}
                        <div class="text-danger">
                            <i class="fas fa-exclamation-triangle"></i> Overdue
                            <br><small class="text-muted">Due: {{ project.target_completion|date:"M d, Y" }}</small>
                        </div>
                    {% elif project.start_date|date:"Y-m-d" <= today and project.target_completion|date:"Y-m-d" >= today %}
                        <div class="text-warning">
                            <i class="fas fa-clock"></i> In Progress
                            <br><small class="text-muted">Due: {{ project.target_completion|date:"M d, Y" }}</small>
                        </div>
                    {% else %}
                        <div class="text-info">
                            <i class="fas fa-calendar"></i> Scheduled
                            <br><small class="text-muted">Starts: {{ project.start_date|date:"M d, Y" }}</small>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-muted">Not Scheduled</div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="progress-card">
            <h6 class="mb-3"><i class="fas fa-money-bill-wave me-2"></i>Budget</h6>
            <div class="text-center">
                {% if project.contract_value %}
                    <strong>KES {{ project.contract_value|floatformat:0 }}</strong>
                    {% if project.actual_cost %}
                        <br><small class="text-muted">Spent: KES {{ project.actual_cost|floatformat:0 }}</small>
                    {% endif %}
                {% else %}
                    <div class="text-muted">Not Set</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Main Content Tabs -->
<div class="card">
    <div class="card-header p-0">
        <ul class="nav nav-tabs" id="projectTabs">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview">
                    <i class="fas fa-info-circle me-1"></i> Overview
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tasks">
                    <i class="fas fa-tasks me-1"></i> Tasks
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#timeline">
                    <i class="fas fa-history me-1"></i> Timeline
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#expenses">
                    <i class="fas fa-receipt me-1"></i> Expenses
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#documents">
                    <i class="fas fa-file-alt me-1"></i> Documents
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview">
                {% if project.featured_image %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="info-card">
                            <h6 class="mb-3"><i class="fas fa-image me-2"></i>Project Image</h6>
                            <div class="text-center">
                                <img src="{{ project.featured_image.url }}" alt="{{ project.name }}" 
                                     class="img-fluid rounded shadow" style="max-height: 400px; max-width: 100%;">
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-card">
                            <h6 class="mb-3"><i class="fas fa-user me-2"></i>Client Information</h6>
                            {% if project.client %}
                            <div class="info-item">
                                <span class="info-label">Company:</span>
                                <span class="info-value">{{ project.client.company_name|default:"N/A" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Contact:</span>
                                <span class="info-value">{{ project.client.name }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Email:</span>
                                <span class="info-value">{{ project.client.email|default:"N/A" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Phone:</span>
                                <span class="info-value">{{ project.client.phone|default:"N/A" }}</span>
                            </div>
                            {% else %}
                            <p class="text-muted">No client assigned</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-card">
                            <h6 class="mb-3"><i class="fas fa-cog me-2"></i>System Details</h6>
                            <div class="info-item">
                                <span class="info-label">System Capacity:</span>
                                <span class="info-value">{{ project.system_capacity|default:"N/A" }} kW</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">System Type:</span>
                                <span class="info-value">{{ project.get_system_type_display|default:"N/A" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Project Type:</span>
                                <span class="info-value">{{ project.get_project_type_display|default:"N/A" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Priority:</span>
                                <span class="info-value">{{ project.get_priority_display|default:"Medium" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Estimated Generation:</span>
                                <span class="info-value">{{ project.estimated_generation|default:"N/A" }} kWh/month</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="info-card">
                            <h6 class="mb-3"><i class="fas fa-map-marker-alt me-2"></i>Location</h6>
                            <div class="info-item">
                                <span class="info-label">Installation Address:</span>
                                <span class="info-value">{{ project.installation_address|default:"N/A" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">City:</span>
                                <span class="info-value">{{ project.city|default:"N/A" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">County:</span>
                                <span class="info-value">{{ project.county|default:"N/A" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">GPS Coordinates:</span>
                                <span class="info-value">
                                    {% if project.latitude and project.longitude %}
                                        {{ project.latitude }}, {{ project.longitude }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-card">
                            <h6 class="mb-3"><i class="fas fa-calendar me-2"></i>Timeline</h6>
                            <div class="info-item">
                                <span class="info-label">Start Date:</span>
                                <span class="info-value">{{ project.start_date|date:"M d, Y"|default:"Not set" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Target Completion:</span>
                                <span class="info-value">{{ project.target_completion|date:"M d, Y"|default:"Not set" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Actual Completion:</span>
                                <span class="info-value">{{ project.actual_completion|date:"M d, Y"|default:"Not completed" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Duration:</span>
                                <span class="info-value">{{ project.duration_days|default:"N/A" }} days</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="info-card">
                            <h6 class="mb-3"><i class="fas fa-money-bill-wave me-2"></i>Financial Information</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="info-item">
                                        <span class="info-label">Contract Value:</span>
                                        <span class="info-value">KES {{ project.contract_value|floatformat:0|default:"N/A" }}</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="info-item">
                                        <span class="info-label">Estimated Cost:</span>
                                        <span class="info-value">KES {{ project.estimated_cost|floatformat:0|default:"N/A" }}</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="info-item">
                                        <span class="info-label">Actual Cost:</span>
                                        <span class="info-value">KES {{ project.actual_cost|floatformat:0|default:"0" }}</span>
                                    </div>
                                </div>
                            </div>
                            {% if project.contract_value and project.estimated_cost %}
                            <div class="mt-2">
                                <div class="info-item">
                                    <span class="info-label">Profit Margin:</span>
                                    <span class="info-value">{{ project.profit_margin|floatformat:1|default:"0" }}%</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tasks Tab -->
            <div class="tab-pane fade" id="tasks">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6><i class="fas fa-tasks me-2"></i>Project Tasks</h6>
                    {% if user.role in 'super_admin,manager,project_manager' or user == project.project_manager %}
                    <button class="btn btn-primary btn-sm" onclick="addTask()">
                        <i class="fas fa-plus me-1"></i> Add Task
                    </button>
                    {% endif %}
                </div>
                
                {% if project.tasks.all %}
                    {% for task in project.tasks.all %}
                    <div class="task-item {% if task.status == 'completed' %}completed{% elif task.due_date and task.due_date < today and task.status != 'completed' %}overdue{% endif %}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ task.task_name }}</h6>
                                <p class="mb-2 text-muted">{{ task.description|default:"No description" }}</p>
                                <small class="text-muted">
                                    {% if task.assigned_to %}
                                        <i class="fas fa-user me-1"></i>{{ task.assigned_to.get_full_name }}
                                    {% endif %}
                                    {% if task.due_date %}
                                        <i class="fas fa-calendar ms-3 me-1"></i>{{ task.due_date|date:"M d, Y" }}
                                    {% endif %}
                                </small>
                            </div>
                            <span class="badge bg-{{ task.status|yesno:'success,warning,primary' }}">
                                {{ task.get_status_display }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-tasks fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No tasks created yet</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- Timeline Tab -->
            <div class="tab-pane fade" id="timeline">
                <h6 class="mb-3"><i class="fas fa-history me-2"></i>Project Timeline</h6>
                
                <div class="timeline">
                    {% if project.updates.all %}
                        {% for update in project.updates.all %}
                        <div class="timeline-item">
                            <div class="timeline-date">{{ update.created_at|date:"M d, Y - g:i A" }}</div>
                            <div class="timeline-title">{{ update.title }}</div>
                            <div class="timeline-content">{{ update.description }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-history fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No timeline updates yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Expenses Tab -->
            <div class="tab-pane fade" id="expenses">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6><i class="fas fa-receipt me-2"></i>Project Expenses</h6>
                    {% if user.role in 'super_admin,manager,project_manager' or user == project.project_manager %}
                    <button class="btn btn-primary btn-sm" onclick="addExpense()">
                        <i class="fas fa-plus me-1"></i> Add Expense
                    </button>
                    {% endif %}
                </div>
                
                {% if project.expenses.all %}
                    {% for expense in project.expenses.all %}
                    <div class="expense-item expense-{{ expense.status }}">
                        <div>
                            <strong>{{ expense.description }}</strong>
                            <br>
                            <small class="text-muted">{{ expense.expense_date|date:"M d, Y" }} - {{ expense.category }}</small>
                        </div>
                        <div class="text-end">
                            <strong>KES {{ expense.amount|floatformat:0 }}</strong>
                            <br>
                            <small class="badge bg-{{ expense.status|yesno:'success,warning,danger' }}">
                                {{ expense.get_status_display }}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="mt-3 p-3 bg-light rounded">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Total Expenses:</strong>
                                <br>KES {{ project.expenses.all|length|default:0 }}
                            </div>
                            <div class="col-md-4">
                                <strong>Approved:</strong>
                                <br>KES {{ project.total_approved_expenses|default:0 }}
                            </div>
                            <div class="col-md-4">
                                <strong>Pending:</strong>
                                <br>KES {{ project.total_pending_expenses|default:0 }}
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-receipt fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No expenses recorded yet</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- Documents Tab -->
            <div class="tab-pane fade" id="documents">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6><i class="fas fa-file-alt me-2"></i>Project Documents</h6>
                    {% if user.role in 'super_admin,manager,project_manager' or user == project.project_manager %}
                    <button class="btn btn-primary btn-sm" onclick="uploadDocument()">
                        <i class="fas fa-upload me-1"></i> Upload Document
                    </button>
                    {% endif %}
                </div>
                
                {% if project.documents.all %}
                    {% for document in project.documents.all %}
                    <div class="document-item">
                        <div class="document-icon">
                            <i class="fas fa-file"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">{{ document.title }}</h6>
                            <p class="mb-1 text-muted">{{ document.description|default:"No description" }}</p>
                            <small class="text-muted">
                                Uploaded {{ document.uploaded_at|date:"M d, Y" }}
                                {% if document.uploaded_by %}
                                    by {{ document.uploaded_by.get_full_name }}
                                {% endif %}
                            </small>
                        </div>
                        <div>
                            <a href="{{ document.file.url }}" class="btn btn-outline-primary btn-sm" target="_blank">
                                <i class="fas fa-download me-1"></i> Download
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-file-alt fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No documents uploaded yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function addTask() {
    // Implementation for adding task
    alert('Add task functionality to be implemented');
}

function addExpense() {
    // Implementation for adding expense
    alert('Add expense functionality to be implemented');
}

function uploadDocument() {
    // Implementation for uploading document
    alert('Upload document functionality to be implemented');
}

// Auto-refresh progress bars
function animateProgressBars() {
    document.querySelectorAll('.progress-fill').forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, 100);
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    animateProgressBars();
});
</script>
{% endblock %}
