{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Stock Adjustment {{ adjustment.adjustment_number }} - Inventory Management{% endblock %}

{% block extra_css %}
<style>
    .detail-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
    }
    
    .detail-header {
        background: linear-gradient(135deg, #38b6ff 0%, #2c9ce6 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px 12px 0 0;
    }
    
    .detail-body {
        padding: 1.5rem;
    }
    
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .status-approved {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .info-item {
        margin-bottom: 1rem;
    }
    
    .info-label {
        font-weight: 600;
        color: #6c757d;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .info-value {
        font-size: 1.1rem;
        color: #2c3e50;
        margin-top: 0.25rem;
    }
    
    .items-table {
        margin-top: 1.5rem;
    }
    
    .table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .adjustment-positive {
        color: #28a745;
        font-weight: 600;
    }
    
    .adjustment-negative {
        color: #dc3545;
        font-weight: 600;
    }
    
    .btn-group .btn {
        border-radius: 8px;
        font-weight: 600;
        padding: 0.5rem 1rem;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #38b6ff 0%, #2c9ce6 100%);
        border: none;
    }
    
    .summary-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-edit text-primary"></i>
                Stock Adjustment {{ adjustment.adjustment_number }}
            </h1>
            <nav aria-label="breadcrumb" class="mt-2">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Inventory</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'inventory:adjustment_list' %}">Stock Adjustments</a></li>
                    <li class="breadcrumb-item active">{{ adjustment.adjustment_number }}</li>
                </ol>
            </nav>
        </div>
        <div class="btn-group">
            <a href="{% url 'inventory:adjustment_edit' adjustment.pk %}" class="btn btn-primary">
                <i class="fas fa-edit"></i> Edit
            </a>
            <a href="{% url 'inventory:adjustment_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <!-- Adjustment Details -->
        <div class="col-lg-8">
            <div class="detail-card">
                <div class="detail-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-1">{{ adjustment.adjustment_number }}</h4>
                            <p class="mb-0 opacity-75">{{ adjustment.get_adjustment_type_display }}</p>
                        </div>
                        <div class="text-end">
                            {% if adjustment.approved %}
                                <span class="status-badge status-approved">
                                    <i class="fas fa-check"></i> Approved
                                </span>
                            {% else %}
                                <span class="status-badge status-pending">
                                    <i class="fas fa-clock"></i> Pending Approval
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="detail-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item">
                                <div class="info-label">Warehouse</div>
                                <div class="info-value">
                                    <i class="fas fa-warehouse text-primary"></i>
                                    {{ adjustment.warehouse.name }}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <div class="info-label">Adjustment Date</div>
                                <div class="info-value">
                                    <i class="fas fa-calendar text-primary"></i>
                                    {{ adjustment.adjustment_date|date:"M d, Y" }}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <div class="info-label">Performed By</div>
                                <div class="info-value">
                                    <i class="fas fa-user text-primary"></i>
                                    {{ adjustment.performed_by.get_full_name }}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <div class="info-label">Created</div>
                                <div class="info-value">
                                    <i class="fas fa-clock text-primary"></i>
                                    {{ adjustment.created_at|date:"M d, Y H:i" }}
                                </div>
                            </div>
                        </div>
                        {% if adjustment.approved %}
                        <div class="col-md-6">
                            <div class="info-item">
                                <div class="info-label">Approved By</div>
                                <div class="info-value">
                                    <i class="fas fa-check-circle text-success"></i>
                                    {{ adjustment.approved_by.get_full_name }}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <div class="info-label">Approved Date</div>
                                <div class="info-value">
                                    <i class="fas fa-calendar-check text-success"></i>
                                    {{ adjustment.approved_date|date:"M d, Y H:i" }}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        <div class="col-12">
                            <div class="info-item">
                                <div class="info-label">Reason</div>
                                <div class="info-value">{{ adjustment.reason }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Adjustment Items -->
            <div class="detail-card">
                <div class="detail-body">
                    <h5 class="mb-3">
                        <i class="fas fa-list text-primary"></i>
                        Adjustment Items
                    </h5>
                    
                    {% if items %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>System Qty</th>
                                        <th>Actual Qty</th>
                                        <th>Adjustment</th>
                                        <th>Value Impact</th>
                                        <th>Reason</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in items %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div>
                                                    <div class="fw-bold">{{ item.inventory_item.product.name }}</div>
                                                    <small class="text-muted">{{ item.inventory_item.product.sku }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ item.system_quantity|floatformat:2 }}</td>
                                        <td>{{ item.actual_quantity|floatformat:2 }}</td>
                                        <td>
                                            {% if item.adjustment_quantity > 0 %}
                                                <span class="adjustment-positive">
                                                    +{{ item.adjustment_quantity|floatformat:2 }}
                                                </span>
                                            {% elif item.adjustment_quantity < 0 %}
                                                <span class="adjustment-negative">
                                                    {{ item.adjustment_quantity|floatformat:2 }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">0.00</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% widthratio item.adjustment_quantity 1 item.inventory_item.average_cost as value %}
                                                {% if value > 0 %}
                                                    <span class="adjustment-positive">
                                                        +KES {{ value|floatformat:2 }}
                                                    </span>
                                                {% elif value < 0 %}
                                                    <span class="adjustment-negative">
                                                        KES {{ value|floatformat:2 }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">KES 0.00</span>
                                                {% endif %}
                                        </td>
                                        <td>
                                            {% if item.reason %}
                                                {{ item.reason }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No adjustment items found.</p>
                            {% if not adjustment.approved %}
                                <a href="{% url 'inventory:adjustment_edit' adjustment.pk %}" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Add Items
                                </a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Summary Sidebar -->
        <div class="col-lg-4">
            <!-- Summary Card -->
            <div class="detail-card">
                <div class="detail-body">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-bar text-primary"></i>
                        Adjustment Summary
                    </h5>
                    
                    <div class="summary-card">
                        <div class="d-flex justify-content-between">
                            <span>Total Items:</span>
                            <strong>{{ items.count }}</strong>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="d-flex justify-content-between">
                            <span>Total Value Impact:</span>
                            <strong class="{% if total_adjustment_value > 0 %}adjustment-positive{% elif total_adjustment_value < 0 %}adjustment-negative{% endif %}">
                                KES {{ total_adjustment_value|default:0|floatformat:2 }}
                            </strong>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="d-flex justify-content-between">
                            <span>Status:</span>
                            {% if adjustment.approved %}
                                <span class="badge bg-success">Approved</span>
                            {% else %}
                                <span class="badge bg-warning">Pending</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions Card -->
            <div class="detail-card">
                <div class="detail-body">
                    <h5 class="mb-3">
                        <i class="fas fa-cogs text-primary"></i>
                        Actions
                    </h5>
                    
                    <div class="d-grid gap-2">
                        <a href="{% url 'inventory:adjustment_edit' adjustment.pk %}" class="btn btn-primary">
                            <i class="fas fa-edit"></i> Edit Adjustment
                        </a>
                        
                        {% if not adjustment.approved %}
                            <button type="button" class="btn btn-success" onclick="approveAdjustment()">
                                <i class="fas fa-check"></i> Approve Adjustment
                            </button>
                        {% endif %}
                        
                        <a href="{% url 'inventory:adjustment_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-list"></i> View All Adjustments
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function approveAdjustment() {
    if (confirm('Are you sure you want to approve this adjustment? This action cannot be undone.')) {
        // This would typically be handled by a form or AJAX call
        // For now, redirect to edit page where approval can be set
        window.location.href = '{% url "inventory:adjustment_edit" adjustment.pk %}';
    }
}
</script>
{% endblock %}
