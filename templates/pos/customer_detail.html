{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{{ customer.name }} - Customer Details - {{ block.super }}{% endblock %}

{% block page_title %}Customer Details{% endblock %}
{% block page_subtitle %}{{ customer.name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'pos:main' %}">POS System</a></li>
<li class="breadcrumb-item"><a href="{% url 'pos:customer_list' %}">Customers</a></li>
<li class="breadcrumb-item active">{{ customer.name }}</li>
{% endblock %}

{% block extra_css %}
<link href="{% static 'css/pos.css' %}" rel="stylesheet">
<link href="{% static 'css/customers.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<!-- Customer Header -->
<div class="customer-header">
    <div class="d-flex align-items-center">
        <div class="customer-avatar">
            {{ customer.name|first|upper|default:"?" }}
        </div>
        <div class="flex-grow-1">
            <h2 class="mb-1">{{ customer.name|default:"Unknown Customer" }}</h2>
            <p class="mb-0 opacity-75">
                {% if customer.company_name %}
                    {{ customer.company_name }} •
                {% endif %}
                Customer since {{ customer.created_at|date:"M Y" }}
            </p>
        </div>
        <div class="text-end">
            <button class="btn btn-light me-2" onclick="editCustomer({{ customer.id }})">
                <i class="fas fa-edit me-1"></i>Edit Customer
            </button>
            <button class="btn btn-outline-light" onclick="selectCustomerForSale({{ customer.id }}, '{{ customer.name|escapejs }}')">
                <i class="fas fa-shopping-cart me-1"></i>Select for Sale
            </button>
        </div>
    </div>
</div>

<!-- Statistics Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ customer.purchase_count|default:0 }}</div>
            <div class="stat-label">Total Purchases</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">KES {{ customer.total_spent|floatformat:2|default:"0.00" }}</div>
            <div class="stat-label">Total Spent</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ customer.loyalty_points|default:0 }}</div>
            <div class="stat-label">Loyalty Points</div>
            <div class="small text-muted mt-1">{{ customer.loyalty_tier|default:"Bronze" }} Member</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">
                {% if customer.last_purchase_date %}
                    {{ customer.last_purchase_date|timesince }} ago
                {% else %}
                    Never
                {% endif %}
            </div>
            <div class="stat-label">Last Purchase</div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Customer Information -->
    <div class="col-md-6">
        <div class="info-card">
            <h5 class="mb-3">
                <i class="fas fa-user me-2"></i>Contact Information
            </h5>

            <div class="row mb-3">
                <div class="col-sm-4"><strong>Name:</strong></div>
                <div class="col-sm-8">{{ customer.name|default:"Not provided" }}</div>
            </div>

            {% if customer.email %}
            <div class="row mb-3">
                <div class="col-sm-4"><strong>Email:</strong></div>
                <div class="col-sm-8">
                    <a href="mailto:{{ customer.email }}">{{ customer.email }}</a>
                </div>
            </div>
            {% endif %}

            {% if customer.phone %}
            <div class="row mb-3">
                <div class="col-sm-4"><strong>Phone:</strong></div>
                <div class="col-sm-8">
                    <a href="tel:{{ customer.phone }}">{{ customer.phone }}</a>
                </div>
            </div>
            {% endif %}

            {% if customer.address %}
            <div class="row mb-3">
                <div class="col-sm-4"><strong>Address:</strong></div>
                <div class="col-sm-8">{{ customer.address }}</div>
            </div>
            {% endif %}

            {% if customer.city %}
            <div class="row mb-3">
                <div class="col-sm-4"><strong>City:</strong></div>
                <div class="col-sm-8">{{ customer.city }}</div>
            </div>
            {% endif %}

            {% if customer.country %}
            <div class="row mb-3">
                <div class="col-sm-4"><strong>Country:</strong></div>
                <div class="col-sm-8">{{ customer.country }}</div>
            </div>
            {% endif %}
        </div>

        {% if customer.company_name or customer.business_type or customer.tax_number %}
        <div class="info-card">
            <h5 class="mb-3">
                <i class="fas fa-building me-2"></i>Business Information
            </h5>

            {% if customer.company_name %}
            <div class="row mb-3">
                <div class="col-sm-4"><strong>Company:</strong></div>
                <div class="col-sm-8">{{ customer.company_name }}</div>
            </div>
            {% endif %}

            {% if customer.business_type %}
            <div class="row mb-3">
                <div class="col-sm-4"><strong>Business Type:</strong></div>
                <div class="col-sm-8">{{ customer.get_business_type_display|default:customer.business_type }}</div>
            </div>
            {% endif %}

            {% if customer.tax_number %}
            <div class="row mb-3">
                <div class="col-sm-4"><strong>Tax Number:</strong></div>
                <div class="col-sm-8">{{ customer.tax_number }}</div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if customer.monthly_consumption or customer.roof_area %}
        <div class="info-card">
            <h5 class="mb-3">
                <i class="fas fa-solar-panel me-2"></i>Solar Interest
            </h5>

            {% if customer.monthly_consumption %}
            <div class="row mb-3">
                <div class="col-sm-5"><strong>Monthly Usage:</strong></div>
                <div class="col-sm-7">{{ customer.monthly_consumption }} kWh</div>
            </div>
            {% endif %}

            {% if customer.average_monthly_bill %}
            <div class="row mb-3">
                <div class="col-sm-5"><strong>Avg. Monthly Bill:</strong></div>
                <div class="col-sm-7">KES {{ customer.average_monthly_bill|floatformat:2 }}</div>
            </div>
            {% endif %}

            {% if customer.roof_area %}
            <div class="row mb-3">
                <div class="col-sm-5"><strong>Roof Area:</strong></div>
                <div class="col-sm-7">{{ customer.roof_area }} m²</div>
            </div>
            {% endif %}

            {% if customer.roof_type %}
            <div class="row mb-3">
                <div class="col-sm-5"><strong>Roof Type:</strong></div>
                <div class="col-sm-7">{{ customer.roof_type|title }}</div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Purchase History -->
    <div class="col-md-6">
        <div class="info-card">
            <h5 class="mb-3">
                <i class="fas fa-history me-2"></i>Purchase History
            </h5>

            {% if customer.sales.exists %}
                {% for sale in customer.sales.all|slice:":10" %}
                <div class="purchase-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <strong>{{ sale.receipt_number|default:sale.id }}</strong>
                            <div class="small text-muted">
                                {{ sale.created_at|date:"M d, Y g:i A" }}
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">KES {{ sale.total_amount|floatformat:2|default:sale.grand_total|floatformat:2 }}</div>
                            <span class="badge bg-success">{{ sale.get_status_display|default:"Completed" }}</span>
                        </div>
                    </div>

                    {% if sale.items.exists %}
                    <div class="small text-muted">
                        {{ sale.items.count }} item{{ sale.items.count|pluralize }}
                        {% if sale.payment_method %}
                            • {{ sale.get_payment_method_display|default:sale.payment_method }}
                        {% endif %}
                    </div>
                    {% endif %}

                    <div class="mt-2">
                        <a href="{% url 'pos:sale_detail' sale.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye me-1"></i>View Details
                        </a>
                        <a href="{% url 'pos:print_receipt' sale.id %}" class="btn btn-sm btn-outline-secondary" target="_blank">
                            <i class="fas fa-print me-1"></i>Print Receipt
                        </a>
                    </div>
                </div>
                {% endfor %}

                {% if customer.sales.count > 10 %}
                <div class="text-center mt-3">
                    <a href="{% url 'pos:sale_list' %}?customer={{ customer.id }}" class="btn btn-outline-primary">
                        <i class="fas fa-list me-1"></i>View All {{ customer.sales.count }} Purchases
                    </a>
                </div>
                {% endif %}
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-shopping-cart fa-2x text-muted mb-3"></i>
                    <p class="text-muted">No purchases yet</p>
                    <button class="btn btn-primary" onclick="selectCustomerForSale({{ customer.id }}, '{{ customer.name|escapejs }}')">
                        <i class="fas fa-plus me-1"></i>Create First Sale
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Edit Customer Modal -->
<div class="modal fade" id="editCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit me-2"></i>Edit Customer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCustomerForm">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- Basic Information -->
                    <div class="row">
                        <div class="col-12 mb-4">
                            <h6 class="text-muted border-bottom pb-2">
                                <i class="fas fa-info-circle me-1"></i>Basic Information
                            </h6>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="first_name" id="first_name_edit" required>
                            <div class="invalid-feedback">First name is required.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="last_name" id="last_name_edit" required>
                            <div class="invalid-feedback">Last name is required.</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" name="email" value="{{ customer.email }}" required>
                            <div class="invalid-feedback">Valid email is required.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" name="phone" value="{{ customer.phone }}" required>
                            <div class="invalid-feedback">Phone number is required.</div>
                        </div>
                    </div>

                    <!-- Business Information -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <h6 class="text-muted border-bottom pb-2">
                                <i class="fas fa-building me-1"></i>Business Information
                            </h6>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-control" name="company_name" value="{{ customer.company_name|default:'' }}">
                            <small class="form-text text-muted">Leave empty for individual customers</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Business Type</label>
                            <select class="form-select" name="business_type">
                                <option value="individual" {% if customer.business_type == 'individual' %}selected{% endif %}>Individual</option>
                                <option value="business" {% if customer.business_type == 'business' %}selected{% endif %}>Business</option>
                                <option value="government" {% if customer.business_type == 'government' %}selected{% endif %}>Government</option>
                                <option value="ngo" {% if customer.business_type == 'ngo' %}selected{% endif %}>NGO</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tax Number</label>
                        <input type="text" class="form-control" name="tax_number" value="{{ customer.tax_number|default:'' }}">
                        <small class="form-text text-muted">VAT/PIN number for business customers</small>
                    </div>

                    <!-- Location Information -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <h6 class="text-muted border-bottom pb-2">
                                <i class="fas fa-map-marker-alt me-1"></i>Location Information
                            </h6>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" name="address" rows="2" placeholder="Street address, building, apartment">{{ customer.address|default:'' }}</textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" name="city" value="{{ customer.city|default:'' }}" placeholder="e.g., Nairobi">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Country</label>
                            <input type="text" class="form-control" name="country" value="{{ customer.country|default:'Kenya' }}">
                        </div>
                    </div>

                    <!-- Solar System Information (Optional) -->
                    <div id="solar-info-section-edit" style="{% if customer.monthly_consumption or customer.average_monthly_bill or customer.roof_area %}display: block;{% else %}display: none;{% endif %}">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <h6 class="text-muted border-bottom pb-2">
                                    <i class="fas fa-solar-panel me-1"></i>Solar System Information (Optional)
                                </h6>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Monthly Consumption (kWh)</label>
                                <input type="number" class="form-control" name="monthly_consumption" step="0.01" min="0" value="{{ customer.monthly_consumption|default:'' }}" placeholder="500">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Average Monthly Bill (KES)</label>
                                <input type="number" class="form-control" name="average_monthly_bill" step="0.01" min="0" value="{{ customer.average_monthly_bill|default:'' }}" placeholder="5000">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Property Type</label>
                                <select class="form-select" name="property_type">
                                    <option value="residential" {% if customer.property_type == 'residential' %}selected{% endif %}>Residential</option>
                                    <option value="commercial" {% if customer.property_type == 'commercial' %}selected{% endif %}>Commercial</option>
                                    <option value="industrial" {% if customer.property_type == 'industrial' %}selected{% endif %}>Industrial</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Roof Area (m²)</label>
                                <input type="number" class="form-control" name="roof_area" step="0.01" min="0" value="{{ customer.roof_area|default:'' }}" placeholder="100">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Roof Type</label>
                            <select class="form-select" name="roof_type">
                                <option value="iron_sheets" {% if customer.roof_type == 'iron_sheets' %}selected{% endif %}>Iron Sheets</option>
                                <option value="tiles" {% if customer.roof_type == 'tiles' %}selected{% endif %}>Tiles</option>
                                <option value="concrete" {% if customer.roof_type == 'concrete' %}selected{% endif %}>Concrete</option>
                                <option value="asbestos" {% if customer.roof_type == 'asbestos' %}selected{% endif %}>Asbestos</option>
                            </select>
                        </div>
                    </div>

                    <!-- Options -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="show-solar-fields-edit" {% if customer.monthly_consumption or customer.average_monthly_bill or customer.roof_area %}checked{% endif %}>
                                <label class="form-check-label" for="show-solar-fields-edit">
                                    Include solar system information
                                </label>
                                <small class="form-text text-muted d-block">Check this if customer is interested in solar solutions</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Customer editing functions
function editCustomer(customerId) {
    // Split the customer name into first and last name
    const customerName = '{{ customer.name|escapejs }}';
    const nameParts = customerName.split(' ');
    const firstName = nameParts[0] || '';
    const lastName = nameParts.slice(1).join(' ') || '';

    // Populate the name fields
    document.getElementById('first_name_edit').value = firstName;
    document.getElementById('last_name_edit').value = lastName;

    // Show the edit modal
    const modal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
    modal.show();
}

function selectCustomerForSale(customerId, customerName) {
    // Check if this is a popup window (opened from POS terminal)
    if (window.opener && window.opener.selectCustomer) {
        window.opener.selectCustomer(customerId, customerName);
        window.close();
        return;
    }

    // Get active terminal and redirect to it
    getActiveTerminalAndRedirect(customerId, customerName);
}

function getActiveTerminalAndRedirect(customerId, customerName) {
    // Show loading message
    showToast('Getting active terminal...', 'info');

    // Get active terminal
    fetch('{% url "pos:api_get_active_terminal" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Store customer selection
                sessionStorage.setItem('selectedCustomer', JSON.stringify({
                    id: customerId,
                    name: customerName
                }));

                // Redirect to active terminal
                window.location.href = `/pos/terminal/${data.terminal_id}/`;
            } else {
                showToast('No active session found. Please start a session first.', 'warning');
                // Redirect to POS main
                setTimeout(() => {
                    window.location.href = '{% url "pos:main" %}';
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error getting active terminal:', error);
            showToast('Error getting active terminal.', 'error');
            setTimeout(() => {
                window.location.href = '{% url "pos:main" %}';
            }, 2000);
        });
}

// Toast notification helper
function showToast(message, type = 'info') {
    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
    toastContainer.style.zIndex = '9999';

    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'primary'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    toastContainer.innerHTML = toastHtml;
    document.body.appendChild(toastContainer);

    const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'));
    toast.show();

    // Clean up
    toastContainer.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

// Handle solar fields toggle
document.getElementById('show-solar-fields-edit')?.addEventListener('change', function() {
    const solarSection = document.getElementById('solar-info-section-edit');
    if (solarSection) {
        solarSection.style.display = this.checked ? 'block' : 'none';
    }
});

// Handle edit form submission
document.getElementById('editCustomerForm')?.addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
    submitBtn.disabled = true;

    // Send update request
    fetch(`{% url "pos:customer_detail" customer.id %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and reload page
            bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
            location.reload();
        } else {
            alert('Error updating customer: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating customer. Please try again.');
    })
    .finally(() => {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});
</script>
{% endblock %}
