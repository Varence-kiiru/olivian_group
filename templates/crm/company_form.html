{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit{% else %}New{% endif %} Company - {{ block.super }}{% endblock %}

{% block page_title %}{% if form.instance.pk %}Edit Company{% else %}New Company{% endif %}{% endblock %}
{% block page_subtitle %}{% if form.instance.pk %}Update company information{% else %}Add a new company to your CRM{% endif %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'crm:dashboard' %}">CRM</a></li>
<li class="breadcrumb-item"><a href="{% url 'crm:company_list' %}">Companies</a></li>
<li class="breadcrumb-item active">{% if form.instance.pk %}Edit{% else %}New{% endif %}</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Please correct the following errors:</h5>
                        <ul class="mb-0">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <li>{{ field|title }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if messages %}
                    <div class="messages mb-3">
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {% if message.tags == 'success' %}
                                    <i class="fas fa-check-circle alert-icon"></i>
                                {% elif message.tags == 'error' or message.tags == 'danger' %}
                                    <i class="fas fa-exclamation-triangle alert-icon"></i>
                                {% elif message.tags == 'warning' %}
                                    <i class="fas fa-exclamation-circle alert-icon"></i>
                                {% elif message.tags == 'info' %}
                                    <i class="fas fa-info-circle alert-icon"></i>
                                {% else %}
                                    <i class="fas fa-bell alert-icon"></i>
                                {% endif %}
                                <span>{{ message }}</span>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Basic Information -->
                    <h5 class="mb-4">Basic Information</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.name.id_for_label }}" class="form-label required-field">
                                    Company Name
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="text-danger small mt-1">{{ form.name.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Add company_type field -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.company_type.id_for_label }}" class="form-label required-field">
                                    Company Type
                                </label>
                                {{ form.company_type }}
                                {% if form.company_type.errors %}
                                    <div class="text-danger small mt-1">{{ form.company_type.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.industry.id_for_label }}" class="form-label">Industry</label>
                                {{ form.industry }}
                                {% if form.industry.errors %}
                                    <div class="text-danger small mt-1">{{ form.industry.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <h5 class="mb-4">Contact Information</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div class="text-danger small mt-1">{{ form.email.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.phone.id_for_label }}" class="form-label">Phone</label>
                                {{ form.phone }}
                                {% if form.phone.errors %}
                                    <div class="text-danger small mt-1">{{ form.phone.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Location Information -->
                    <h5 class="mb-4">Location</h5>
                    <div class="row mb-4">
                        <div class="col-12 mb-3">
                            <div class="form-group">
                                <label for="{{ form.address.id_for_label }}" class="form-label">Address</label>
                                {{ form.address }}
                                {% if form.address.errors %}
                                    <div class="text-danger small mt-1">{{ form.address.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.city.id_for_label }}" class="form-label">City</label>
                                {{ form.city }}
                                {% if form.city.errors %}
                                    <div class="text-danger small mt-1">{{ form.city.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.county.id_for_label }}" class="form-label">County</label>
                                {{ form.county }}
                                {% if form.county.errors %}
                                    <div class="text-danger small mt-1">{{ form.county.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <h5 class="mb-4">Additional Information</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.website.id_for_label }}" class="form-label">Website</label>
                                {{ form.website }}
                                {% if form.website.errors %}
                                    <div class="text-danger small mt-1">{{ form.website.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.employee_count.id_for_label }}" class="form-label">
                                    Number of Employees
                                </label>
                                {{ form.employee_count }}
                                {% if form.employee_count.errors %}
                                    <div class="text-danger small mt-1">{{ form.employee_count.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-group mb-4">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                            <div class="text-danger small mt-1">{{ form.notes.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'crm:company_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            {% if form.instance.pk %}Update{% else %}Create{% endif %} Company
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Preview Card -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">Company Preview</h5>
                <div class="company-preview">
                    <div class="company-logo mb-3">
                        {% if form.instance.logo %}
                            <img src="{{ form.instance.logo.url }}" alt="{{ form.instance.name }}" class="img-fluid" style="max-height: 64px;">
                        {% else %}
                            <i class="fas fa-building fa-3x text-primary"></i>
                        {% endif %}
                    </div>
                    <h6 class="preview-name mb-2">{{ form.instance.name|default:"Company Name" }}</h6>
                    <p class="text-muted mb-3">{{ form.instance.industry|default:"Industry" }}</p>
                    
                    <div class="company-meta text-muted small mb-3">
                        {% if form.instance.pk %}
                            <div class="d-flex align-items-center mb-1">
                                <i class="fas fa-calendar me-2"></i>
                                <span>Member since {{ form.instance.created_at|date:"M Y" }}</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock me-2"></i>
                                <span>Last updated {{ form.instance.updated_at|date:"M d, Y" }}</span>
                            </div>
                        {% else %}
                            <div class="d-flex align-items-center mb-1">
                                <i class="fas fa-calendar me-2"></i>
                                <span>New Company</span>
                            </div>
                        {% endif %}
                    </div>
                    
                    <hr>
                    
                    <!-- Replace the preview stats section -->
                    <div class="preview-stats row text-center g-2 mb-3">
                        <div class="col-4">
                            <div class="border rounded p-2">
                                <div class="h4 mb-0">
                                    {% if form.instance.pk %}
                                        {{ form.instance.contacts.count }}
                                    {% else %}
                                        {{ preview_data.contacts_count }}
                                    {% endif %}
                                </div>
                                <div class="small text-muted">Contacts</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border rounded p-2">
                                <div class="h4 mb-0">
                                    {% if form.instance.pk %}
                                        {{ form.instance.leads.count }}
                                    {% else %}
                                        {{ preview_data.leads_count }}
                                    {% endif %}
                                </div>
                                <div class="small text-muted">Leads</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border rounded p-2">
                                <div class="h4 mb-0">
                                    {% if form.instance.pk %}
                                        {{ form.instance.opportunities.count }}
                                    {% else %}
                                        {{ preview_data.opportunities_count }}
                                    {% endif %}
                                </div>
                                <div class="small text-muted">Opportunities</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="preview-details">
                        <div class="preview-item mb-2">
                            <i class="fas fa-envelope text-muted me-2"></i>
                            <span>{{ form.instance.email|default:"Email not provided" }}</span>
                        </div>
                        <div class="preview-item mb-2">
                            <i class="fas fa-phone text-muted me-2"></i>
                            <span>{{ form.instance.phone|default:"Phone not provided" }}</span>
                        </div>
                        <div class="preview-item mb-2">
                            <i class="fas fa-map-marker-alt text-muted me-2"></i>
                            <span>
                                {% if form.instance.city %}
                                    {{ form.instance.city }}{% if form.instance.county %}, {{ form.instance.county }}{% endif %}
                                {% else %}
                                    Location not provided
                                {% endif %}
                            </span>
                        </div>
                        {% if form.instance.website %}
                        <div class="preview-item">
                            <i class="fas fa-globe text-muted me-2"></i>
                            <a href="{{ form.instance.website }}" target="_blank" class="text-decoration-none">
                                Visit Website
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const previewName = document.querySelector('.preview-name');
    const previewIndustry = document.querySelector('.text-muted');
    const previewDetails = document.querySelector('.preview-details');
    
    form.querySelectorAll('input, select, textarea').forEach(input => {
        input.addEventListener('input', updatePreview);
        input.addEventListener('change', updatePreview);
    });
    
    function updatePreview() {
        const name = form.querySelector('#{{ form.name.id_for_label }}').value;
        const companyType = form.querySelector('#{{ form.company_type.id_for_label }}');
        const industry = form.querySelector('#{{ form.industry.id_for_label }}').value;
        const email = form.querySelector('#{{ form.email.id_for_label }}').value;
        const phone = form.querySelector('#{{ form.phone.id_for_label }}').value;
        const city = form.querySelector('#{{ form.city.id_for_label }}').value;
        const county = form.querySelector('#{{ form.county.id_for_label }}').value;
        const website = form.querySelector('#{{ form.website.id_for_label }}').value;
        
        previewName.textContent = name || 'Company Name';
        // Update industry text to include company type if selected
        previewIndustry.textContent = [
            companyType.options[companyType.selectedIndex]?.text,
            industry
        ].filter(Boolean).join(' â€¢ ') || 'Industry';
        
        const location = [city, county].filter(Boolean).join(', ');
        
        let detailsHtml = `
            <div class="preview-item mb-2">
                <i class="fas fa-envelope text-muted me-2"></i>
                <span>${email || 'Email not provided'}</span>
            </div>
            <div class="preview-item mb-2">
                <i class="fas fa-phone text-muted me-2"></i>
                <span>${phone || 'Phone not provided'}</span>
            </div>
            <div class="preview-item mb-2">
                <i class="fas fa-map-marker-alt text-muted me-2"></i>
                <span>${location || 'Location not provided'}</span>
            </div>`;
            
        if (website) {
            detailsHtml += `
                <div class="preview-item">
                    <i class="fas fa-globe text-muted me-2"></i>
                    <a href="${website}" target="_blank" class="text-decoration-none">
                        Visit Website
                    </a>
                </div>`;
        }
        
        previewDetails.innerHTML = detailsHtml;
    }
    
    // Initial preview update
    updatePreview();
});
</script>
{% endblock %}
