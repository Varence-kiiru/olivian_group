{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}
    {% if object %}Edit Lead{% else %}Add New Lead{% endif %} - {{ block.super }}
{% endblock %}

{% block page_title %}
    {% if object %}Edit Lead{% else %}Add New Lead{% endif %}
{% endblock %}

{% block page_subtitle %}
    {% if object %}Update lead information{% else %}Capture a new potential customer{% endif %}
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'crm:dashboard' %}">CRM</a></li>
<li class="breadcrumb-item"><a href="{% url 'crm:lead_list' %}">Leads</a></li>
<li class="breadcrumb-item active">
    {% if object %}Edit{% else %}Add{% endif %}
</li>
{% endblock %}

{% block extra_css %}
<style>
    .form-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .form-section {
        border-left: 4px solid var(--primary-color);
        padding-left: 1rem;
        margin-bottom: 2rem;
    }

    .required-field::after {
        content: " *";
        color: #dc3545;
    }

    .score-display {
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <form method="post" class="form-card">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Company Information Section -->
            <div class="form-section">
                <h5 class="mb-3">
                    <i class="fas fa-building me-2"></i>Company Information
                </h5>

                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="{{ form.company_name.id_for_label }}" class="form-label">
                            Company Name
                        </label>
                        {{ form.company_name }}
                        {% if form.company_name.errors %}
                            <div class="text-danger small">{{ form.company_name.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="{{ form.website.id_for_label }}" class="form-label">
                            Website
                        </label>
                        {{ form.website }}
                        {% if form.website.errors %}
                            <div class="text-danger small">{{ form.website.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.industry.id_for_label }}" class="form-label">
                            Industry
                        </label>
                        {{ form.industry }}
                        {% if form.industry.errors %}
                            <div class="text-danger small">{{ form.industry.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ form.company_size.id_for_label }}" class="form-label">
                            Company Size
                        </label>
                        {{ form.company_size }}
                        {% if form.company_size.errors %}
                            <div class="text-danger small">{{ form.company_size.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Lead Information Section -->
            <div class="form-section">
                <h5 class="mb-3">
                    <i class="fas fa-info-circle me-2"></i>Lead Information
                </h5>
                
                <div class="mb-3">
                    <label for="{{ form.title.id_for_label }}" class="form-label required-field">
                        Lead Title
                    </label>
                    {{ form.title }}
                    {% if form.title.errors %}
                        <div class="text-danger small">{{ form.title.errors }}</div>
                    {% endif %}
                    <div class="form-text">Brief description of the lead/opportunity</div>
                </div>
            </div>

            <!-- Contact Information Section -->
            <div class="form-section">
                <h5 class="mb-3">
                    <i class="fas fa-user me-2"></i>Contact Information
                </h5>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.contact_name.id_for_label }}" class="form-label required-field">
                            Contact Name
                        </label>
                        {{ form.contact_name }}
                        {% if form.contact_name.errors %}
                            <div class="text-danger small">{{ form.contact_name.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ form.job_title.id_for_label }}" class="form-label">
                            Job Title
                        </label>
                        {{ form.job_title }}
                        {% if form.job_title.errors %}
                            <div class="text-danger small">{{ form.job_title.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.email.id_for_label }}" class="form-label required-field">
                            Email Address
                        </label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="text-danger small">{{ form.email.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ form.phone.id_for_label }}" class="form-label">
                            Phone Number
                        </label>
                        {{ form.phone }}
                        {% if form.phone.errors %}
                            <div class="text-danger small">{{ form.phone.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.address.id_for_label }}" class="form-label">
                        Address
                    </label>
                    {{ form.address }}
                    {% if form.address.errors %}
                        <div class="text-danger small">{{ form.address.errors }}</div>
                    {% endif %}
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.city.id_for_label }}" class="form-label">
                            City
                        </label>
                        {{ form.city }}
                        {% if form.city.errors %}
                            <div class="text-danger small">{{ form.city.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ form.country.id_for_label }}" class="form-label">
                            Country
                        </label>
                        {{ form.country }}
                        {% if form.country.errors %}
                            <div class="text-danger small">{{ form.country.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Lead Details Section -->
            <div class="form-section">
                <h5 class="mb-3">
                    <i class="fas fa-chart-line me-2"></i>Lead Details
                </h5>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.source.id_for_label }}" class="form-label">
                            Lead Source
                        </label>
                        {{ form.source }}
                        {% if form.source.errors %}
                            <div class="text-danger small">{{ form.source.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.status.id_for_label }}" class="form-label">
                            Status
                        </label>
                        {{ form.status }}
                        {% if form.status.errors %}
                            <div class="text-danger small">{{ form.status.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="{{ form.priority.id_for_label }}" class="form-label">
                            Priority
                        </label>
                        {{ form.priority }}
                        {% if form.priority.errors %}
                            <div class="text-danger small">{{ form.priority.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="{{ form.interest.id_for_label }}" class="form-label">
                            Interest/Requirement
                        </label>
                        {{ form.interest }}
                        {% if form.interest.errors %}
                            <div class="text-danger small">{{ form.interest.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.budget.id_for_label }}" class="form-label">
                            Budget (KES)
                        </label>
                        {{ form.budget }}
                        {% if form.budget.errors %}
                            <div class="text-danger small">{{ form.budget.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.notes.id_for_label }}" class="form-label">
                        Notes
                    </label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                        <div class="text-danger small">{{ form.notes.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="{{ form.assigned_to.id_for_label }}" class="form-label">
                            Assigned To
                        </label>
                        {{ form.assigned_to }}
                        {% if form.assigned_to.errors %}
                            <div class="text-danger small">{{ form.assigned_to.errors }}</div>
                        {% endif %}
                    </div>

                    {% if object %}
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Lead Score</label>
                        <div class="d-flex align-items-center">
                            <div class="score-display me-3">
                                {{ object.score|default:"0" }}
                            </div>
                            <div class="small text-muted">
                                Auto-calculated based on<br>
                                engagement and profile
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Solar System Details (show for both create and edit) -->
                <hr class="my-4">
                <h6 class="mb-3">
                    <i class="fas fa-solar-panel me-2"></i>Solar System Details (Optional)
                </h6>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.system_type.id_for_label }}" class="form-label">
                            System Type
                        </label>
                        {{ form.system_type }}
                        {% if form.system_type.errors %}
                            <div class="text-danger small">{{ form.system_type.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.estimated_capacity.id_for_label }}" class="form-label">
                            Estimated Capacity (kW)
                        </label>
                        {{ form.estimated_capacity }}
                        {% if form.estimated_capacity.errors %}
                            <div class="text-danger small">{{ form.estimated_capacity.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.estimated_value.id_for_label }}" class="form-label">
                            Estimated Project Value (KES)
                        </label>
                        {{ form.estimated_value }}
                        {% if form.estimated_value.errors %}
                            <div class="text-danger small">{{ form.estimated_value.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.monthly_electricity_bill.id_for_label }}" class="form-label">
                            Monthly Electricity Bill (KES)
                        </label>
                        {{ form.monthly_electricity_bill }}
                        {% if form.monthly_electricity_bill.errors %}
                            <div class="text-danger small">{{ form.monthly_electricity_bill.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.expected_close_date.id_for_label }}" class="form-label">
                            Expected Close Date
                        </label>
                        {{ form.expected_close_date }}
                        {% if form.expected_close_date.errors %}
                            <div class="text-danger small">{{ form.expected_close_date.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.next_follow_up.id_for_label }}" class="form-label">
                            Next Follow-up Date
                        </label>
                        {{ form.next_follow_up }}
                        {% if form.next_follow_up.errors %}
                            <div class="text-danger small">{{ form.next_follow_up.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="mb-3">
                    <label for="{{ form.description.id_for_label }}" class="form-label">
                        Description
                    </label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <div class="text-danger small">{{ form.description.errors }}</div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Add this before the form actions -->
            {% if messages %}
            <div class="messages mb-3">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Form Actions -->
            <div class="d-flex justify-content-between">
                <a href="{% url 'crm:lead_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Cancel
                </a>
                
                <div>
                    {% if object and object.status in 'qualified,proposal' and not object.opportunity %}
                    <a href="{% url 'crm:lead_convert' object.pk %}" class="btn btn-success me-2">
                        <i class="fas fa-exchange-alt me-2"></i>Convert to Opportunity
                    </a>
                    {% endif %}
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>
                        {% if object %}Update Lead{% else %}Create Lead{% endif %}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Disable company fields if coming from company detail page
    const urlParams = new URLSearchParams(window.location.search);
    const companyId = urlParams.get('company');
    
    if (companyId) {
        // Make company fields readonly
        const companyFields = [
            'company_name',
            'website',
            'industry',
            'company_size'
        ];
        
        companyFields.forEach(field => {
            const element = document.getElementById(`id_${field}`);
            if (element) {
                element.readOnly = true;
                element.classList.add('bg-light');
            }
        });
        
        // Focus on lead title instead
        document.getElementById('id_title').focus();
    }
    
    // Auto-calculate lead score based on form data
    function calculateLeadScore() {
        let score = 0;
        
        // Company name filled (+10)
        if (document.getElementById('id_company_name') && document.getElementById('id_company_name').value.trim()) score += 10;
        
        // Email filled (+10)
        if (document.getElementById('id_email') && document.getElementById('id_email').value.trim()) score += 10;
        
        // Phone filled (+5)
        if (document.getElementById('id_phone') && document.getElementById('id_phone').value.trim()) score += 5;
        
        // Website filled (+5)
        if (document.getElementById('id_website') && document.getElementById('id_website').value.trim()) score += 5;
        
        // Budget specified (+15)
        if (document.getElementById('id_budget') && document.getElementById('id_budget').value.trim()) score += 15;
        
        // Interest specified (+10)
        if (document.getElementById('id_interest') && document.getElementById('id_interest').value.trim()) score += 10;
        
        // Priority bonus
        const priority = document.getElementById('id_priority') ? document.getElementById('id_priority').value : '';
        if (priority === 'urgent') score += 25;
        else if (priority === 'high') score += 20;
        else if (priority === 'medium') score += 10;
        else if (priority === 'low') score += 5;
        
        // Status bonus
        const status = document.getElementById('id_status') ? document.getElementById('id_status').value : '';
        if (status === 'proposal') score += 30;
        else if (status === 'qualified') score += 25;
        else if (status === 'negotiation') score += 35;
        else if (status === 'contacted') score += 15;
        
        return Math.min(score, 100); // Cap at 100
    }
    
    // Update score display when form changes
    const scoreDisplay = document.querySelector('.score-display');
    if (scoreDisplay) {
        const formInputs = document.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            input.addEventListener('change', function() {
                const newScore = calculateLeadScore();
                scoreDisplay.textContent = newScore;
            });
        });
    }
    
    // Auto-populate company field based on email domain
    const emailField = document.getElementById('id_email');
    const companyField = document.getElementById('id_company_name');
    
    if (emailField && companyField) {
        emailField.addEventListener('blur', function() {
            const email = this.value;
            if (email && !companyField.value) {
                const domain = email.split('@')[1];
                if (domain) {
                    // Convert domain to company name suggestion
                    const companyName = domain.split('.')[0];
                    const suggestion = companyName.charAt(0).toUpperCase() + companyName.slice(1);
                    companyField.value = suggestion;
                }
            }
        });
    }
    
    // Form validation
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const contactName = document.getElementById('id_contact_name');
            const email = document.getElementById('id_email');
            
            let hasErrors = false;
            
            // Clear previous error messages
            document.querySelectorAll('.text-danger.validation-error').forEach(el => el.remove());
            
            if (!contactName.value.trim()) {
                showFieldError(contactName, 'Contact name is required.');
                hasErrors = true;
            }
            
            if (!email.value.trim()) {
                showFieldError(email, 'Email address is required.');
                hasErrors = true;
            } else if (!isValidEmail(email.value)) {
                showFieldError(email, 'Please enter a valid email address.');
                hasErrors = true;
            }
            
            if (hasErrors) {
                e.preventDefault();
            }
        });
    }
    
    function showFieldError(field, message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-danger small validation-error';
        errorDiv.textContent = message;
        field.parentNode.appendChild(errorDiv);
        field.classList.add('is-invalid');
    }
    
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
});
</script>
{% endblock %}
