{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Delete Opportunity - {{ block.super }}{% endblock %}

{% block page_title %}Delete Opportunity{% endblock %}
{% block page_subtitle %}Confirm deletion of opportunity: {{ opportunity.name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'crm:dashboard' %}">CRM</a></li>
<li class="breadcrumb-item"><a href="{% url 'crm:opportunity_list' %}">Opportunities</a></li>
<li class="breadcrumb-item"><a href="{% url 'crm:opportunity_detail' opportunity.pk %}">{{ opportunity.name|truncatechars:30 }}</a></li>
<li class="breadcrumb-item active">Delete</li>
{% endblock %}

{% block extra_css %}
<style>
    .opportunity-header {
        background: linear-gradient(135deg, #dc3545, #f44336);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
    }

    .confidence-indicator {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: white;
        margin: 0 auto 1rem;
    }

    .review-section {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .impact-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .metric-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
    }

    .pipeline-visualization {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1rem 0;
    }

    .stage-flow {
        display: flex;
        justify-content: space-between;
        position: relative;
        margin: 1rem 0;
    }

    .stage-step {
        flex: 1;
        padding: 0.5rem;
        text-align: center;
        border-radius: 6px;
        margin: 0 0.5rem;
        font-size: 0.9rem;
        font-weight: 600;
        position: relative;
    }

    .stage-step.active {
        background: var(--primary-color);
        color: white;
    }

    .stage-step.completed {
        background: #28a745;
        color: white;
    }

    .stage-step.upcoming {
        background: #6c757d;
        color: white;
    }

    .opportunity-stats {
        background: #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Opportunity Header Warning -->
        <div class="opportunity-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-3">{{ opportunity.name }}</h2>
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <span class="badge bg-danger badge-lg">
                            <i class="fas fa-trash me-2"></i>DELETION CONFIRMED
                        </span>
                        <span class="opacity-75">Value: KES {{ opportunity.value|floatformat:0 }}</span>
                    </div>
                    <div class="opacity-75">
                        <i class="fas fa-user me-2"></i>{{ opportunity.contact.get_full_name }}
                        {% if opportunity.company %}
                            <i class="fas fa-building ms-3 me-2"></i>{{ opportunity.company.name }}
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="confidence-indicator">
                        {{ opportunity.probability }}%
                    </div>
                    <div class="text-center">
                        <small class="opacity-75">Current Probability</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Main Content -->
            <div class="col-md-8">

                <!-- Opportunity Review -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>Final Opportunity Review
                        </h5>

                        <div class="row g-3 mb-4">
                            <div class="col-sm-6">
                                <div class="card border-success">
                                    <div class="card-body text-center">
                                        <div class="text-success" style="font-size: 2rem;">
                                            KES {{ opportunity.value|floatformat:0 }}
                                        </div>
                                        <div class="text-muted small">Total Value</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="card border-warning">
                                    <div class="card-body text-center">
                                        <div class="text-warning" style="font-size: 2rem;">
                                            KES {{ opportunity.weighted_value|floatformat:0 }}
                                        </div>
                                        <div class="text-muted small">Weighted Value</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="opportunity-stats">
                            <h6><i class="fas fa-trophy me-2"></i>Opportunity Details:</h6>
                            <div class="row g-3">
                                <div class="col-sm-4">
                                    <strong>Stage:</strong><br>
                                    <span class="badge bg-primary">{{ opportunity.get_stage_display }}</span>
                                </div>
                                <div class="col-sm-4">
                                    <strong>Created:</strong><br>
                                    <span>{{ opportunity.created_at|date:"M d, Y" }}</span>
                                </div>
                                <div class="col-sm-4">
                                    <strong>Assigned To:</strong><br>
                                    <span>{% if opportunity.assigned_to %}{{ opportunity.assigned_to.get_full_name }}{% else %}Unassigned{% endif %}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Impact Assessment -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-warning">
                            <i class="fas fa-chart-line me-2"></i>Business Impact Assessment
                        </h5>

                        <div class="review-section">
                            <h6 class="mb-2">ðŸ“Š What Will Be Lost:</h6>
                            <ul class="mb-0">
                                <li><strong>Sales Pipeline Gap:</strong> Removal will create a gap in your sales pipeline forecasting</li>
                                <li><strong>Lead Connection:</strong> {{ opportunity.lead.title|default:"Original lead" }} will lose opportunity reference</li>
                                <li><strong>Activity History:</strong> All related activities and follow-ups will be orphaned</li>
                                <li><strong>Revenue Forecast:</strong> Pipeline value will decrease by KES {{ opportunity.weighted_value|floatformat:0 }}</li>
                                <li><strong>Contact Relationship:</strong> {{ opportunity.contact.get_full_name }} will lose this opportunity reference</li>
                            </ul>
                        </div>

                        {% if opportunity.stage in 'proposal,negotiation' %}
                        <div class="alert alert-danger mt-3">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>Warning:</strong> Deleting an opportunity in {{ opportunity.get_stage_display }} stage
                            will significantly impact your active sales pipeline and customer conversion metrics.
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Alternative Actions -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-primary">
                            <i class="fas fa-lightbulb me-2"></i>Consider Alternatives
                        </h5>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <a href="{% url 'crm:opportunity_update' opportunity.pk %}"
                                   class="btn btn-outline-primary w-100">
                                    <i class="fas fa-edit me-2"></i>Edit Opportunity
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="{% url 'crm:opportunity_change_stage' opportunity.pk %}"
                                   class="btn btn-outline-warning w-100">
                                    <i class="fas fa-arrow-right me-2"></i>Update Stage
                                </a>
                            </div>
                        </div>

                        <div class="mt-3">
                            <small class="text-muted">
                                Consider marking as "Closed Lost" instead of complete deletion to preserve historical data.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-md-4">

                <!-- Deletion Confirmation -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-danger">
                            <i class="fas fa-skull-crossbones me-2"></i>Deletion Confirmation
                        </h5>

                        <p class="text-muted small mb-3">
                            Are you absolutely certain you want to delete this opportunity?
                        </p>

                        <div class="mb-3">
                            <label for="confirmationInput" class="form-label">Type "DELETE OPPORTUNITY" to confirm:</label>
                            <input type="text" class="form-control" id="confirmationInput"
                                   placeholder="DELETE OPPORTUNITY">
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-danger btn-lg" id="confirmBtn" disabled>
                                <i class="fas fa-trash-alt me-2"></i>Confirm Deletion
                            </button>

                            <form method="post" action="" style="display: none;" id="deleteForm">
                                {% csrf_token %}
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Quick Status -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-info-circle me-2"></i>Quick Reference
                        </h5>

                        <div class="row g-3">
                            <div class="col-12">
                                <strong>Expected Close:</strong><br>
                                <span class="{% if opportunity.is_overdue %}text-danger{% else %}text-success{% endif %}">
                                    {{ opportunity.expected_close_date|date:"M d, Y" }}
                                    {% if opportunity.is_overdue %}
                                        <i class="fas fa-exclamation-triangle ms-1"></i> Overdue
                                    {% endif %}
                                </span>
                            </div>

                            <div class="col-12">
                                <strong>Time to Close:</strong><br>
                                {% if opportunity.days_to_close > 0 %}
                                    <span>{{ opportunity.days_to_close }} days remaining</span>
                                {% elif opportunity.days_to_close == 0 %}
                                    <span class="text-warning">Due today</span>
                                {% else %}
                                    <span class="text-danger">{{ opportunity.days_past_due }} days overdue</span>
                                {% endif %}
                            </div>
                        </div>

                        <hr>

                        <a href="{% url 'crm:opportunity_detail' opportunity.pk %}"
                           class="btn btn-outline-secondary w-100">
                            <i class="fas fa-arrow-left me-2"></i>Go Back to Opportunity
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Deletion Success Modal -->
<div class="modal fade" id="deletionSuccessModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check me-2"></i>Deletion Confirmed
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">The opportunity <strong>"{{ opportunity.name }}"</strong> has been successfully deleted.</p>
            </div>
            <div class="modal-footer">
                <a href="{% url 'crm:opportunity_list' %}" class="btn btn-secondary">
                    <i class="fas fa-list me-2"></i>Return to Opportunities
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmationInput = document.getElementById('confirmationInput');
    const confirmBtn = document.getElementById('confirmBtn');
    const deleteForm = document.getElementById('deleteForm');
    const expectedText = 'DELETE OPPORTUNITY';

    confirmationInput.addEventListener('input', function() {
        const isValid = this.value.trim().toUpperCase() === expectedText;
        confirmBtn.disabled = !isValid;

        if (isValid) {
            confirmBtn.style.backgroundColor = '#dc3545';
            confirmBtn.style.borderColor = '#dc3545';
        } else {
            confirmBtn.style.backgroundColor = '';
            confirmBtn.style.borderColor = '';
        }
    });

    confirmBtn.addEventListener('click', function() {
        if (confirm('This action cannot be undone. Are you absolutely sure?')) {
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';
            confirmBtn.disabled = true;

            deleteForm.submit();
        }
    });

    // Show success modal if deletion was successful
    {% if messages %}
        {% for message in messages %}
            {% if "deleted successfully" in message.message %}
                const successModal = new bootstrap.Modal(document.getElementById('deletionSuccessModal'));
                successModal.show();
            {% endif %}
        {% endfor %}
    {% endif %}
});
</script>
{% endblock %}
