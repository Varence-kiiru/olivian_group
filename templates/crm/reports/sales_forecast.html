{% extends 'dashboard/base.html' %}
{% load static %}
{% load humanize %}  <!-- Add this line -->

{% block title %}Sales Forecast - CRM{% endblock %}

{% block page_title %}Sales Forecast{% endblock %}
{% block page_subtitle %}View and analyze sales pipeline forecasts{% endblock %}

{% block content %}
<div class="row">
    <!-- Summary Cards -->
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ opportunity_count }}</div>
            <div class="stats-label">Active Opportunities</div>
            <i class="stats-icon fas fa-funnel-dollar"></i>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">KES {{ total_pipeline|floatformat:0|intcomma }}</div>
            <div class="stats-label">Total Pipeline Value</div>
            <i class="stats-icon fas fa-chart-line"></i>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">KES {{ weighted_pipeline|floatformat:0|intcomma }}</div>
            <div class="stats-label">Weighted Pipeline Value</div>
            <i class="stats-icon fas fa-balance-scale"></i>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-value">{{ historical_win_rate|floatformat:1 }}%</div>
            <div class="stats-label">Historical Win Rate</div>
            <i class="stats-icon fas fa-percentage"></i>
        </div>
    </div>
</div>

<!-- Forecast Table -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-calendar-alt me-2"></i>Monthly Forecast
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Opportunities</th>
                        <th>Total Value</th>
                        <th>Weighted Value</th>
                        <th>Avg Deal Size</th>
                    </tr>
                </thead>
                <tbody>
                    {% for month in forecast_data %}
                    <tr>
                        <td>{{ month.month }}</td>
                        <td>{{ month.count }}</td>
                        <td>KES {{ month.total_value|floatformat:0|intcomma }}</td>
                        <td>KES {{ month.weighted_value|floatformat:0|intcomma }}</td>
                        <td>
                            {% if month.count > 0 %}
                                KES {{ month.total_value|divisibleby:month.count|floatformat:0|intcomma }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">No forecast data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-primary">
                        <th>Total</th>
                        <th>{{ opportunity_count }}</th>
                        <th>KES {{ total_pipeline|floatformat:0|intcomma }}</th>
                        <th>KES {{ weighted_pipeline|floatformat:0|intcomma }}</th>
                        <th>KES {{ average_deal_size|floatformat:0|intcomma }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Monthly Value Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="monthlyValueChart" height="300"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Win Probability Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="probabilityChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Monthly Value Distribution Chart
const monthlyValueCtx = document.getElementById('monthlyValueChart').getContext('2d');
new Chart(monthlyValueCtx, {
    type: 'bar',
    data: {
        labels: {{ chart_data.months|safe }},
        datasets: [{
            label: 'Total Value',
            data: {{ chart_data.total_values|safe }},
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }, {
            label: 'Weighted Value',
            data: {{ chart_data.weighted_values|safe }},
            backgroundColor: 'rgba(255, 159, 64, 0.2)',
            borderColor: 'rgba(255, 159, 64, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: value => 'KES ' + value.toLocaleString()
                }
            }
        }
    }
});

// Win Probability Distribution Chart
const probabilityData = {
    labels: ['High (>70%)', 'Medium (40-70%)', 'Low (<40%)'],
    datasets: [{
        data: [
            {{ high_probability_value|default:0 }},
            {{ medium_probability_value|default:0 }},
            {{ low_probability_value|default:0 }}
        ],
        backgroundColor: [
            'rgba(75, 192, 192, 0.2)',
            'rgba(255, 206, 86, 0.2)',
            'rgba(255, 99, 132, 0.2)'
        ],
        borderColor: [
            'rgba(75, 192, 192, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(255, 99, 132, 1)'
        ],
        borderWidth: 1
    }]
};

const probabilityCtx = document.getElementById('probabilityChart').getContext('2d');
new Chart(probabilityCtx, {
    type: 'doughnut',
    data: probabilityData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>
{% endblock %}