{% extends 'dashboard/base.html' %}
{% load static %}
{% load django_bootstrap5 %}

{% block title %}
    {% if form.instance.pk %}Edit{% else %}New{% endif %} Email Template - CRM - {{ block.super }}
{% endblock %}

{% block page_title %}
    {% if form.instance.pk %}Edit{% else %}New{% endif %} Email Template
{% endblock %}
{% block page_subtitle %}
    {% if form.instance.pk %}Update template content{% else %}Create a new email template for automated communications{% endif %}
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'crm:dashboard' %}">CRM</a></li>
<li class="breadcrumb-item"><a href="{% url 'crm:email_template_list' %}">Email Templates</a></li>
<li class="breadcrumb-item active">
    {% if form.instance.pk %}Edit{{ object.name }}{% else %}New{% endif %}
</li>
{% endblock %}

{% block extra_css %}
<style>
    /* Email Template Editor Styles */
    :root {
        --email-primary: #6366f1;
        --email-success: #10b981;
        --email-warning: #f59e0b;
        --email-danger: #ef4444;
        --border-radius: 8px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .template-editor {
        background: #f8f9fa;
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .template-preview {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        border-left: 4px solid var(--email-primary);
    }

    .variables-panel {
        background: #f3f4f6;
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-top: 1rem;
    }

    .variable-tag {
        display: inline-block;
        background: var(--email-primary);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        margin: 0.25rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .variable-tag:hover {
        background: #5850ec;
        transform: translateY(-1px);
    }

    .subject-input {
        border-left: 4px solid var(--email-primary);
    }

    .preview-header {
        background: linear-gradient(135deg, var(--email-primary), #5850ec);
        color: white;
        padding: 1rem;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .btn-insert {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }

    .tabs-container {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow);
    }

    .nav-tabs-custom {
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 0.5rem 1rem;
    }

    .nav-tabs-custom .nav-link {
        border: none;
        color: #6c757d;
        padding: 0.75rem 1rem;
        margin-right: 0.25rem;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .nav-tabs-custom .nav-link.active {
        background: white;
        color: var(--email-primary);
        font-weight: 600;
    }

    .tab-pane {
        padding: 2rem;
    }

    .template-variables {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-top: 1rem;
    }

    .variable-category {
        margin-bottom: 1.5rem;
    }

    .category-header {
        background: var(--email-primary);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<form method="post" id="templateForm" novalidate>
    {% csrf_token %}

    {% if form.errors or form.non_field_errors %}
    <div class="alert alert-danger">
        <h6><i class="fas fa-exclamation-triangle me-2"></i>Please correct the following errors:</h6>
        <ul class="mb-0">
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
            {% for field in form %}
                {% for error in field.errors %}
                    <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Basic Information -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="template-editor">
                <h5 class="mb-4">
                    <i class="fas fa-info-circle me-2" style="color: var(--email-primary);"></i>
                    Template Information
                </h5>

                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label required">
                            Template Name
                        </label>
                        {{ form.name }}
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="{{ form.template_type.id_for_label }}" class="form-label">
                            Template Type
                        </label>
                        {{ form.template_type }}
                    </div>
                </div>

                <div class="mb-3">
                    <label for="{{ form.description.id_for_label }}" class="form-label">
                        Description
                    </label>
                    {{ form.description }}
                </div>

                <div class="mb-3">
                    <label for="{{ form.subject.id_for_label }}" class="form-label required">
                        Email Subject <i class="fas fa-info-circle text-muted ms-1" title="This will be the subject line of the email"></i>
                    </label>
                    {{ form.subject }}
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label for="{{ form.body.id_for_label }}" class="form-label required">
                            Email Body
                        </label>
                        <div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleVariablesPanel()">
                                <i class="fas fa-code me-1"></i>Insert Variables
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="previewEmail()">
                                <i class="fas fa-eye me-1"></i>Preview
                            </button>
                        </div>
                    </div>
                    {{ form.body }}
                </div>

                <!-- Variables Panel -->
                <div id="variablesPanel" class="variables-panel" style="display: none;">
                    <h6 class="mb-3">
                        <i class="fas fa-code me-2"></i>Template Variables
                        <small class="text-muted">(Click to insert)</small>
                    </h6>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="variable-category">
                                <div class="category-header">
                                    <i class="fas fa-user me-2"></i>Contact Variables
                                </div>
                                <div class="p-2">
                                    {% for val, label in contact_variables %}
                                    <span class="variable-tag" onclick="insertVariable('{{ val }}')">
                                        <code>{{ val }}</code>
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="variable-category">
                                <div class="category-header">
                                    <i class="fas fa-building me-2"></i>Company Variables
                                </div>
                                <div class="p-2">
                                    {% for val, label in company_variables %}
                                    <span class="variable-tag" onclick="insertVariable('{{ val }}')">
                                        <code>{{ val }}</code>
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="{{ form.is_active.id_for_label }}" class="form-label">
                        Status
                    </label>
                    <div class="form-check form-switch">
                        {{ form.is_active }}
                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                            Active - Template can be used for sending emails
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="col-lg-4">
            <div class="template-preview" id="emailPreview">
                <div class="preview-header">
                    <h6 class="mb-0">
                        <i class="fas fa-envelope me-2"></i>Email Preview
                    </h6>
                </div>
                <div class="p-3">
                    <div class="mb-2">
                        <strong>To:</strong> <span id="previewRecipient">contact@example.com</span>
                    </div>
                    <div class="mb-2">
                        <strong>Subject:</strong> <span id="previewSubject">Your email subject will appear here</span>
                    </div>
                    <hr>
                    <div id="previewBody" class="text-muted">
                        Your email content will appear here as you type...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="d-flex justify-content-between">
        <a href="{% url 'crm:email_template_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Cancel
        </a>

        <div class="d-flex gap-2">
            {% if form.instance.pk %}
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Update Template
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="deleteTemplate({{ form.instance.pk }}, '{{ form.instance.name }}')">
                    <i class="fas fa-trash me-2"></i>Delete
                </button>
            {% else %}
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Create Template
                </button>
            {% endif %}
        </div>
    </div>
</form>

<!-- Template Variables Help Modal -->
<div class="modal fade" id="variablesHelpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-code me-2" style="color: var(--email-primary);"></i>
                    Template Variables Guide
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Use these variables in your email templates to personalize your emails:</p>

                <div class="alert alert-info">
                    <h6 class="mb-2">Contact Variables:</h6>
                    <p class="mb-1"><code>{{ contact.first_name }}</code> - First name of the recipient</p>
                    <p class="mb-1"><code>{{ contact.last_name }}</code> - Last name of the recipient</p>
                    <p class="mb-1"><code>{{ contact.email }}</code> - Email address</p>
                    <p class="mb-0"><code>{{ contact.full_name }}</code> - Full name</p>
                </div>

                <div class="alert alert-success">
                    <h6 class="mb-2">Company Variables:</h6>
                    <p class="mb-1"><code>{{ company.name }}</code> - Company name</p>
                    <p class="mb-1"><code>{{ company.industry }}</code> - Industry sector</p>
                    <p class="mb-1"><code>{{ company.website }}</code> - Website URL</p>
                    <p class="mb-0"><code>{{ company.phone }}</code> - Company phone</p>
                </div>

                <div class="alert alert-warning">
                    <small class="text-muted">
                        Variables will be replaced with actual values when the email is sent.
                        Make sure the contact or company information is available.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
{% endblock %}

{% block extra_js_block %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize TinyMCE
    tinymce.init({
        selector: '#id_body',
        height: 500,
        menubar: false,
        plugins: [
            'lists', 'link', 'image', 'charmap', 'preview', 'anchor',
            'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'insertdatetime', 'media', 'table', 'help', 'wordcount'
        ],
        toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | ' +
                  'forecolor backcolor | alignleft aligncenter alignright alignjustify | ' +
                  'bullist numlist outdent indent | removeformat | help',
        content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px }',
        setup: function(editor) {
            editor.on('change keyup', function() {
                updatePreview();
            });
        }
    });

    // Update preview when form fields change
    ['id_subject', 'id_name'].forEach(function(id) {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updatePreview);
        }
    });

    // Initial preview update
    updatePreview();
});

function toggleVariablesPanel() {
    const panel = document.getElementById('variablesPanel');
    const button = event.target;

    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        button.innerHTML = '<i class="fas fa-code me-1"></i>Hide Variables';
    } else {
        panel.style.display = 'none';
        button.innerHTML = '<i class="fas fa-code me-1"></i>Insert Variables';
    }
}

function insertVariable(variable) {
    const editor = tinymce.activeEditor;
    if (editor && editor.getContent) {
        editor.insertContent(variable);
    }
}

function updatePreview() {
    const subjectInput = document.getElementById('id_subject');
    const subject = subjectInput ? subjectInput.value || 'Your email subject will appear here' : '';

    document.getElementById('previewSubject').textContent = subject;

    const editor = tinymce.activeEditor;
    if (editor && editor.getContent) {
        const bodyContent = editor.getContent({format: 'html'});
        if (bodyContent) {
            document.getElementById('previewBody').innerHTML = bodyContent;
        }
    }
}

function previewEmail() {
    updatePreview();

    // Scroll to preview
    const preview = document.getElementById('emailPreview');
    if (preview) {
        preview.scrollIntoView({ behavior: 'smooth' });
    }
}

function deleteTemplate(templateId, templateName) {
    if (confirm(`Are you sure you want to delete the template "${templateName}"?\n\nThis action cannot be undone.`)) {
        // Show loading state
        const deleteBtn = event.target;
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';

        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `{% url "crm:email_template_delete" 0 %}`.replace('0', templateId);

        // Add CSRF token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        form.appendChild(csrfInput);

        document.body.appendChild(form);
        form.submit();
    }
}

// Template type specific hints
function updateTemplateHints() {
    const templateType = document.getElementById('id_template_type').value;
    const subjectField = document.getElementById('id_subject');
    const bodyTextarea = document.getElementById('id_body');

    const hints = {
        'lead_nurture': {
            subject: 'Latest Updates on Solar Solutions',
            body: 'Dear [Contact Name],\n\nWe wanted to share the latest updates...\n\nRegards,\n[Your Name]'
        },
        'proposal_followup': {
            subject: 'Following Up on Our Proposal',
            body: 'Dear [Contact Name],\n\nI hope this email finds you well...\n\n[Attachment Link]\n\nBest regards,\n[Your Name]'
        },
        'welcome_email': {
            subject: 'Welcome to [Company Name] Team',
            body: 'Dear [Contact Name],\n\nWelcome to our team!\n\nWe are excited to have you as part of [Company Name]...\n\nBest regards,\n[Your Team]'
        },
        'newsletter': {
            subject: 'Monthly Newsletter - [Month Year]',
            body: 'Dear [Contact Name],\n\nHere\'s our latest newsletter...\n\n[Newsletter Content]\n\n[Unsubscribe Link]\n\nBest regards,\n[Company Name] Team'
        }
    };

    const hint = hints[templateType];
    if (hint && !subjectField.value) {
        subjectField.placeholder = hint.subject;
    }

    if (hint && !tinymce.activeEditor.getContent() && !bodyTextarea.value) {
        if (confirm('Would you like to load a template hint for this email type?')) {
            if (tinymce.activeEditor) {
                tinymce.activeEditor.setContent(hint.body.replace(/\n/g, '<br>'));
            } else {
                bodyTextarea.value = hint.body;
            }
            updatePreview();
        }
    }
}

// Add template type change listener
document.addEventListener('DOMContentLoaded', function() {
    const templateTypeSelect = document.getElementById('id_template_type');
    if (templateTypeSelect) {
        templateTypeSelect.addEventListener('change', updateTemplateHints);
    }
});
</script>
{% endblock %}
