{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Delete Campaign - {{ block.super }}{% endblock %}

{% block page_title %}Delete Campaign{% endblock %}
{% block page_subtitle %}Confirm deletion of marketing campaign: {{ campaign.name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'crm:dashboard' %}">CRM</a></li>
<li class="breadcrumb-item"><a href="{% url 'crm:campaign_list' %}">Campaigns</a></li>
<li class="breadcrumb-item"><a href="{% url 'crm:campaign_detail' campaign.pk %}">{{ campaign.name|truncatechars:30 }}</a></li>
<li class="breadcrumb-item active">Delete</li>
{% endblock %}

{% block extra_css %}
<style>
    .campaign-header {
        background: linear-gradient(135deg, #dc3545, #e74c3c);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
    }

    .campaign-status-indicator {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        font-weight: bold;
        color: white;
        margin: 0 auto 1rem;
    }

    .impact-assessment {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1rem 0;
    }

    .impact-highlight {
        background: white;
        border: 2px solid #ffc107;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .metric-display {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 1.5rem 0;
    }

    .metric-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
    }

    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .timeline-visual {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .confirmation-section {
        background: white;
        border: 2px solid #dc3545;
        border-radius: 12px;
        padding: 2rem;
        margin: 1rem 0;
    }

    .alternative-actions {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1rem 0;
    }

    .leads-affected {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
        padding: 0.75rem;
        margin: 0.5rem 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .campaign-performance {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1rem 0;
    }

    .stage-indicator {
        display: inline-block;
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin: 1rem 0;
    }

    .stage-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .running-campaign-warning {
        background: #f8d7da;
        border: 1px solid #f1aeb5;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Campaign Header - Deletion Warning -->
        <div class="campaign-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-3">
                        <i class="fas fa-trash-alt me-3"></i>{{ campaign.name }}
                    </h2>
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <span class="badge bg-danger badge-lg">
                            <i class="fas fa-exclamation-triangle me-2"></i>DELETION MODE
                        </span>
                        <span class="opacity-75">{{ campaign.get_campaign_type_display }} Campaign</span>
                    </div>
                    <div class="opacity-75">
                        <i class="fas fa-calendar me-2"></i>{{ campaign.start_date }} - {{ campaign.end_date }}
                        <i class="fas fa-money-bill-wave ms-3 me-2"></i>KES {{ campaign.budget|intcomma }}
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="campaign-status-indicator">
                        <i class="fas fa-times-circle fa-2x mb-2"></i>
                        <div style="font-size: 1.2rem;">DELETE</div>
                        <div style="font-size: 0.8rem;">CONFirmed</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Main Content -->
            <div class="col-md-8">

                <!-- Campaign Performance Overview -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-primary">
                            <i class="fas fa-chart-bar me-2"></i>Campaign Performance Overview
                        </h5>

                        <div class="metric-display">
                            <div class="metric-item">
                                <div class="metric-value">{{ campaign.actual_leads|intcomma }}</div>
                                <div class="metric-label">Leads Generated</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">{{ campaign.target_leads|intcomma }}</div>
                                <div class="metric-label">Target Leads</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">{{ campaign.lead_conversion_rate|floatformat:1 }}%</div>
                                <div class="metric-label">Conversion Rate</div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <strong>Campaign Status:</strong>
                            <span class="badge bg-{{ campaign.status|yesno:'success,warning,danger' }} ms-2">
                                {{ campaign.get_status_display }}
                            </span>
                            {% if campaign.status == 'running' %}
                                <div class="running-campaign-warning">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    <strong>Running Campaign:</strong> This campaign is currently active. Deleting it will immediately stop all campaign activities.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Leads Affected -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-warning">
                            <i class="fas fa-user-times me-2"></i>Leads That Will Be Affected
                        </h5>

                        {% if campaign.leads.exists %}
                            {% for lead in campaign.leads.all %}
                            <div class="leads-affected">
                                <div>
                                    <strong>{{ lead.company_name }}</strong>
                                    <div class="small text-muted">
                                        {{ lead.contact_name }} ‚Ä¢
                                        <span class="badge bg-secondary">{{ lead.get_status_display }}</span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">{{ lead.created_at|date:"M d" }}</small>
                        <div class="small text-success" style="display: inline;">Value: KES {{ lead.estimated_value|floatformat:0 }}</div>
                                </div>
                            </div>
                            {% endfor %}

                            <div class="mt-3 alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Total leads affected: <strong>{{ campaign.leads.count }}</strong>.
                                All these leads will retain their source information but the campaign reference will be removed.
                            </div>
                        {% else %}
                            <p class="text-muted text-center py-3">
                                <i class="fas fa-users fa-2x text-muted mb-2"></i>
                                <br>No leads generated from this campaign yet.
                            </p>
                        {% endif %}
                    </div>
                </div>

                <!-- Campaign Timeline Impact -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-info">
                            <i class="fas fa-calendar-times me-2"></i>Campaign Timeline Impact
                        </h5>

                        <div class="timeline-visual">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><strong>Campaign Duration:</strong></span>
                                <span>{{ campaign.start_date }} ‚Üí {{ campaign.end_date }}</span>
                            </div>

                            <div class="stage-indicator">
                                <div class="stage-progress-bar" style="width: {{ campaign.progress_percentage }}%;"></div>
                            </div>

                            <div class="d-flex justify-content-between mt-2">
                                <span>{{ campaign.progress_percentage|floatformat:1 }}% Complete</span>
                                {% if campaign.end_date|date:"Y-m-d" < campaign.start_date|date:"Y-m-d" %}
                                    <span class="text-danger">‚ùå Ended Early</span>
                                {% elif campaign.end_date|date:"Y-m-d" == campaign.start_date|date:"Y-m-d" %}
                                    <span class="text-warning">‚ö†Ô∏è Same Day</span>
                                {% else %}
                                    <span class="text-success">‚úÖ Completed</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="impact-assessment">
                            <h6 class="mb-2">üìä What Will Be Lost:</h6>
                            <ul class="mb-0">
                                <li><strong>Historical Performance Data:</strong> All campaign metrics and analytics will be lost</li>
                                <li><strong>Lead Source Integrity:</strong> Leads generated will become orphaned and harder to track</li>
                                <li><strong>Marketing ROI Calculations:</strong> Budget spent vs. leads generated data will be lost</li>
                                <li><strong>Social Proof:</strong> Campaign success metrics for future planning will disappear</li>
                                {% if campaign.landing_page_url %}
                                <li><strong>Landing Page Metrics:</strong> {{ campaign.landing_page_url }} conversion data will lose campaign context</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Alternative Actions -->
                <div class="alternative-actions">
                    <h6 class="mb-2">üí° Consider Alternative Actions:</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <a href="{% url 'crm:campaign_update' campaign.pk %}"
                               class="btn btn-outline-primary w-100">
                                <i class="fas fa-edit me-2"></i>Edit Campaign
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="#" onclick="pauseCampaign()" class="btn btn-outline-warning w-100">
                                <i class="fas fa-pause me-2"></i>Pause Campaign
                            </a>
                        </div>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        These options preserve campaign data while allowing you to modify or temporarily suspend the campaign.
                    </small>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-md-4">

                <!-- Deletion Confirmation -->
                <div class="confirmation-section mb-4">
                    <h5 class="card-title text-danger text-center mb-3">
                        <i class="fas fa-skull-crossbones fa-2x me-2"></i>
                        <br>FINAL CONFIRMATION
                    </h5>

                    <p class="text-center text-muted small mb-3">
                        This action cannot be undone. Deleting a campaign will permanently remove all associated data.
                    </p>

                    <div class="mb-3">
                        <label for="confirmationInput" class="form-label">Type campaign name to confirm:</label>
                        <input type="text" class="form-control form-control-lg text-center font-weight-bold"
                               id="confirmationInput" placeholder="{{ campaign.name }}"
                               autocorrect="off" autocapitalize="off">
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-danger btn-lg" id="confirmBtn" disabled>
                            <i class="fas fa-trash-alt me-2"></i>Delete Campaign
                        </button>

                        <form method="post" action="" style="display: none;" id="deleteForm">
                            {% csrf_token %}
                        </form>
                    </div>
                </div>

                <!-- Campaign Owner/Supervisor -->
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-user-tie me-2"></i>Campaign Owner
                        </h6>

                        {% if campaign.owner %}
                        <div class="d-flex align-items-center">
                            {% if campaign.owner.profile_photo %}
                                <img src="{{ campaign.owner.profile_photo.url }}" alt=""
                                     class="rounded-circle me-3" width="50" height="50">
                            {% else %}
                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3"
                                     style="width: 50px; height: 50px;">
                                    {{ campaign.owner.get_initials }}
                                </div>
                            {% endif %}
                            <div>
                                <strong>{{ campaign.owner.get_full_name }}</strong>
                                <div class="small text-muted">{{ campaign.owner.email }}</div>
                            </div>
                        </div>
                        {% endif %}

                        <hr>

                        <a href="{% url 'crm:campaign_detail' campaign.pk %}"
                           class="btn btn-outline-secondary w-100">
                            <i class="fas fa-arrow-left me-2"></i>Go Back to Campaign
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="deletionSuccessModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Campaign Deleted
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Campaign "<strong>{{ campaign.name }}</strong>" and all associated data have been permanently deleted.</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Note: {{ campaign.actual_leads|intcomma }} lead{{ campaign.actual_leads|pluralize }} from this campaign will remain in the system but will no longer be attributed to this campaign.
                </div>
            </div>
            <div class="modal-footer">
                <a href="{% url 'crm:campaign_list' %}" class="btn btn-secondary">
                    <i class="fas fa-list me-2"></i>Return to Campaigns
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmationInput = document.getElementById('confirmationInput');
    const confirmBtn = document.getElementById('confirmBtn');
    const deleteForm = document.getElementById('deleteForm');
    const expectedText = '{{ campaign.name }}';

    confirmationInput.addEventListener('input', function() {
        const isValid = this.value.trim() === expectedText;
        confirmBtn.disabled = !isValid;

        if (isValid) {
            confirmBtn.style.backgroundColor = '#dc3545';
            confirmBtn.style.borderColor = '#dc3545';
        } else {
            confirmBtn.style.backgroundColor = '';
            confirmBtn.style.borderColor = '';
        }
    });

    confirmBtn.addEventListener('click', function() {
        if (confirm('This action CANNOT be undone. Are you absolutely sure you want to delete this campaign and lose all associated data?')) {
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';
            confirmBtn.disabled = true;

            deleteForm.submit();
        }
    });

    {% if messages %}
        {% for message in messages %}
            {% if "deleted successfully" in message.message %}
                const successModal = new bootstrap.Modal(document.getElementById('deletionSuccessModal'));
                successModal.show();
            {% endif %}
        {% endfor %}
    {% endif %}
});

function pauseCampaign() {
    alert('Campaign pause functionality would be implemented here');
    // This would typically make an AJAX request to update campaign status to 'paused'
}
</script>
{% endblock %}
