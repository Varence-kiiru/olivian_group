{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Email Composer - {{ block.super }}{% endblock %}

{% block page_title %}Email Composer{% endblock %}

{% block page_subtitle %}Send professional emails to contacts, leads, and opportunities{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'crm:dashboard' %}">CRM</a></li>
<li class="breadcrumb-item active">Email Composer</li>
{% endblock %}

{% block extra_css %}
<style>
    .composer-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .composer-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .recipient-selector {
        border-bottom: 1px solid #e9ecef;
        padding: 20px;
    }

    .recipient-list {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: #f8f9fa;
    }

    .recipient-chip {
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        margin: 0.25rem;
        display: inline-flex;
        align-items: center;
        font-size: 0.85rem;
    }

    .recipient-chip .remove-btn {
        background: none;
        border: none;
        color: white;
        margin-left: 0.5rem;
        cursor: pointer;
        padding: 0;
        font-size: 1.2em;
    }

    .email-editor {
        padding: 20px;
    }

    .email-input {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 0.75rem;
        font-size: 1rem;
        transition: border-color 0.15s ease-in-out;
    }

    .email-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(56, 182, 255, 0.25);
    }

    .email-body {
        min-height: 300px;
        padding: 1rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        resize: vertical;
    }

    .action-buttons {
        padding: 20px;
        border-top: 1px solid #e9ecef;
        background: #f8f9fa;
    }

    .templates-section {
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
    }

    .template-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .template-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .template-card.selected {
        border-color: var(--primary-color);
        background: rgba(56, 182, 255, 0.1);
    }

    .email-preview {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        border: 1px solid #e9ecef;
    }

    .preview-header {
        background: var(--primary-color);
        color: white;
        padding: 15px;
        border-radius: 8px 8px 0 0;
        margin: -20px -20px 20px -20px;
    }

    .preview-content {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        background: #fafafa;
    }
</style>
{% endblock %}

{% block content %}
<div class="composer-container">
    <div class="composer-card">
        <form id="emailForm" method="post">
            {% csrf_token %}

            <!-- Recipient Selection -->
            <div class="recipient-selector">
                <div class="row">
                    <div class="col-md-6">
                        <h6>To:</h6>
                        <div class="recipient-list" id="recipientList">
                            <!-- Recipients will be added here -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="recipientSearch" class="form-label">Add Recipients:</label>
                        <select class="form-select" id="recipientSearch" multiple>
                            <option value="">Select contacts, leads, or opportunities...</option>
                        </select>
                        <small class="text-muted mt-1 d-block">
                            Type to search or select from the dropdown
                        </small>
                    </div>
                </div>
            </div>

            <div class="email-editor">
                <!-- Subject Line -->
                <div class="mb-3">
                    <label for="subject" class="form-label">Subject:</label>
                    <input type="text" class="form-control email-input" id="subject"
                           placeholder="Subject line..." required>
                </div>

                <!-- Email Body -->
                <div class="mb-3">
                    <label for="emailBody" class="form-label">Message:</label>
                    <textarea class="email-body" id="emailBody" placeholder="Compose your email..."></textarea>
                </div>

                <!-- Email Templates -->
                <div class="templates-section">
                    <h6>Email Templates: <span class="badge bg-primary">{{ email_templates|length }}</span></h6>
                    <div class="row" id="templateCards">
                        {% for template in email_templates %}
                        <div class="col-md-4 col-lg-3 mb-3">
                            <div class="template-card card p-3 {% if forloop.first %}selected{% endif %}"
                                 data-template="{{ template.template_type }}"
                                 data-template-id="{{ template.id }}"
                                 data-subject="{{ template.subject }}"
                                 data-body="{{ template.body }}">
                                <div class="card-body text-center">
                                    <i class="{{ template.icon }} fa-2x mb-2" style="color: {{ template.color }}"></i>
                                    <h6 class="card-title">{{ template.name }}</h6>
                                    <p class="card-text small text-muted">{{ template.description }}</p>
                                    <small class="text-muted">{{ template.category }}</small>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <i class="fas fa-info-circle me-2"></i>
                                No email templates available. Please create templates first.
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button type="button" class="btn btn-outline-secondary me-2" id="previewBtn">
                            <i class="fas fa-eye me-1"></i>Preview
                        </button>
                        <button type="button" class="btn btn-outline-info" id="saveDraftBtn">
                            <i class="fas fa-save me-1"></i>Save Draft
                        </button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary me-2" id="cancelBtn">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" id="sendBtn">
                            <i class="fas fa-paper-plane me-1"></i>Send Email
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Email Preview -->
    <div class="email-preview" id="emailPreview" style="display: none;">
        <div class="preview-header">
            <h5 class="mb-0"><i class="fas fa-eye me-2"></i>Email Preview</h5>
        </div>

        <div class="preview-content">
            <div class="mb-3">
                <strong>To:</strong> <span id="previewRecipients">No recipients selected</span>
            </div>
            <div class="mb-3">
                <strong>Subject:</strong> <span id="previewSubject">No subject</span>
            </div>
            <hr>
            <div id="previewBody" class="mt-3">Email content will appear here...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
    // Pass Django data to JavaScript
    window.preselectedRecipient = {% if preselected_contact %}{
        id: '{{ preselected_contact.id }}',
        name: '{{ preselected_contact.get_full_name }}',
        email: '{{ preselected_contact.email }}'
    }{% else %}null{% endif %};
    window.preselectedOpportunity = {% if preselected_opportunity %}{
        id: '{{ preselected_opportunity.id }}',
        name: '{{ preselected_opportunity.name }}'
    }{% else %}null{% endif %};
</script>

<script>
let recipients = [];

// Recipient management functions (move to global scope)
function updateRecipientDisplay() {
    const recipientList = document.getElementById('recipientList');

    if (recipients.length === 0) {
        recipientList.innerHTML = '<small class="text-muted">No recipients added yet</small>';
        return;
    }

    recipientList.innerHTML = recipients.map(recipient =>
        `<div class="recipient-chip">
            ${recipient.name} <${recipient.email}>
            <button type="button" class="remove-btn" data-recipient-id="${recipient.id}" onclick="removeRecipient('${recipient.id}')">&times;</button>
        </div>`
    ).join('');
}

function removeRecipient(recipientId) {
    recipients = recipients.filter(r => r.id !== recipientId);
    updateRecipientDisplay();
}

function addRecipient(recipientData) {
    // Check if recipient already exists
    const existing = recipients.find(r => r.id === recipientData.id);
    if (!existing) {
        recipients.push(recipientData);
        updateRecipientDisplay();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Pre-populate recipient if provided from Django
    if (window.preselectedRecipient) {
        recipients.push(window.preselectedRecipient);
        updateRecipientDisplay();
    }

    let selectedTemplate = 'welcome';

    // Initialize email templates
    const templates = {
        welcome: {
            subject: 'Welcome to The Olivian Group - Your Solar Solutions Partner',
            body: `Dear [NAME],

Thank you for your interest in The Olivian Group! We're excited to help you discover the benefits of solar energy.

Our team of certified solar experts is ready to assist you with:
• Solar system design and installation
• Energy audits and savings calculations
• Financing and Tax credit information
• Permit and inspection coordination

Would you like to schedule a free consultation to discuss your solar needs?

Best regards,
The Olivian Group Team`
        },
        follow_up: {
            subject: 'Following up on your solar inquiry',
            body: `Hello [NAME],

I hope this email finds you well. I wanted to follow up on our recent conversation about solar energy solutions for your home/business.

Since our last contact, we've helped several customers in your area achieve significant energy savings with our premium solar systems.

I'd love to discuss how we can tailor a solution specifically for your needs. When would be a convenient time for a quick call?

Best regards,
The Olivian Group Team`
        },
        proposal: {
            subject: 'Custom Solar Energy Proposal & Installation Quote',
            body: `Dear [NAME],

Thank you for considering The Olivian Group for your solar energy needs.

Based on our discussion, I've prepared a custom solar energy proposal specifically designed for your energy requirements and property.

The proposal includes:
• System design and specifications
• Energy production estimates
• Installation timeline
• Pricing and financing options
• Available incentives and tax credits
• Warranty and maintenance information

Please find the detailed proposal attached to this email. I'd be happy to go over it with you and answer any questions you may have.

Best regards,
The Olivian Group Team`
        }
    };

    // Template selection
    document.querySelectorAll('.template-card').forEach(card => {
        card.addEventListener('click', function() {
            // Remove previous selection
            document.querySelectorAll('.template-card').forEach(c =>
                c.classList.remove('selected'));

            // Select current template
            this.classList.add('selected');
            selectedTemplate = this.dataset.template;

            // Populate form from data attributes
            const subject = this.dataset.subject || '';
            const body = this.dataset.body || '';

            document.getElementById('subject').value = subject;

            // Process the body content for display - ALWAYS convert to readable text
            let displayBody = body;

            // Always replace Django template variables with placeholders for readability
            displayBody = displayBody.replace(/\{\{contact_first_name\}\}/g, '[Contact First Name]');
            displayBody = displayBody.replace(/\{\{contact_name\}\}/g, '[Contact Full Name]');
            displayBody = displayBody.replace(/\{\{lead_title\}\}/g, '[Lead Title]');
            displayBody = displayBody.replace(/\{\{estimated_value\}\}/g, '[Estimated Value]');
            displayBody = displayBody.replace(/\{\{status\}\}/g, '[Status]');
            displayBody = displayBody.replace(/\{\{assigned_to\}\}/g, '[Assigned User]');
            displayBody = displayBody.replace(/\{\{company_name\}\}/g, '[Company Name]');
            displayBody = displayBody.replace(/\{\{next_follow_up\}\}/g, '[Next Follow-up Date]');
            displayBody = displayBody.replace(/\{\{expected_close_date\}\}/g, '[Expected Close Date]');
            displayBody = displayBody.replace(/\{\{days_since_created\}\}/g, '[Days Since Created]');
            displayBody = displayBody.replace(/\{\{priority\}\}/g, '[Priority]');
            displayBody = displayBody.replace(/\{\{source\}\}/g, '[Lead Source]');
            displayBody = displayBody.replace(/\{\{recipient_name\}\}/g, '[Recipient Name]');
            displayBody = displayBody.replace(/\{\{contact\}\}/g, '[Contact Name]');

            // Handle Django conditional blocks
            displayBody = displayBody.replace(/\{\%.*?\%/g, '[CONDITIONAL BLOCK]');

            // Convert HTML tags to readable text format
            displayBody = displayBody.replace(/<br\s*\/?>/gi, '\n');
            displayBody = displayBody.replace(/\}\s*<p\s*>/gi, '\n\n');
            displayBody = displayBody.replace(/<\/p\s*>/gi, '\n\n');
            displayBody = displayBody.replace(/<\/div\s*>/gi, '\n');
            displayBody = displayBody.replace(/<\/h[1-6]\s*>/gi, '\n\n');
            displayBody = displayBody.replace(/<\/li\s*>/gi, '\n');
            displayBody = displayBody.replace(/<li\s*>/gi, '• ');
            displayBody = displayBody.replace(/<strong\s*>/gi, '');
            displayBody = displayBody.replace(/<\/strong\s*>/gi, '');
            displayBody = displayBody.replace(/<b\s*>/gi, '');
            displayBody = displayBody.replace(/<\/b\s*>/gi, '');
            displayBody = displayBody.replace(/<em\s*>/gi, '');
            displayBody = displayBody.replace(/<\/em\s*>/gi, '');
            displayBody = displayBody.replace(/<i\s*>/gi, '');
            displayBody = displayBody.replace(/<\/i\s*>/gi, '');

            // Strip ALL remaining HTML tags
            displayBody = displayBody.replace(/<[^>]*>/g, '');

            // Clean up entities and formatting
            displayBody = displayBody.replace(/&nbsp;/gi, ' ');
            displayBody = displayBody.replace(/&/gi, '&');
            displayBody = displayBody.replace(/&\w+;/g, '');
            displayBody = displayBody.replace(/\s+/g, ' ').trim();

            document.getElementById('emailBody').value = displayBody;

            // Update preview after template selection
            updatePreview();
        });
    });

    // Preview button
    document.getElementById('previewBtn').addEventListener('click', function() {
        updatePreview();
        document.getElementById('emailPreview').style.display = 'block';
        document.getElementById('emailPreview').scrollIntoView({behavior: 'smooth'});
    });

    // Send button
    document.getElementById('sendBtn').addEventListener('click', function(e) {
        e.preventDefault();

        const subject = document.getElementById('subject').value.trim();
        const body = document.getElementById('emailBody').value.trim();

        // Validate form
        if (!subject) {
            alert('Please enter a subject.');
            document.getElementById('subject').focus();
            return;
        }

        if (!body) {
            alert('Please enter the email message.');
            document.getElementById('emailBody').focus();
            return;
        }

        if (recipients.length === 0) {
            alert('Please add at least one recipient.');
            return;
        }

        // Disable button and show loading state
        const button = document.getElementById('sendBtn');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
        button.disabled = true;

        // Prepare form data
        const formData = new FormData();
        formData.append('subject', subject);
        formData.append('body', body);

        // Add recipients
        recipients.forEach(recipient => {
            formData.append('recipients', recipient.email);
        });

        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            formData.append('csrfmiddlewaretoken', csrfToken.value);
        }

        // Send AJAX request
        fetch('/crm/email-composer/', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': csrfToken ? csrfToken.value : ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                alert(data.message || 'Email sent successfully!');

                // Clear form
                document.getElementById('subject').value = '';
                document.getElementById('emailBody').value = '';

                // Go back to CRM dashboard
                window.location.href = '/crm/';
            } else {
                alert(data.error || 'Failed to send email. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while sending the email. Please try again.');
        })
        .finally(() => {
            // Re-enable button
            button.innerHTML = originalText;
            button.disabled = false;
        });
    });

    // Cancel button
    document.getElementById('cancelBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
            window.location.href = "{% url 'crm:dashboard' %}";
        }
    });

    function updatePreview() {
        const subject = document.getElementById('subject').value;
        const body = document.getElementById('emailBody').value;
        const recipientNames = recipients.map(r => r.name).join(', ');

        document.getElementById('previewRecipients').textContent = recipientNames || 'No recipients selected';
        document.getElementById('previewSubject').textContent = subject || 'No subject';

        // Create a readable preview from the template
        const previewBody = document.getElementById('previewBody');
        let previewText = body;

        // Replace template variables with sample/placeholder data for preview
        previewText = previewText.replace(/\{\{contact_first_name\}\}/g, 'John');
        previewText = previewText.replace(/\{\{contact_name\}\}/g, 'John Doe');
        previewText = previewText.replace(/\{\{lead_title\}\}/g, 'Solar Installation Project');
        previewText = previewText.replace(/\{\{estimated_value\}\}/g, 'KES 500,000');
        previewText = previewText.replace(/\{\{status\}\}/g, 'Qualified');
        previewText = previewText.replace(/\{\{days_since_created\}\}/g, '5');
        previewText = previewText.replace(/\{\{assigned_to\}\}/g, 'Sales Team');
        previewText = previewText.replace(/\{\{priority\}\}/g, 'High');
        previewText = previewText.replace(/\{\{source\}\}/g, 'Website');
        previewText = previewText.replace(/\{\{company_name\}\}/g, 'ABC Corporation');
        previewText = previewText.replace(/\{\{next_follow_up\}\}/g, new Date(Date.now() + 7*24*60*60*1000).toLocaleDateString());
        previewText = previewText.replace(/\{\{expected_close_date\}\}/g, new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString());

        // Handle conditional blocks for preview
        previewText = previewText.replace(/\{\% if.*?(?:\%\}|$)/g, '');
        previewText = previewText.replace(/\{\% endif \%/g, '');

        // Strip HTML tags and clean up the content
        if (previewText.includes('<') && previewText.includes('>')) {
            // HTML content - convert to readable text
            previewText = previewText.replace(/<br\s*\/?>/gi, '\n');
            previewText = previewText.replace(/<\/p>/gi, '\n\n');
            previewText = previewText.replace(/<\/div>/gi, '\n');
            previewText = previewText.replace(/<\/h[1-6]>/gi, '\n\n');
            previewText = previewText.replace(/<[^>]*>/g, '');
            previewText = previewText.replace(/&nbsp;/gi, ' ');
            previewText = previewText.replace(/\s+/g, ' ').trim();
        }

        // Truncate if too long for preview
        if (previewText.length > 500) {
            previewText = previewText.substring(0, 500) + '...\n\n(Email content continues...)';
        }

        previewBody.textContent = previewText || 'No content';
    }

    // Functions are now defined in global scope above

    // Initialize recipient search functionality
    function initializeRecipientSearch() {
        // Pre-populate recipients from URL parameters is handled above

        // Set up recipient search dropdown
        const recipientSearch = document.getElementById('recipientSearch');

        // Add sample recipients for selection
        const sampleOptions = [
            { value: '1', text: 'John Doe (john@example.com)' },
            { value: '2', text: 'Jane Smith (jane@example.com)' },
            { value: '3', text: 'Acme Corp (info@acme.com)' }
        ];

        sampleOptions.forEach(option => {
            const optionEl = document.createElement('option');
            optionEl.value = option.value;
            optionEl.textContent = option.text;
            recipientSearch.appendChild(optionEl);
        });

        // Handle recipient selection
        recipientSearch.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const [namePart, emailPart] = selectedOption.text.split(' (');
                addRecipient({
                    id: selectedOption.value,
                    name: namePart,
                    email: emailPart.slice(0, -1) // Remove closing parenthesis
                });
                // Reset selection
                this.value = '';
            }
        });

        // Update display
        updateRecipientDisplay();
    }

    // Initialize the recipeint search
    initializeRecipientSearch();

    // Initialize with selected template
    document.querySelector('.template-card.selected').click();
});
</script>
{% endblock %}
